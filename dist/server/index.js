var snakey3=function(e){var t={},s={0:0};function r(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.e=function(t){if(0!==s[t]){var r=require("./chunk/"+({1:"lang/Cellphone-ts",2:"lang/Emote-ts",3:"lang/English-ts",4:"lang/Japanese-ts",5:"lang/Korean-ts",6:"lang/Morse-ts"}[t]||t)+".js"),i=r.modules,a=r.ids;for(var n in i)e[n]=i[n];for(var o=0;o<a.length;o++)s[a[o]]=0}return Promise.all([])},r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(s,i,function(t){return e[t]}.bind(null,i));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="dist/server/",r.oe=function(e){process.nextTick((function(){throw e}))},r(r.s=13)}([function(e,t){e.exports=require("tslib")},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return n}));Object.freeze({behavior:"smooth",block:"center",inline:"center"});function r(e,t){t.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(s=>{Object.defineProperty(e.prototype,s,Object.getOwnPropertyDescriptor(t.prototype,s))})})}function i(e){for(const t of Object.getOwnPropertyNames(e)){const s=e[t];"object"==typeof s&&i(s)}return Object.freeze(e)}class a{}!function(e){let t,s,r;e.Family=Object.freeze({HUMAN:"HUMAN",CHASER:"CHASER"}),e.Family,function(e){e.NULL=void 0}(t=e.Id||(e.Id={})),function(e){e.REGEXP=/[ a-zA-Z0-9:-]+/,e.MAX_LENGTH=15}(s=e.Username||(e.Username={})),function(e){e.LOREM_IPSUM="lorem-ipsum"}(r=e.Avatar||(e.Avatar={})),function(e){const t=Object.values(e).filter(e=>"string"==typeof e);e.GET_RANDOM=function(){return t[Math.random()*t.length]}}(r=e.Avatar||(e.Avatar={})),e.MoveType=Object.freeze({NORMAL:"NORMAL",BOOST:"BOOST"}),e.MoveType}(a||(a={})),Object.freeze(a),Object.freeze(a.prototype);class n{}!function(e){let t,s,r;!function(e){e.REGEXP=new RegExp("^[a-zA-Z0-9!@#$%^&*()-_=+;:'\"\\|,.<>/?]+$")}(t=e.Seq||(e.Seq={})),function(e){e.NULL=Object.freeze({char:"",seq:""})}(s=e.CharSeqPair||(e.CharSeqPair={})),function(e){e.MAX=4}(r=e.WeightExaggeration||(e.WeightExaggeration={})),e.CHAR_HIT_COUNT_SEED_CEILING=5,e._RemapTemplates=Object.freeze({IDENTITY:e=>e,TO_LOWER:e=>e.toLowerCase()}),e._RemapTemplates,e.FrontendDescs=Object.freeze([{id:"engl-low",module:"English",export:"Lowercase",numLeaves:26,remapFunc:e._RemapTemplates.TO_LOWER,displayName:"English Lowercase (qwerty)",blurb:""},{id:"engl-mix",module:"English",export:"MixedCase",numLeaves:52,remapFunc:e._RemapTemplates.IDENTITY,displayName:"English Mixed-Case (Querty)",blurb:""},{id:"japn-hir",module:"Japanese",export:"Hiragana",numLeaves:71,remapFunc:e._RemapTemplates.TO_LOWER,displayName:"Japanese Hiragana",blurb:""},{id:"japn-kat",module:"Japanese",export:"Katakana",numLeaves:70,remapFunc:e._RemapTemplates.TO_LOWER,displayName:"Japanese Katakana",blurb:""},{id:"kore-dub",module:"Korean",export:"Dubeolsik",numLeaves:9177,remapFunc:e._RemapTemplates.IDENTITY,displayName:"Korean Dubeolsik (두벌식 키보드)",blurb:"The most common keyboard layout, and South Korea's only Hangul standard since 1969. Consonants are on the left, and vowels on the right."},{id:"kore-sub",module:"Korean",export:"Sebeolsik",numLeaves:10206,remapFunc:e._RemapTemplates.IDENTITY,displayName:"Korean Sebeolsik (세벌식 최종 키보드)",blurb:"Another Hangul keyboard layout used in South Korea, and the final Sebeolsik layout designed by Dr. Kong Byung Woo, hence the name. Syllable-initial consonants are on the right, final consonants on the left, and vowels in the middle. It is more ergonomic than the dubeolsik, but not widely used."},{id:"kore-rom",module:"Korean",export:"Romanization",numLeaves:3990,remapFunc:e._RemapTemplates.TO_LOWER,displayName:"Korean Revised Romanization",blurb:"The Revised Romanization of Korean (국어의 로마자 표기법; 國語의 로마字 表記法) is the official South Korean language romanization system. It was developed by the National Academy of the Korean Language from 1995, and was released on 7 July 2000 by South Korea's Ministry of Culture and Tourism"},{id:"engl-cell-enc",module:"English",export:"OldCellphone.Encode",numLeaves:8,remapFunc:e._RemapTemplates.IDENTITY,displayName:"Old Cellphone Keyboard",blurb:""}].map(e=>Object.freeze(e))),e.FrontendDescs,e.GET_FRONTEND_DESC_BY_ID=function(t){return e.FrontendDescs.find(e=>e.id===t)}}(n||(n={})),Object.freeze(n),Object.freeze(n.prototype)},function(e,t,s){"use strict";s.r(t),s.d(t,"PlayerSkeleton",(function(){return h})),s.d(t,"PlayerStatus",(function(){return d})),s.d(t,"Team",(function(){return u})),s.d(t,"Player",(function(){return p}));var r,i,a,n=s(7),o=s(0),c=s(1),l=s(8);class h extends c.b{constructor(e,t){if(super(),r.set(this,void 0),Math.trunc(t.playerId)!==t.playerId)throw RangeError("Player ID's must be integer values.");this.playerId=t.playerId,this.isALocalOperator=t.isALocalOperator,this.game=e,this.status=new this.game._playerStatusCtor(this,t.noCheckGameOver),this.tile=new l.a(new h.TileGetterSource(this))}_afterAllPlayersConstruction(){this.status._afterAllPlayersConstruction()}reset(e){Object(o.__classPrivateFieldSet)(this,r,e),this.hostTile._setOccupant(this.playerId,this.status.immigrantInfo)}get coord(){return this.hostTile.coord}get hostTile(){return Object(o.__classPrivateFieldGet)(this,r)}moveTo(e){if(this.hostTile.occupantId!==this.playerId){if("ONLINE"!==this.game.gameType)throw Error("Linkage between player and occupied tile disagrees.")}else this.hostTile.evictOccupant();if(e.isOccupied){if("ONLINE"!==this.game.gameType)throw Error("Only one player can occupy a tile at a time.")}else Object(o.__classPrivateFieldSet)(this,r,e),e._setOccupant(this.playerId,this.status.immigrantInfo)}}r=new WeakMap,function(e){var t,s;class r{constructor(e){t.set(this,void 0),s.set(this,void 0),Object(o.__classPrivateFieldSet)(this,t,e),Object(o.__classPrivateFieldSet)(this,s,e.game.grid.tile._source)}_getTileAt(){return Object(o.__classPrivateFieldGet)(this,s)._getTileAt(Object(o.__classPrivateFieldGet)(this,t).coord)}_getTileDestsFrom(){return Object(o.__classPrivateFieldGet)(this,s)._getTileDestsFrom(Object(o.__classPrivateFieldGet)(this,t).coord)}_getTileSourcesTo(){return Object(o.__classPrivateFieldGet)(this,s)._getTileSourcesTo(Object(o.__classPrivateFieldGet)(this,t).coord)}}t=new WeakMap,s=new WeakMap,e.TileGetterSource=r,Object.freeze(r),Object.freeze(r.prototype)}(h||(h={})),Object.freeze(h),Object.freeze(h.prototype);class u{constructor(e,t){if(i.set(this,void 0),0===t.length)throw Error("Teams must have at least one member.");this.id=e,this.members=t,Object(o.__classPrivateFieldSet)(this,i,this.members.every(e=>e.status.noCheckGameOver)?u.ElimOrder.IMMORTAL:u.ElimOrder.STANDING)}reset(){this.elimOrder!==u.ElimOrder.IMMORTAL&&(this.elimOrder=u.ElimOrder.STANDING)}get elimOrder(){return Object(o.__classPrivateFieldGet)(this,i)}set elimOrder(e){if(this.elimOrder===u.ElimOrder.IMMORTAL)throw Error("Cannot change the elimination status of an immortal team.");Object(o.__classPrivateFieldSet)(this,i,e)}}i=new WeakMap,function(e){let t;!function(e){e.IMMORTAL=-1,e.STANDING=0}(t=e.ElimOrder||(e.ElimOrder={}))}(u||(u={})),Object.freeze(u),Object.freeze(u.prototype);class d{constructor(e,t){a.set(this,void 0),this.player=e,this.noCheckGameOver=t}reset(){this.health=0}_afterAllPlayersConstruction(){}get immigrantInfo(){}get health(){return Object(o.__classPrivateFieldGet)(this,a)}set health(e){const t=this.isDowned;if(Object(o.__classPrivateFieldSet)(this,a,e),t||!this.isDowned||this.noCheckGameOver)return;const s=this.player.team,r=this.player.game.teams;if(s.elimOrder===u.ElimOrder.STANDING&&s.members.every(e=>e.status.noCheckGameOver||e.status.isDowned)){const e=1+r.filter(e=>e.elimOrder!==u.ElimOrder.STANDING).length;s.elimOrder=1+r.filter(e=>e.elimOrder!==u.ElimOrder.STANDING&&e.elimOrder!==u.ElimOrder.IMMORTAL).length,e===r.length&&this.player.game.statusBecomeOver()}}get isDowned(){return this.health<0}}a=new WeakMap,Object.freeze(d),Object.freeze(d.prototype);class p extends h{constructor(e,t){var s;super(e,t),this.familyId=t.familyId,this.teamId=t.teamId,this.username=t.username,this.avatar=null!==(s=t.avatar)&&void 0!==s?s:p.Avatar.GET_RANDOM()}reset(e){super.reset(e),this.status.reset(),this.lastAcceptedRequestId=n.PlayerActionEvent.INITIAL_REQUEST_ID,this.requestInFlight=!1}_notifyGameNowPlaying(){}_notifyGameNowPaused(){}_notifyGameNowOver(){}makeMovementRequest(e,t){if("PLAYING"!==this.game.status)throw Error("This is not a necessary precondition, but we're doing it anyway.");if(this.requestInFlight)throw Error("Only one request should ever be in flight at a time.");this.requestInFlight=!0,this.game.processMoveRequest(new n.PlayerActionEvent.Movement(this.playerId,this.lastAcceptedRequestId,e,t))}get team(){return this.game.teams[this.teamId]}isTeamedWith(e){return this.team.members.includes(e)}}!function(e){let t;!function(e){e.finalize=function(e){const t=Array.from(new Set(e.map(e=>e.teamId))).sort((e,t)=>e-t).reduce((e,t,s)=>(e[t]=s,e),[]);return e.slice().sort((e,s)=>t[e.teamId]-t[s.teamId]).map((e,s)=>Object.assign({},e,{playerId:s,teamId:t[e.teamId]}))}}(t=e.CtorArgs||(e.CtorArgs={})),Object.freeze(t)}(p||(p={})),Object.freeze(p),Object.freeze(p.prototype)},function(e,t,s){"use strict";var r;s.r(t),s.d(t,"Game",(function(){return r})),function(e){let t,s,r,i;!function(e){e.SERVER="SERVER",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE"}(t=e.Type||(e.Type={})),function(e){let t;!function(e){e.NAME="game-create",e.RETURN_TO_LOBBY_INDICATOR="return-to-lobby"}(t=e.Event||(e.Event={})),e.EVENT_NAME_CLIENT_READY_RESET="client-ready-for-reset",e.EVENT_NAME_CLIENT_READY_UNPAUSE="client-ready-for-unpause",e.EVENT_NAME_SERVER_APPROVE_UNPAUSE="server-approve-unpause",e.EVENT_NAME_SERVER_APPROVE_PAUSE="server-approve-pause"}(s=e.CtorArgs||(e.CtorArgs={})),function(e){e.EVENT_NAME="game-reset"}(r=e.Serialization||(e.Serialization={})),function(e){e.PLAYING="PLAYING",e.PAUSED="PAUSED",e.OVER="OVER"}(i=e.Status||(e.Status={})),e.K=Object.freeze({HEALTH_UPDATE_CHANCE:.1,PCT_MOVES_THAT_ARE_BOOST:.05,HEALTH_EFFECT_FOR_DOWNED_PLAYER:.6,EVENT_RECORD_WRAPPING_BUFFER_LENGTH:128,EVENT_RECORD_FORWARD_WINDOW_LENGTH:64})}(r||(r={})),Object.freeze(r)},function(e,t,s){"use strict";s.r(t),s.d(t,"Grid",(function(){return i}));var r=s(8);class i{constructor(e){this.static=e.gridClass,this.dimensions=e.dimensions,this.tile=new r.a(this)}get area(){return this.static.getArea(this.dimensions)}reset(){this.forEachTile(e=>e.reset())}getRandomCoord(){return this.static.getRandomCoord(this.dimensions)}}!function(e){e.getImplementation=t=>e._Constructors[t]}(i||(i={}))},function(e,t,s){"use strict";var r;s.r(t),s.d(t,"EventRecordEntry",(function(){return r})),function(e){e.EVENT_ID_REJECT=-1}(r||(r={})),Object.freeze(r)},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var r=s(2);s.d(t,"b",(function(){return r.Player}));class i extends r.Player{constructor(e,t){if(super(e,t),"ONLINE"===e.gameType)throw TypeError("OnlineGames should be using regular Players instead.")}_notifyGameNowPlaying(){this.delayedMovementContinue()}_notifyGameNowPaused(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}_notifyGameNowOver(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}movementContinue(){const e=this.computeDesiredDest();this._nextMovementTimerMultiplier=this.game.grid.tile.at(e).langSeq.length,this.makeMovementRequest(this.game.grid.getUntToward(e,this.coord),this.getNextMoveType()),this.delayedMovementContinue()}delayedMovementContinue(){this._scheduledMovementCallbackId=this.game.setTimeout(this.movementContinue.bind(this),this.computeNextMovementTimer()*this._nextMovementTimerMultiplier)}}!function(e){e.of=(t,s)=>{const r=s.familyId;return new e._Constructors[r](t,s)}}(i||(i={}))},function(e,t,s){"use strict";s.r(t),s.d(t,"PlayerActionEvent",(function(){return r}));var r,i=s(5);!function(e){e.INITIAL_REQUEST_ID=-1,e.EVENT_NAME=Object.freeze({Bubble:"player-bubble",Movement:"player-movement"});class t{constructor(e,t){this.eventId=i.EventRecordEntry.EVENT_ID_REJECT,this.affectedNeighbours=void 0,this.playerId=e,this.playerLastAcceptedRequestId=t}}e.Bubble=t;e.Movement=class extends t{constructor(e,t,s,r){super(e,t),this.newPlayerHealth=void 0,this.tileHealthModDescs=void 0,this.destModDesc={coord:s.coord,lastKnownUpdateId:s.lastKnownUpdateId,newCharSeqPair:void 0,newFreeHealth:void 0},this.moveType=r}}}(r||(r={})),Object.freeze(r)},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var r,i=s(0);class a{constructor(e){r.set(this,void 0),Object(i.__classPrivateFieldSet)(this,r,e),Object.freeze(this)}get _source(){return Object(i.__classPrivateFieldGet)(this,r)}at(...e){return Object(i.__classPrivateFieldGet)(this,r)._getTileAt(...e)}destsFrom(...e){return new n(Object(i.__classPrivateFieldGet)(this,r)._getTileDestsFrom(...e))}sourcesTo(...e){return new n(Object(i.__classPrivateFieldGet)(this,r)._getTileSourcesTo(...e))}}r=new WeakMap,Object.freeze(a),Object.freeze(a.prototype);class n{constructor(e){this.contents=e}get occupied(){return this.contents=this.contents.filter(e=>e.isOccupied),this}get unoccupied(){return this.contents=this.contents.filter(e=>!e.isOccupied),this}get get(){return this.contents}}Object.freeze(n),Object.freeze(n.prototype)},function(e,t,s){"use strict";s.r(t),s.d(t,"Coord",(function(){return r})),s.d(t,"Tile",(function(){return h}));var r,i,a,n,o,c=s(0),l=s(1);!function(e){let t;!function(e){e.EUCLID2="EUCLID2",e.BEEHIVE="BEEHIVE"}(t=e.System||(e.System={})),e.equals=function(e,t){return e._equals(t)}}(r||(r={})),Object.freeze(r);class h{constructor(e){i.set(this,void 0),a.set(this,void 0),n.set(this,void 0),o.set(this,void 0),this.coord=e,Object(c.__classPrivateFieldSet)(this,i,l.b.Id.NULL)}reset(){this.evictOccupant(),this.lastKnownUpdateId=0,this.freeHealth=0,this.setLangCharSeqPair(l.a.CharSeqPair.NULL)}_setOccupant(e,t){Object(c.__classPrivateFieldSet)(this,i,e)}get isOccupied(){return this.occupantId!==l.b.Id.NULL}evictOccupant(){Object(c.__classPrivateFieldSet)(this,i,l.b.Id.NULL)}get occupantId(){return Object(c.__classPrivateFieldGet)(this,i)}get freeHealth(){return Object(c.__classPrivateFieldGet)(this,a)}set freeHealth(e){Object(c.__classPrivateFieldSet)(this,a,e)}setLangCharSeqPair(e){Object(c.__classPrivateFieldSet)(this,n,e.char),Object(c.__classPrivateFieldSet)(this,o,e.seq)}get langChar(){return Object(c.__classPrivateFieldGet)(this,n)}get langSeq(){return Object(c.__classPrivateFieldGet)(this,o)}}i=new WeakMap,a=new WeakMap,n=new WeakMap,o=new WeakMap,Object.freeze(h),Object.freeze(h.prototype)},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var r,i=s(1),a=s(0);!function(e){var t,s;class r{constructor(){this.children=[]}reset(){this.inheritingWeightedHitCount=0,this.children.forEach(e=>e.reset())}_finalize(){Object.freeze(this.children),this.children.forEach(e=>e._finalize())}_addCharMapping(e,t){if(!i.a.Seq.REGEXP.test(e))throw RangeError(`Mapping-sequence "${e}" did not match the required regular expression "${i.a.Seq.REGEXP.source}".`);if(0===t.length)throw"never";let s=this;{let t=this;for(;t;)s=t,t=t.children.find(t=>e.startsWith(t.sequence))}if(s.sequence===e)throw Error(`Mappings for all written-characters with a commoncorresponding typeable-sequence should be registered together,but an existing mapping for the sequence "${e}" was found.`);s.children.push(new o(s,e,t))}getLeafNodes(){const e=[];return this._recursiveGetLeafNodes(e),e}_recursiveGetLeafNodes(e){this.children.length?this.children.forEach(t=>{t._recursiveGetLeafNodes(e)}):e.push(this)}simpleView(){return this.children}static CREATE_TREE_MAP(e,t){const s=Object.values(e).reduce((e,t)=>e+t.weight,0),i=0===t?e=>1:1===t?e=>e:e=>Math.pow(e/s,t),a=new Map;for(const t in e){const s=e[t].seq,r=new n(t,i(e[t].weight)),o=a.get(s);o?o.push(r):a.set(s,[r])}const o=new r;return Array.from(a).sort((e,t)=>e[0].length-t[0].length).forEach(e=>{o._addCharMapping(...e)}),o._finalize(),o}}r.LEAF_CMP=(e,t)=>e.inheritingWeightedHitCount-t.inheritingWeightedHitCount,e.ParentNode=r,Object.freeze(r),Object.freeze(r.prototype);class o extends r{constructor(e,r,i){super(),t.set(this,void 0),s.set(this,void 0),this.sequence=r,Object(a.__classPrivateFieldSet)(this,s,i),Object(a.__classPrivateFieldSet)(this,t,e)}_finalize(){Object.freeze(Object(a.__classPrivateFieldGet)(this,s)),super._finalize()}reset(){super.reset(),Object(a.__classPrivateFieldGet)(this,s).forEach(e=>{e.reset(),this.incrementNumHits(e,Math.random()*i.a.CHAR_HIT_COUNT_SEED_CEILING)})}chooseOnePair(){const e=Object(a.__classPrivateFieldGet)(this,s).slice(0).sort(n.CMP).shift(),t={char:e.char,seq:this.sequence};return this.incrementNumHits(e),t}incrementNumHits(e,t=1){e._incrementNumHits(),this._recursiveIncrementNumHits(e.weightInv*t)}_recursiveIncrementNumHits(e){this.inheritingWeightedHitCount+=e,this.children.forEach(t=>t._recursiveIncrementNumHits(e))}get personalWeightedHitCount(){return this.inheritingWeightedHitCount-Object(a.__classPrivateFieldGet)(this,t).inheritingWeightedHitCount}andNonRootParents(){const e=[];for(let s=this;s instanceof o;s=Object(a.__classPrivateFieldGet)(s,t))e.push(s);return e}simpleView(){let e=Object(a.__classPrivateFieldGet)(this,s).map(e=>e.simpleView());return Object.assign(Object.create(null),{seq:this.sequence,chars:1===e.length?e[0]:e,kids:this.children.map(e=>e.simpleView())})}}t=new WeakMap,s=new WeakMap,o.PATH_CMP=(e,t)=>e.personalWeightedHitCount-t.personalWeightedHitCount,e.ChildNode=o,Object.freeze(o),Object.freeze(o.prototype)}(r||(r={})),Object.freeze(r);class n{constructor(e,t){if(t<=0)throw RangeError(`All weights must be positive, but we were passed the value "${t}" for the character "${e}".`);this.char=e,this.weightInv=1/t}reset(){this.hitCount=0,this.weightedHitCount=0}_incrementNumHits(){this.hitCount+=1,this.weightedHitCount+=this.weightInv}simpleView(){return Object.assign(Object.create(null),{char:this.char,hits:this.hitCount})}}n.CMP=(e,t)=>e.weightedHitCount-t.weightedHitCount,Object.freeze(n),Object.freeze(n.prototype);class o extends i.a{constructor(e,t,s){if(super(),this.frontendDesc=o.GET_FRONTEND_DESC_BY_ID(e),this.treeMap=r.ParentNode.CREATE_TREE_MAP(t,s),this.leafNodes=this.treeMap.getLeafNodes(),this.leafNodes.length!==this.frontendDesc.numLeaves)throw Error(`maintenance required: the frontend constant for the language "${this.frontendDesc.id}" needs to be updated to the correct, computed value, which is \`${this.leafNodes.length}\`.`)}get numLeaves(){return this.leafNodes.length}reset(){this.treeMap.reset()}getNonConflictingChar(e){this.leafNodes.sort(r.ParentNode.LEAF_CMP);let t=void 0;for(const s of this.leafNodes){const r=s.andNonRootParents();for(let t=0;t<r.length;t++){const s=e.find(e=>e.startsWith(r[t].sequence));if(s){s===r[t].sequence?r.length=0:r.splice(t);break}}if(r.length){t=r[0];for(const e of r)e.personalWeightedHitCount<t.personalWeightedHitCount&&(t=e);break}}if(!t)throw Error("Invariants guaranteeing that a LangSeq canalways be shuffled-in were not met.");return t.chooseOnePair()}simpleView(){return Object.assign(Object.create(null),{id:this.frontendDesc.id,displayName:this.frontendDesc.displayName,root:this.treeMap.simpleView(),numLeaves:this.leafNodes.length})}}o||(o={}),Object.freeze(o),Object.freeze(o.prototype)},function(e,t,s){"use strict";s.r(t),s.d(t,"SkServer",(function(){return r})),s.d(t,"Group",(function(){return i}));class r{}!function(e){let t;e.PROTOCOL="http://",e.DEFAULT_PORT=8080,function(e){e.GROUP_LOBBY_PREFIX="/group-",e.GROUP_JOINER="/joiner"}(t=e.Nsps||(e.Nsps={}))}(r||(r={})),Object.freeze(r),Object.freeze(r.prototype);class i{}!function(e){let t,s,r,i;!function(e){let t;!function(e){e.EVENT_NAME="group-lobby-user-info-change"}(t=e.UserInfoChange||(e.UserInfoChange={}))}(t=e.Socket||(e.Socket={})),function(e){e.REGEXP=/(?:[a-zA-Z0-9:-]+)/,e.MaxLength=30}(s=e.Name||(e.Name={})),function(e){e.REGEXP=/(?:[a-zA-Z0-9:-]+)/,e.MaxLength=30}(r=e.Passphrase||(e.Passphrase={})),e.JoinerReconnectionAttempts=2,e.DEFAULT_TTL=20,function(e){e.EVENT_NAME="group-exist";class t{constructor(e,t){this.groupName=e,this.passphrase=t}}let s;e.RequestCreate=t,function(e){let t;!function(e){e.OKAY="okay",e.NOPE="nope"}(t=e.Response||(e.Response={}))}(t=e.RequestCreate||(e.RequestCreate={})),function(e){e.IN_LOBBY="in-lobby",e.IN_GAME="in-game",e.DELETE="delete"}(s=e.Status||(e.Status={}))}(i=e.Exist||(e.Exist={}))}(i||(i={})),Object.freeze(i),Object.freeze(i.prototype)},function(e,t,s){"use strict";s.r(t),s.d(t,"GamepartManager",(function(){return v}));var r=s(0),i=s(10),a=s(3),n=s(9),o=s(2),c=s(6),l=s(1);class h{constructor(e){const t=[];for(const s of e)t[s]=new h.Entry;this.entries=t}reset(){for(const e of this.entries)e.reset()}}!function(e){class t{constructor(){this.moveCounts={}}reset(){this.totalHealthPickedUp=0,Object.getOwnPropertyNames(l.b.MoveType).forEach(e=>{this.moveCounts[e]=0})}}e.Entry=t,Object.freeze(t),Object.freeze(t.prototype)}(h||(h={})),Object.freeze(h),Object.freeze(h.prototype);var u,d,p,m,f,E,_,g=s(5);s(7);class O{constructor(e,t,s){u.set(this,void 0),d.set(this,void 0),p.set(this,void 0),this.gameType=e;const i=this._getGridImplementation(s.coordSys);this.grid=new i({gridClass:i,tileClass:t.tileClass,coordSys:s.coordSys,dimensions:s.gridDimensions}),Object(r.__classPrivateFieldSet)(this,u,t.onGameBecomeOver),this.langFrontend=l.a.GET_FRONTEND_DESC_BY_ID(s.langId),this._playerStatusCtor=t.playerStatusCtor,this.players=this.createPlayers(s),this.operators=Object.freeze(this.players.filter(e=>e.isALocalOperator)),this.setCurrentOperator(0);{const e=[];if(this.players.forEach(t=>{e[t.teamId]||(e[t.teamId]=[]),e[t.teamId].push(t)}),this.teams=e.map((e,t)=>new o.Team(t,e)),this.teams.every(e=>e.id===o.Team.ElimOrder.IMMORTAL))throw Error("All teams are immortal. The game will never end.")}this.players.forEach(e=>e._afterAllPlayersConstruction())}reset(){return this.grid.reset(),Object(r.__classPrivateFieldSet)(this,p,"PAUSED"),Promise.resolve()}createPlayers(e){const t=e.playerDescs="ONLINE"===this.gameType?e.playerDescs:o.Player.CtorArgs.finalize(e.playerDescs);return Object.freeze(t.map(e=>e.familyId===o.Player.Family.HUMAN?e.isALocalOperator?this._createOperatorPlayer(e):new o.Player(this,e):this._createArtifPlayer(e)))}serializeResetState(){const e=[],t=this.players.map(e=>e.coord),s=[];return this.grid.forEachTile(t=>{t.lastKnownUpdateId++,e.push({char:t.langChar,seq:t.langSeq}),t.freeHealth&&s.push({coord:t.coord,health:t.freeHealth})}),{csps:e,playerCoords:t,healthCoords:s}}deserializeResetState(e){this.grid.forEachTile((t,s)=>{t.setLangCharSeqPair(e.csps[s]),t.lastKnownUpdateId++}),e.playerCoords.forEach((e,t)=>{this.players[t].reset(this.grid.tile.at(e))}),e.healthCoords.forEach(e=>{this.grid.tile.at(e.coord).freeHealth=e.health})}get currentOperator(){return Object(r.__classPrivateFieldGet)(this,d)}setCurrentOperator(e){const t=this.operators[e];t&&this.currentOperator!==t&&(t._notifyWillBecomeCurrent(),Object(r.__classPrivateFieldSet)(this,d,t))}get status(){return Object(r.__classPrivateFieldGet)(this,p)}statusBecomePlaying(){if("PLAYING"!==this.status){if("PAUSED"!==this.status)throw Error("Can only resume a game that is currently paused.");this.players.forEach(e=>{e._notifyGameNowPlaying()}),this._abstractStatusBecomePlaying(),Object(r.__classPrivateFieldSet)(this,p,"PLAYING")}else console.log("[statusBecomePlaying]: Game is already playing")}statusBecomePaused(){if("PAUSED"!==this.status){if("PLAYING"!==this.status)throw Error("Can only pause a game that is currently playing.");this.players.forEach(e=>{e._notifyGameNowPaused()}),this._abstractStatusBecomePaused(),Object(r.__classPrivateFieldSet)(this,p,"PAUSED")}else console.log("[statusBecomePaused]: Game is already paused")}statusBecomeOver(){if("PLAYING"!==this.status)throw Error("Can only end a game that is currently playing.");this.players.forEach(e=>{e._notifyGameNowOver()}),this._abstractStatusBecomeOver(),Object(r.__classPrivateFieldSet)(this,p,"OVER"),Object(r.__classPrivateFieldGet)(this,u).call(this),console.log("game is over!")}_abstractStatusBecomePlaying(){}_abstractStatusBecomePaused(){}_abstractStatusBecomeOver(){}}u=new WeakMap,d=new WeakMap,p=new WeakMap,Object.freeze(O),Object.freeze(O.prototype);class b extends O{constructor(e,t,s){super(e,t,s),m.set(this,void 0),this.eventRecordBitmap=[]}reset(){const e=super.reset();return this.eventRecordBitmap.fill(!1,0,a.Game.K.EVENT_RECORD_WRAPPING_BUFFER_LENGTH),Object(r.__classPrivateFieldSet)(this,m,0),e}get nextUnusedEventId(){return Object(r.__classPrivateFieldGet)(this,m)}_recordEvent(e){const t=e.eventId,s=t%a.Game.K.EVENT_RECORD_WRAPPING_BUFFER_LENGTH;if(t===g.EventRecordEntry.EVENT_ID_REJECT)throw TypeError("Do not try to record events for rejected requests.");if(t<0||t!==Math.trunc(t))throw RangeError("Event ID's must only be assigned positive, integer values.");if(this.eventRecordBitmap[s])throw Error("Event ID's must be assigned unique values.");this.eventRecordBitmap[s]=!0,this.eventRecordBitmap[(t+a.Game.K.EVENT_RECORD_WRAPPING_BUFFER_LENGTH-a.Game.K.EVENT_RECORD_FORWARD_WINDOW_LENGTH)%a.Game.K.EVENT_RECORD_WRAPPING_BUFFER_LENGTH]=!1,Object(r.__classPrivateFieldSet)(this,m,+Object(r.__classPrivateFieldGet)(this,m)+1)}executeTileModEvent(e,t=!0){Object.freeze(e);const s=this.grid.tile.at(e.coord);if(s.lastKnownUpdateId>e.lastKnownUpdateId)return s;if(s.lastKnownUpdateId===e.lastKnownUpdateId)throw"never";return e.newCharSeqPair&&(s.setLangCharSeqPair(e.newCharSeqPair),t&&this.operators.filter(e=>e.tile.destsFrom().get.includes(s)).forEach(e=>e.seqBufferAcceptKey(""))),s.lastKnownUpdateId=e.lastKnownUpdateId,s.freeHealth=e.newFreeHealth,s}executePlayerMoveEvent(e){var t;const s=this.players[e.playerId],r=e.playerLastAcceptedRequestId-s.lastAcceptedRequestId;if(e.eventId===g.EventRecordEntry.EVENT_ID_REJECT)return void(0===r&&(s.requestInFlight=!1));this._recordEvent(e);const i=this.executeTileModEvent(e.destModDesc,s!==this.currentOperator);if(null===(t=e.tileHealthModDescs)||void 0===t||t.forEach(e=>{this.executeTileModEvent(e)}),r>1){if(s===this.currentOperator)throw"never"}else{if(s.requestInFlight=!1,!(s===this.currentOperator?1===r:r<=1))throw"never";s.status.health=e.newPlayerHealth.health,s.moveTo(i),s.lastAcceptedRequestId=e.playerLastAcceptedRequestId}}executePlayerBubbleEvent(e){this.players[e.playerId].requestInFlight=!1,e.eventId!==g.EventRecordEntry.EVENT_ID_REJECT&&this._recordEvent(e)}}m=new WeakMap,Object.freeze(b),Object.freeze(b.prototype);class v extends b{constructor(e,t,i){super(e,t,i),f.set(this,void 0),E.set(this,void 0),_.set(this,void 0),this.averageFreeHealth=i.averageFreeHealthPerTile*this.grid.area,this.averageFreeHealthPerTile=i.averageFreeHealthPerTile,Object(r.__classPrivateFieldSet)(this,E,new Set),Object(r.__classPrivateFieldSet)(this,_,s(23)(`./${this.langFrontend.module}.ts`).then(e=>{const t=this.langFrontend.export.split(".").reduce((e,t)=>e[t],e[this.langFrontend.module]);this.lang=new t(i.langWeightExaggeration);const s=this.grid.static.getAmbiguityThreshold();if(this.lang.numLeaves<s)throw Error(`Found ${this.lang.numLeaves} leaves, but at least ${s} were required. The provided mappings composing the current Lang-under-construction are not sufficient to ensure that a shuffling operation will always be able to find a safe candidate to use as a replacement. Please see the spec for Lang.getNonConflictingChar.`);return this.lang})),this.scoreInfo=new h(this.players.map(e=>e.playerId))}reset(){const e=Object.create(null,{reset:{get:()=>super.reset}});return Object(r.__awaiter)(this,void 0,void 0,(function*(){yield e.reset.call(this),Object(r.__classPrivateFieldSet)(this,f,0),Object(r.__classPrivateFieldGet)(this,E).clear(),yield Object(r.__classPrivateFieldGet)(this,_),this.lang.reset(),this.grid.shuffledForEachTile(e=>{e.setLangCharSeqPair(this.dryRunShuffleLangCharSeqAt(e))}),this.teams.forEach(e=>e.reset());const t=this.grid.static.getSpawnCoords(this.teams.map(e=>e.members.length),this.grid.dimensions);return this.teams.forEach((e,s)=>{e.members.forEach((e,r)=>{e.reset(this.grid.tile.at(t[s][r]))})}),this.scoreInfo.reset(),Promise.resolve()}))}_createArtifPlayer(e){return c.a.of(this,e)}dryRunShuffleLangCharSeqAt(e){e.setLangCharSeqPair(i.a.CharSeqPair.NULL);const t=Array.from(new Set(this.grid.tile.sourcesTo(e.coord).get.flatMap(e=>this.grid.tile.destsFrom(e.coord).get)));return this.lang.getNonConflictingChar(t.map(e=>e.langSeq).filter(e=>e))}get currentFreeHealth(){return Object(r.__classPrivateFieldGet)(this,f)}get freeHealthTiles(){return Object(r.__classPrivateFieldGet)(this,E)}dryRunSpawnFreeHealth(e){let t=this.averageFreeHealth-this.currentFreeHealth;if(t<=0)return;const s=[];for(;t>0;){let r;do{r=this.grid.tile.at(this.grid.getRandomCoord())}while(r.isOccupied||s.find(e=>n.Coord.equals(r.coord,e.coord)));const i=1;if(Math.random()<a.Game.K.HEALTH_UPDATE_CHANCE){let t;(t=e.find(e=>n.Coord.equals(r.coord,e.coord)))?t.newFreeHealth=(t.newFreeHealth||0)+i:s.push({coord:r.coord,lastKnownUpdateId:1+r.lastKnownUpdateId,newCharSeqPair:void 0,newFreeHealth:r.freeHealth+i})}t-=i}return s}getHealthCostOfBoost(){return this.averageFreeHealthPerTile/a.Game.K.PCT_MOVES_THAT_ARE_BOOST}executeTileModEvent(e,t=!0){Object.freeze(e);const s=this.grid.tile.at(e.coord);if(e.lastKnownUpdateId!==1+s.lastKnownUpdateId)throw"never";return Object(r.__classPrivateFieldSet)(this,f,Object(r.__classPrivateFieldGet)(this,f)+(e.newFreeHealth-s.freeHealth)),0===e.newFreeHealth?Object(r.__classPrivateFieldGet)(this,E).delete(s):Object(r.__classPrivateFieldGet)(this,E).add(s),super.executeTileModEvent(e,t),s}managerCheckGamePlayingRequest(e){if("PLAYING"!==this.status)return;const t=this.players[e.playerId];if(!t)throw Error("No such player exists.");if(e.playerLastAcceptedRequestId!==t.lastAcceptedRequestId)throw RangeError(e.playerLastAcceptedRequestId<t.lastAcceptedRequestId?"Clients should not make requests until they have received my response to their last request.":"Client seems to have incremented the request ID counter on their own, which is is illegal.");return t}processMoveRequest(e){const t=this.managerCheckGamePlayingRequest(e);if(!t)return void this.executePlayerMoveEvent(e);const s=this.grid.tile.at(e.destModDesc.coord);if(s.isOccupied||s.lastKnownUpdateId!==e.destModDesc.lastKnownUpdateId)return void this.executePlayerMoveEvent(e);const r=e.moveType===o.Player.MoveType.BOOST,i=t.status.health+s.freeHealth*(t.status.isDowned?a.Game.K.HEALTH_EFFECT_FOR_DOWNED_PLAYER:1)-(r?this.getHealthCostOfBoost():0);if(r&&i<0)return void this.executePlayerMoveEvent(e);const n=this.scoreInfo.entries[t.playerId];n.totalHealthPickedUp+=s.freeHealth,n.moveCounts[e.moveType]+=1,e.playerLastAcceptedRequestId=1+t.lastAcceptedRequestId,e.newPlayerHealth={health:i},e.destModDesc.lastKnownUpdateId=1+s.lastKnownUpdateId,e.destModDesc.newFreeHealth=0,e.destModDesc.newCharSeqPair=this.dryRunShuffleLangCharSeqAt(s),e.tileHealthModDescs=this.dryRunSpawnFreeHealth([e.destModDesc]),e.eventId=this.nextUnusedEventId,this.executePlayerMoveEvent(e)}processPlayerContact(e){}processBubbleRequest(e){const t=this.managerCheckGamePlayingRequest(e);t?(e.playerLastAcceptedRequestId=1+t.lastAcceptedRequestId,e.eventId=this.nextUnusedEventId,this.executePlayerBubbleEvent(e)):this.executePlayerBubbleEvent(e)}}f=new WeakMap,E=new WeakMap,_=new WeakMap,(v||(v={})).CHECK_VALID_CTOR_ARGS=function(e){const t=[],s=Object.freeze({coordSys:0,gridDimensions:0,averageFreeHealthPerTile:0,langId:0,langWeightExaggeration:0,playerDescs:0}),r=[];for(const t in s){const s=e[t];null==s&&r.push(t)}return r.length&&t.push("Missing the following arguments: "+r),void 0===i.a.GET_FRONTEND_DESC_BY_ID(e.langId)&&t.push(`No language with the ID \`${e.langId}\` exists.`),NaN===parseInt(e.langWeightExaggeration)?t.push(`Language Weight Exaggeration expected a number, but\`${e.langWeightExaggeration}\` is not a number.`):e.langWeightExaggeration=Math.max(0,parseFloat(e.langWeightExaggeration)),t},Object.freeze(v),Object.freeze(v.prototype)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.server=void 0;const r=s(14);t.server=new r.SnakeyServer},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SnakeyServer=void 0;const r=s(15),i=s(16),a=s(17),n=s(18),o=s(19),c=s(20),l=s(11);class h extends l.SkServer{constructor(e=h.DEFAULT_PORT,t){super(),this.app=n(),this.http=a.createServer({},this.app),this.io=o(this.http,{serveClient:!1}),this.allGroups=new Map;const s=i.resolve(__dirname,"../..");this.app.disable("x-powered-by"),this.app.get("/",(e,t)=>{t.sendFile(i.resolve(s,"index.html"))}),this.app.use("/dist",n.static(i.resolve(s,"dist"))),this.app.use("/assets",n.static(i.resolve(s,"assets"))),this.http.listen({port:e,host:t},()=>{const t=this.http.address();console.log(`\n\nServer mounted to: \`${t.address}${t.port}\` using ${t.family}.\n`),console.log("This host can be reached at any of the following addresses:\n"),h.chooseIPAddress().sort().forEach(t=>{console.log(`${t}:${e}`)}),console.log("")}),this.io.of(h.Nsps.GROUP_JOINER).on("connection",this.onJoinerNspsConnection.bind(this))}onJoinerNspsConnection(e){console.log("socket    connect: "+e.id),e.emit(c.Group.Exist.EVENT_NAME,(()=>{const e={};return Array.from(this.allGroups).forEach(([t,s])=>{e[t]=s.isCurrentlyPlayingAGame?c.Group.Exist.Status.IN_GAME:c.Group.Exist.Status.IN_LOBBY}),e})()),e.on(c.Group.Exist.EVENT_NAME,t=>{(!t.groupName||this.allGroups.has(t.groupName)||t.groupName.length>c.Group.Name.MaxLength||!t.groupName.match(c.Group.Name.REGEXP)||t.passphrase.length>c.Group.Passphrase.MaxLength||!t.passphrase.match(c.Group.Passphrase.REGEXP))&&e.emit(c.Group.Exist.EVENT_NAME,c.Group.Exist.RequestCreate.Response.NOPE),this.allGroups.set(t.groupName,new c.Group(Object.freeze({namespace:this.io.of(h.Nsps.GROUP_LOBBY_PREFIX+t.groupName),name:t.groupName,passphrase:t.passphrase,deleteExternalRefs:()=>this.allGroups.delete(t.groupName),initialTtl:c.Group.DEFAULT_TTL}))),e.emit(c.Group.Exist.EVENT_NAME,c.Group.Exist.RequestCreate.Response.OKAY),e.nsp.emit(c.Group.Exist.EVENT_NAME,{[t.groupName]:c.Group.Exist.Status.IN_LOBBY})})}}t.SnakeyServer=h,function(e){e.chooseIPAddress=()=>Object.values(r.networkInterfaces()).flat().filter(e=>!e.internal).map(e=>"IPv6"===e.family?`[${e.address}]`:e.address)}(h=t.SnakeyServer||(t.SnakeyServer={})),Object.freeze(h),Object.freeze(h.prototype)},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t,s){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.Group=t.ServerGame=void 0;const i=s(0),a=s(3),n=s(21);Object.defineProperty(t,"ServerGame",{enumerable:!0,get:function(){return n.ServerGame}});const o=s(11),c=s(12);class l extends o.Group{constructor(e){super(),r.set(this,void 0),this.namespace=e.namespace,this.passphrase=e.passphrase,i.__classPrivateFieldSet(this,r,void 0),this._deleteExternalRefs=e.deleteExternalRefs,this._initialTtlTimeout=setTimeout(()=>{0===Object.keys(this.namespace.sockets).length&&this.terminate()},1e3*e.initialTtl).unref(),this.namespace.use((e,t)=>{e.handshake.query.passphrase!==this.passphrase&&t(new Error("Incorrect passphrase"));const s=e.handshake.query;return void 0!==s&&0===s.teamId||t(new Error(`a socket attempted to connect to group \`${this.name}\` without providing userInfo.`)),t()}).on("connection",this.onConnection.bind(this))}onConnection(e){console.log("socket    connect: "+e.id),i.__classPrivateFieldGet(this,r)&&e.disconnect(),e.userInfo=e.handshake.query.userInfo;{const t=l.Socket.UserInfoChange.EVENT_NAME;e.emit(t,{[e.id]:e.userInfo}),e.emit(t,Object.entries(this.sockets).reduce((e,[t,s])=>(e[t]=s.userInfo,e),{}))}1===Object.keys(e.nsp.connected).length&&(clearTimeout(this._initialTtlTimeout),this._initialTtlTimeout=void 0,this._sessionHost=e,this.namespace.server.of(o.SkServer.Nsps.GROUP_JOINER).emit(l.Exist.EVENT_NAME,{[this.name]:l.Exist.Status.IN_LOBBY}),e.on(a.Game.CtorArgs.Event.NAME,this._socketOnHostCreateGame.bind(this))),e.on(l.Socket.UserInfoChange.EVENT_NAME,t=>{if("string"!=typeof t.username||"number"!=typeof t.teamId||"string"!=typeof t.avatar)return void console.log(`bad format: username: \`${t.username}\`, teamId: \`${t.teamId}\`, avatar: \`${t.avatar}\`.`);e.userInfo=t;const s={[e.id]:t};e.nsp.emit(l.Socket.UserInfoChange.EVENT_NAME,s)}),e.on("disconnect",(...t)=>{if(e===this._sessionHost)return void this.terminate();if(1===Object.keys(e.nsp.sockets).length)return void this.terminate();const s={[e.id]:void 0};e.nsp.emit(l.Socket.UserInfoChange.EVENT_NAME,s)})}_socketOnHostCreateGame(e){if(this.namespace.server.of(o.SkServer.Nsps.GROUP_JOINER).emit(l.Exist.EVENT_NAME,{[this.name]:e!==a.Game.CtorArgs.Event.RETURN_TO_LOBBY_INDICATOR?l.Exist.Status.IN_GAME:l.Exist.Status.IN_LOBBY}),e!==a.Game.CtorArgs.Event.RETURN_TO_LOBBY_INDICATOR){this._createGameInstance(e).length}else i.__classPrivateFieldGet(this,r).onReturnToLobby()}get isCurrentlyPlayingAGame(){return void 0!==i.__classPrivateFieldGet(this,r)}terminate(){i.__classPrivateFieldSet(this,r,void 0);const e=this.namespace;e.removeAllListeners("connect"),e.removeAllListeners("connection"),Object.values(e.connected).forEach(e=>{e.disconnect()}),e.removeAllListeners(),delete e.server.nsps[e.name],this.namespace=void 0,this._deleteExternalRefs(),e.server.of(o.SkServer.Nsps.GROUP_JOINER).emit(l.Exist.EVENT_NAME,{[this.name]:l.Exist.Status.DELETE}),console.log(`terminated group: \`${this.name}\``)}_createGameInstance(e){const t=c.GamepartManager.CHECK_VALID_CTOR_ARGS(e);return t.length?(console.log(t),t):(console.log(`group ${this.name} new game`),e.playerDescs=[...e.playerDescs,...Object.values(this.sockets).map(e=>Object.freeze({isALocalOperator:!1,familyId:"HUMAN",teamId:e.userInfo.teamId,socketId:e.id,username:e.userInfo.username,avatar:e.userInfo.avatar,noCheckGameOver:!1,familyArgs:{}}))],i.__classPrivateFieldSet(this,r,new n.ServerGame(this.namespace,e)),[])}get sockets(){return this.namespace.sockets}}t.Group=l,r=new WeakMap,Object.freeze(l),Object.freeze(l.prototype)},function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ServerGame=void 0;const r=s(0),i=s(22),a=s(3),n=s(9),o=s(4),c=s(2),l=s(5),h=s(7),u=s(12);s(24).GameBootstrap.INIT_CLASS_REGISTRIES();class d extends u.GamepartManager{constructor(e,t){super(a.Game.Type.SERVER,{onGameBecomeOver:()=>{},tileClass:n.Tile,playerStatusCtor:c.PlayerStatus},t),this.namespace=e,this.playerSockets=t.playerDescs.filter(e=>e.familyId===c.Player.Family.HUMAN).map(e=>{if(!e.socketId)throw Error("missing socket ID for player "+e.playerId);return this.namespace.sockets[e.socketId]}),Promise.all(Object.values(this.namespace.sockets).map(e=>new Promise((t,s)=>{e.once(a.Game.CtorArgs.EVENT_NAME_CLIENT_READY_RESET,()=>{t()})}))).then(()=>{this.reset()}),Object.values(this.namespace.sockets).forEach(e=>{e.on(h.PlayerActionEvent.EVENT_NAME.Movement,this.processMoveRequest.bind(this)),e.on(h.PlayerActionEvent.EVENT_NAME.Bubble,this.processBubbleRequest.bind(this)),t.playerDescs.forEach(t=>{t.isALocalOperator=t.socketId===e.id}),e.emit(a.Game.CtorArgs.Event.NAME,t)})}_getGridImplementation(e){return o.Grid.getImplementation(e)}reset(){const e=Object.create(null,{reset:{get:()=>super.reset}});return r.__awaiter(this,void 0,void 0,(function*(){console.log("starting reset"),Promise.all(Object.values(this.namespace.sockets).map(e=>new Promise((t,s)=>{e.once(a.Game.CtorArgs.EVENT_NAME_CLIENT_READY_UNPAUSE,()=>{t()})}))).then(()=>{this.statusBecomePlaying(),this.namespace.emit(a.Game.CtorArgs.EVENT_NAME_SERVER_APPROVE_UNPAUSE)});const t=e.reset.call(this);return yield t,this.namespace.emit(a.Game.Serialization.EVENT_NAME,this.serializeResetState()),t}))}onReturnToLobby(){Object.values(this.namespace.sockets).forEach(e=>{e.removeAllListeners(h.PlayerActionEvent.EVENT_NAME.Movement),e.removeAllListeners(h.PlayerActionEvent.EVENT_NAME.Bubble)})}_createOperatorPlayer(e){throw TypeError("This should never be called for a ServerGame.")}setTimeout(e,t,...s){return i.setTimeout(e,t,s).unref()}cancelTimeout(e){clearTimeout(e)}executePlayerMoveEvent(e){super.executePlayerMoveEvent(e),e.eventId===l.EventRecordEntry.EVENT_ID_REJECT?this.playerSockets[e.playerId].emit(h.PlayerActionEvent.EVENT_NAME.Movement,e):this.namespace.emit(h.PlayerActionEvent.EVENT_NAME.Movement,e)}executePlayerBubbleEvent(e){super.executePlayerBubbleEvent(e),e.eventId===l.EventRecordEntry.EVENT_ID_REJECT?this.playerSockets[e.playerId].emit(h.PlayerActionEvent.EVENT_NAME.Bubble,e):this.namespace.emit(h.PlayerActionEvent.EVENT_NAME.Bubble,e)}}t.ServerGame=d,Object.freeze(d),Object.freeze(d.prototype)},function(e,t){e.exports=require("timers")},function(e,t,s){var r={"./Cellphone.ts":[25,1],"./Emote.ts":[26,2],"./English.ts":[27,3],"./Japanese.ts":[28,4],"./Korean.ts":[29,5],"./Morse.ts":[30,6]};function i(e){if(!s.o(r,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],i=t[0];return s.e(t[1]).then((function(){return s(i)}))}i.keys=function(){return Object.keys(r)},i.id=23,e.exports=i},function(e,t,s){"use strict";s.r(t),s.d(t,"GameBootstrap",(function(){return u}));var r,i,a,n,o=s(4),c=s(1);!function(e){let t,s,r,i,a,n;e.GLOBAL_IDS={PUBLIC_GAME_HOST_URLS:"public-game-hosts-list",CURRENT_HOST_GROUPS:"current-host-groups-list"},function(e){e.Class={TEXT_SELECT_DISABLED:"text-select-disabled",FILL_PARENT:"fill-parent",CENTER_CONTENTS:"center-contents",STACK_CONTENTS:"stack-contents",INPUT_GROUP:"sk-input-group",INPUT_GROUP_ITEM:"sk-input-group-item"},e.Dataset={COLOUR_SCHEME:"skColourScheme"}}(t=e.General||(e.General={})),function(e){e.Class={BASE:"tile",POINTER_HB:"tile__pointer-hitbox",LANG_CHAR_WRAP:"tile__char",LANG_SEQ:"tile__seq"},e.Dataset={HEALTH:"health"}}(s=e.Tile||(e.Tile={})),function(e){e.Class={GRID:"game-grid",SCROLL_OUTER:"game-grid-scroll-outer",SCROLL_INNER:"game-grid-scroll-inner",IMPL_BODY:"game-grid-impl-body",KBD_DC:"game-grid-kbd-dc",KBD_DC_ICON:"game-grid-kbd-dc__icon",PAUSE_OL:"game-grid-pause-overlay",PAUSE_OL_ICON:"game-grid-pause-overlay__icon",PLAYER_IOB_ROOT:"grid-player-intersection-root"},e.Dataset={IMPL_COORD_SYS:"coordSys",GAME_STATE:{KEY:"gameState",VALUES:{PLAYING:"playing",PAUSED:"paused",OVER:"over"}}}}(r=e.Grid||(e.Grid={})),function(e){e.Class={BASE:"player",FACE:"player__face",DOWNED_OVERLAY:"player__downed-overlay",SHORT_SPOTLIGHT:"player__spotlight-short",LONG_SPOTLIGHT:"player__spotlight-long"},e.Dataset={DOWNED:{KEY:"downed",VALUES:{TEAM:"team",SELF:"self",NO:"no"}},FACE_SWATCH:"face"}}(i=e.Player||(e.Player={})),function(e){let t;e.Id={ALL_SCREENS:"all-screens-container",SCREEN_TINT:"screen-tint"},e.Class={BASE:"sk-screen",NAV_NEXT:"screen--next-button",NAV_PREV:"screen--back-button"},e.Dataset={CURRENT:"current"},function(e){let t,s,r,i,a,n;!function(e){e.Class={BASE:"screen-home",NAV:"screen-home--nav",NAV_PLAY_OFFLINE:"screen-home--nav--play-offline",NAV_PLAY_ONLINE:"screen-home--nav--play-online",NAV_HOW_TO_PLAY:"screen-home--nav--how-to-play",NAV_HOW_TO_HOST:"screen-home--nav--how-to-host",NAV_COLOURS:"screen-home--nav--colour-scheme",NAV_VIEW_REPO:"screen-home--nav--goto-repo",NAV_RPT_ISSUE:"screen-home--nav--report-issue"}}(t=e.Home||(e.Home={})),function(e){e.Class={BASE:"screen-colour",OPTION:"screen-colour--opt",OPTION_LABEL:"screen-colour--opt-label",OPTION_PREVIEW:"screen-colour--opt-preview"}}(s=e.ColourCtrl||(e.ColourCtrl={})),function(e){e.Class={BASE:"screen-play",GRID_WRAPPER:"screen-play--grid-wrapper",CONTROLS_BAR:"screen-play--controls-bar",PLAYERS_BAR:"screen-play--players-bar"}}(r=e.Play||(e.Play={})),function(e){e.Class={BASE:"screen-setup",LANG_SEL:"screen-setup--lang-sel",LANG_WEIGHT_EXAGG:"screen-setup--lang-weight-exagg"},e.Id={LANG_WEIGHT_EXAGGERATION_LIST:"screen-setup--lang-weight-exaggeration-list"}}(i=e.Setup||(e.Setup={})),function(e){e.Class={BASE:"screen-joiner",CONTENT_WRAPPER:"screen-joiner--content-wrapper",HOST_URL:"screen-joiner--host-url",GROUP_NAME:"screen-joiner--group-name",PASSPHRASE:"screen-joiner--passphrase"}}(a=e.GroupJoiner||(e.GroupJoiner={})),function(e){e.Class={BASE:"screen-lobby",SEC_CLIENT_INFO:"screen-lobby--client-info-section",SEC_TEAMS:"screen-lobby--teams-section",TEAM:"screen-lobby--team",PLAYER:"screen-lobby--player",PLAYER_NAME:"screen-lobby--player__name"}}(n=e.GroupLobby||(e.GroupLobby={}))}(t=e.Impl||(e.Impl={}))}(a=e.Screen||(e.Screen={})),function(e){e.Class={BASE:"sk-pick-one",OPT_BASE:"sk-pick-one--opt"}}(n=e.SkPickOne||(e.SkPickOne={}))}(r||(r={})),Object.freeze(r.Player.Dataset.DOWNED),Object(c.d)(r),function(e){e.getImplementation=t=>e._Constructors[t]}(i||(i={}));class l{_superVisibleGrid(e,t){const s=r.Grid;t.setAttribute("role","presentation"),t.classList.add(s.Class.IMPL_BODY),t.dataset[s.Dataset.IMPL_COORD_SYS]=e.coordSys,this.baseElem=t;const i=document.createElement("div");i.classList.add(r.Player.Class.SHORT_SPOTLIGHT);const a=document.createElement("div");a.classList.add(r.Player.Class.LONG_SPOTLIGHT),this.spotlightElems=Object.freeze([i,a])}}Object.freeze(l),Object.freeze(l.prototype),function(e){class t{constructor(e){this.x=e.x,this.y=e.y,Object.freeze(this)}_equals(e){return this.x===e.x&&this.y===e.y}round(){return new t({x:Math.round(this.x),y:Math.round(this.y)})}oneNorm(e){return this.sub(e).originOneNorm()}originOneNorm(){return Math.abs(this.x)+Math.abs(this.y)}infNorm(e){return this.sub(e).originInfNorm()}originInfNorm(){return Math.max(Math.abs(this.x),Math.abs(this.y))}axialAlignment(e){return this.sub(e).originAxialAlignment()}originAxialAlignment(){return Math.abs(Math.abs(this.x)-Math.abs(this.y))/(Math.abs(this.x)+Math.abs(this.y))}add(e){return new t({x:this.x+e.x,y:this.y+e.y})}sub(e){return new t({x:this.x-e.x,y:this.y-e.y})}mul(e){return new t({x:e*this.x,y:e*this.y})}}e.Coord=t,Object.freeze(t),Object.freeze(t.prototype);class s extends o.Grid{constructor(e){super(e);const s=[];for(let r=0;r<this.dimensions.height;r++){const i=[];for(let s=0;s<this.dimensions.width;s++){const a=new e.tileClass(new t({x:s,y:r}));i.push(a)}s.push(Object.freeze(i))}this.grid=Object.freeze(s)}static getAmbiguityThreshold(){return 24}static getSizeLimits(){return this.SIZE_LIMITS}forEachTile(e){let t=0;for(const s of this.grid)for(const r of s)e(r,t++)}shuffledForEachTile(e){this.grid.flat().sort((e,t)=>Math.random()-.5).forEach(t=>e(t))}getUntToward(e,t){const s=this.tile.destsFrom(t).unoccupied.get;if(0===s.length)return this.tile.at(t);if(1===s.length)return s[0];s.sort((t,s)=>t.coord.oneNorm(e)-s.coord.oneNorm(e)).sort((t,s)=>t.coord.infNorm(e)-s.coord.infNorm(e));for(let t=1;t<s.length;t++)if(s[t].coord.infNorm(e)>s[0].coord.infNorm(e)){s.splice(t);break}if(1===s.length)return s[0];if(s[0].coord.x-t.x==0||s[0].coord.y-t.y==0){if(t.axialAlignment(t.sub(e))-.5>0)return s[0];s.shift()}return s[Math.floor(s.length*Math.random())]}getUntAwayFrom(e,t){return this.getUntToward(t.add(t.sub(e)),t)}getRandomCoordAround(e,s){return new t({x:e.x+Math.trunc(2*s*(Math.random()-.5)),y:e.y+Math.trunc(2*s*(Math.random()-.5))})}_getTileAt(e){return this.grid[e.y][e.x]}_getTileDestsFrom(e,t=1){let s=e.y-t,r=e.y+t+1,i=e.x-t,a=e.x+t+1;return s>=this.dimensions.height||r<0||i>=this.dimensions.width||a<0?[]:this.grid.slice(Math.max(0,s),Math.min(this.dimensions.height,r)).flatMap(e=>e.slice(Math.max(0,i),Math.min(this.dimensions.width,a)))}_getTileSourcesTo(e,t=1){return this._getTileDestsFrom(e,t)}minMovesFromTo(e,t){return Math.min(Math.abs(t.x-e.x),Math.abs(t.y-e.y))}static getSpawnCoords(e,t){const r=[];return e.map(e=>{const i=[];for(;e>0;){let a;do{a=s.getRandomCoord(t)}while(r.find(e=>a._equals(e)));i.push(a),r.push(a),e--}return i})}static getArea(e){return e.height*e.width}static getRandomCoord(e){const s=Math.floor(e.width*Math.random()),r=Math.floor(e.height*Math.random());return new t({x:s,y:r})}}s.SIZE_LIMITS=Object.freeze({height:Object.freeze({min:11,max:51}),width:Object.freeze({min:11,max:51})}),e.Grid=s,function(e){class t extends e{constructor(e){super(e);const t=document.createElement("div");t.style.setProperty("--euclid2-grid-width",this.dimensions.width.toString());for(const e of this.grid)for(const s of e)s._addToDom(t);this._superVisibleGrid(e,t)}}e.Visible=t,Object(c.c)(t,[l]),Object.freeze(t),Object.freeze(t.prototype)}(s=e.Grid||(e.Grid={})),Object.freeze(s),Object.freeze(s.prototype)}(a||(a={})),Object.freeze(a),function(e){class t{constructor(e){this.dash=e.dash,this.bash=e.bash,Object.freeze(this)}_equals(e){return this.dash===e.dash&&this.bash===e.bash}round(){const e=Math.floor(this.dash),s=Math.floor(this.bash),r=e-this.dash,i=s-this.bash;return r>2*i?new t({dash:e+1,bash:s}):r<.5*i?new t({dash:e,bash:s+1}):Math.min(r,i)>.5?new t({dash:e+1,bash:s+1}):new t({dash:e,bash:s})}add(e){return new t({dash:this.dash+e.dash,bash:this.bash+e.bash})}sub(e){return new t({dash:this.dash-e.dash,bash:this.bash-e.bash})}mul(e){return new t({dash:e*this.dash,bash:e*this.bash})}}e.Coord=t,Object.freeze(t),Object.freeze(t.prototype);class s extends o.Grid{constructor(e){super(e);this.grid=Object.freeze(void 0)}static getAmbiguityThreshold(){return 18}static getSizeLimits(){return this.SIZE_LIMITS}forEachTile(e){let t=0;for(const s of this.grid)for(const r of s)e(r,t++)}shuffledForEachTile(e){this.grid.flat().sort((e,t)=>Math.random()-.5).forEach(t=>e(t))}getUntToward(e,t){}getUntAwayFrom(e,t){return this.getUntToward(t.add(t.sub(e)),t)}getRandomCoordAround(e,t){}_getTileAt(e){}_getTileDestsFrom(e){}_getTileSourcesTo(e){}minMovesFromTo(e,t){}static getSpawnCoords(e,t){}static getArea(e){const t=Math.min(e.fslash,e.bslash),s=Math.max(e.fslash,e.bslash),r=-1+e.dash+t;let i=2*t*(e.dash+r);return i+=(s-t-1)*r,i}static getRandomCoord(e){return new t(void 0)}}s.SIZE_LIMITS=Object.freeze({dash:Object.freeze({min:10,max:50}),bslash:Object.freeze({min:10,max:50}),fslash:Object.freeze({min:10,max:50})}),e.Grid=s,function(e){class t extends e{constructor(e){super(e);this._superVisibleGrid(e,void 0)}}e.Visible=t,Object(c.c)(t,[l]),Object.freeze(t),Object.freeze(t.prototype)}(s=e.Grid||(e.Grid={})),Object.freeze(s),Object.freeze(s.prototype)}(n||(n={})),Object.freeze(n);var h,u,d=s(6),p=s(0);class m extends d.a{constructor(e,t){super(e,t),h.set(this,void 0),this.behaviour=Object.freeze(Object.assign(Object.create(null),m.Behaviour.DEFAULT,t.familyArgs)),this.grid=this.game.grid}_afterAllPlayersConstruction(){super._afterAllPlayersConstruction(),this.threatProximity=this.game.teams.filter(e=>e.id!==this.teamId).flatMap(e=>e.members),this.targetProximity=this.threatProximity.slice()}reset(e){super.reset(e),Object(p.__classPrivateFieldSet)(this,h,this.coord)}moveTo(e){Object(p.__classPrivateFieldSet)(this,h,this.coord),super.moveTo(e)}computeDesiredDest(){this.threatProximity.sort((e,t)=>this.grid.minMovesFromTo(e.coord,this.coord)-this.grid.minMovesFromTo(t.coord,this.coord));for(const e of this.threatProximity){if(this.grid.minMovesFromTo(e.coord,this.coord)>this.behaviour.fearDistance)break;if(!e.status.isDowned&&e.status.health>this.status.health)return this.grid.getUntAwayFrom(e.coord,this.coord).coord}if(this.targetProximity.sort((e,t)=>this.grid.minMovesFromTo(this.coord,e.coord)-this.grid.minMovesFromTo(this.coord,t.coord)),this.status.isDowned)for(const e of this.targetProximity){if(this.grid.minMovesFromTo(this.coord,e.coord)>this.behaviour.bloodThirstDistance)break;if(e.status.health<this.status.health-this.behaviour.healthReserve)return e.coord}if(0===this.game.freeHealthTiles.size){if(Math.random()<this.behaviour.wanderingAimlessness)return this.grid.getRandomCoordAround(this.coord,3);{const e=this.grid.getUntAwayFrom.bind(this.grid,Object(p.__classPrivateFieldGet)(this,h));return this.grid.getRandomCoordAround(e(e(this.coord).coord).coord,1)}}let e=void 0,t=1/0;for(const s of this.game.freeHealthTiles){const r=this.grid.minMovesFromTo(this.coord,s.coord);r<t&&(e=s,t=r)}return e.coord}getNextMoveType(){return d.b.MoveType.NORMAL}computeNextMovementTimer(){return 1e3/this.behaviour.keyPressesPerSecond}}h=new WeakMap,function(e){let t;!function(e){e.DEFAULT=Object.freeze({fearDistance:5,bloodThirstDistance:7,healthReserve:3,keyPressesPerSecond:2,wanderingAimlessness:.2})}(t=e.Behaviour||(e.Behaviour={}))}(m||(m={})),Object.freeze(m),Object.freeze(m.prototype),function(e){function t(){o.Grid._Constructors=Object.freeze({EUCLID2:a.Grid,BEEHIVE:n.Grid}),Object.freeze(o.Grid),Object.freeze(o.Grid.prototype);{const e=i;e._Constructors=Object.freeze({EUCLID2:a.Grid.Visible,BEEHIVE:n.Grid.Visible}),Object.freeze(e)}{const e=d.a;e._Constructors=Object.freeze({CHASER:m}),Object.freeze(e),Object.freeze(e.prototype)}}e.INIT_CLASS_REGISTRIES=t,Object.freeze(t)}(u||(u={})),Object.freeze(u)}]);
//# sourceMappingURL=index.js.map