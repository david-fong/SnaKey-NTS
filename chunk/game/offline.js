(self.webpackChunkcapswalk=self.webpackChunkcapswalk||[]).push([[755],{145:(e,t,r)=>{"use strict";r.r(t),r.d(t,{OfflineGame:()=>E});var s=r(909),o=r(327),i=r(831),a=r(30),n=r(990),h=r(606),d=r(816);class c{constructor(e){const t=[];for(const r of e)t[r]=new c.Entry;this.entries=t,n.R.propNoWrite(this,"entries"),Object.seal(this)}reset(){for(const e of this.entries)e.reset()}}!function(e){class t{constructor(){this.moveCounts={}}reset(){Object.getOwnPropertyNames(a.J.MoveType).forEach((e=>{this.moveCounts[e]=0}))}}e.Entry=t,Object.freeze(t),Object.freeze(t.prototype)}(c||(c={})),Object.freeze(c),Object.freeze(c.prototype);var l=r(676),p=r(142),u=r(18),g=r(17),m=(e,t,r)=>(((e,t,r)=>{if(!t.has(e))throw TypeError("Cannot read from private field")})(e,t),r?r.call(e):t.get(e));class f extends a.J{constructor(e,t){super(e,t),this._nextMovementTimerMultiplier=void 0,this._scheduledMovementCallbackId=void 0}onGamePlaying(){this._delayedMovementContinue()}onGamePaused(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}onGameOver(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}_movementContinue(){const e=this.computeDesiredDest();this._nextMovementTimerMultiplier=this.game.grid.tileAt(e).seq.length,this.makeMovementRequest(this.game.grid.getUntToward(e,this.coord),this.getNextMoveType()),this._delayedMovementContinue()}_delayedMovementContinue(){this._scheduledMovementCallbackId=this.game.setTimeout(this._movementContinue.bind(this),this.computeNextMovementTimer()*this._nextMovementTimerMultiplier)}}!function(e){var t;e._Constructors={CHASER:void 0},e.of=(t,r)=>{const s=r.familyId;return new e._Constructors[s](t,r)};class r extends e{constructor(){super(...arguments),t.set(this,{which:0,reuses:0,target:void 0})}reset(e){super.reset(e),m(this,t).which=0,m(this,t).reuses=0,m(this,t).target=void 0}computeDesiredDest(){const e=m(this,t);if(void 0!==e.target&&e.reuses<=d.l.K._ROBOT_PRIORITY_MAX_REUSES){const t=this._behaviours[e.which].call(this,e.target);if(void 0!==t)return e.reuses++,t.dest}e.reuses=0;for(let t=0;t<this._behaviours.length;t++){const r=this._behaviours[t].call(this);if(void 0!==r)return e.which=t,e.target=r.target,r.dest}throw new Error("never")}}t=new WeakMap,e.Decisive=r,Object.freeze(r),Object.freeze(r.prototype)}(f||(f={})),n.R.protoNoEnum(f,"_movementContinue"),Object.seal(f),Object.freeze(f.prototype);var v=Object.defineProperty,y=Object.prototype.hasOwnProperty,b=Object.getOwnPropertySymbols,O=Object.prototype.propertyIsEnumerable,C=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t)=>{for(var r in t||(t={}))y.call(t,r)&&C(e,r,t[r]);if(b)for(var r of b(t))O.call(t,r)&&C(e,r,t[r]);return e};class I extends f.Decisive{constructor(e,t){super(e,t),this.pred=[],this.prey=[],this.params=Object.freeze(_(_({},I.Behaviour.DEFAULT),t.familyArgs)),this.grid=this.game.grid,Object.seal(this),n.R.propNoWrite(this,"params","grid")}_onTeamsBootstrapped(){super._onTeamsBootstrapped(),this.pred=this.game.teams.filter((e=>e.id!==this.teamId)).flatMap((e=>e.members)).seal(),this.prey=[...this.pred].seal(),n.R.propNoWrite(this,"pred","prey")}_bhvrEvadePred(e){if(void 0!==e)return{dest:this.grid.getUntAwayFrom(this.game.players[e].coord,this.coord)};this.pred.sort(((e,t)=>this.grid.dist(e.coord,this.coord)-this.grid.dist(t.coord,this.coord)));for(const e of this.pred){if(this.grid.dist(e.coord,this.coord)>this.params.fearDistance)break;if(!e.isDowned&&e.boosts>this.boosts)return{dest:this.grid.getUntAwayFrom(e.coord,this.coord),target:e.playerId}}}_bhvrChasePrey(e){if(void 0!==e)return{dest:this.game.players[e].coord};if(this.prey.sort(((e,t)=>this.grid.dist(this.coord,e.coord)-this.grid.dist(this.coord,t.coord))),this.isDowned)for(const e of this.prey){if(this.grid.dist(this.coord,e.coord)>this.params.bloodThirstDistance)break;if(e.boosts<this.boosts-this.params.healthReserve)return{dest:e.coord,target:e.playerId}}}_bhvrGotoHealthElseWander(e){if(Math.random()<this.params.wanderingAimlessness)return{dest:this.grid.getRandomCoordAround(this.coord,3)};{const e=this.grid.getUntAwayFrom.bind(this.grid,this.prevCoord);return{dest:this.grid.getRandomCoordAround(e(e(this.coord)),1)}}}getNextMoveType(){return a.J.MoveType.NORMAL}computeNextMovementTimer(){return 1e3/this.params.keyPressesPerSecond}}!function(e){let t;(t=e.Behaviour||(e.Behaviour={})).DEFAULT=Object.freeze({fearDistance:5,bloodThirstDistance:7,healthReserve:3,keyPressesPerSecond:2,wanderingAimlessness:.2})}(I||(I={})),I.prototype._behaviours=Object.freeze([I.prototype._bhvrEvadePred,I.prototype._bhvrChasePrey,I.prototype._bhvrGotoHealthElseWander]),n.R.protoNoEnum(I,"_onTeamsBootstrapped"),Object.freeze(I),Object.freeze(I.prototype);var T,w=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};(()=>{Object.freeze(Object.assign(l.r._Constructors,{W_EUCLID2:u.K.Grid,BEEHIVE:g.v.Grid})),Object.freeze(l.r);{const e=f;Object.freeze(Object.assign(e._Constructors,{CHASER:I})),Object.freeze(e)}})();class j extends p.S{constructor(e){var t,r,s;super(e),this.lang=void 0,T.set(this,void 0),this.scoreInfo=new c(this.players.map((e=>e.playerId))),n.R.propNoWrite(this,"scoreInfo"),t=this,r=T,s=h.U.Import(e.desc.langId).then((t=>(this.lang=new t(e.desc.langWeightExaggeration),n.R.propNoWrite(this,"lang"),this.lang))),w(t,r,"write to private field"),r.set(t,s)}async reset(){super.reset();const e=Object.freeze({playerCoords:[],csps:[]});var t,r;await(t=this,r=T,w(t,r,"read from private field"),r.get(t)),this.lang.reset(),this.grid.forEachShuffled(((t,r)=>{const s=this.dryRunShuffleLangCspAt(t.coord);this.grid.write(t.coord,s),e.csps[r]=s})),this.teams.forEach((e=>e.reset()));const s=this.grid.static.getSpawnCoords(this.teams.map((e=>e.members.length)),this.grid.dimensions);return this.teams.forEach(((t,r)=>{t.members.forEach(((t,o)=>{const i=s[r][o];t.reset(i),e.playerCoords[t.playerId]=i}))})),this.scoreInfo.reset(),e}dryRunShuffleLangCspAt(e){this.grid.write(e,{seq:""});const t=this.grid.getAllAltDestsThan(e).map((e=>e.seq)).freeze();return this.lang.getNonConflictingChar(t)}requestStateChange(e,t){const r=this.players[e.author];if(e.lastRejectId!==r.reqBuffer.lastRejectId)return;if(this.status!==d.l.Status.PLAYING||this.grid.isOccupied(e.moveDest))return void this.commitStateChange({rejectId:r.reqBuffer.getNextRejectId(),author:e.author},t);const s=e.moveType===a.J.MoveType.BOOST,o=r.boosts+(s?-1:d.l.K.PORTION_OF_MOVES_THAT_ARE_BOOST);s&&o<0?this.commitStateChange({rejectId:r.reqBuffer.getNextRejectId(),author:e.author},t):(this.scoreInfo.entries[r.playerId].moveCounts[e.moveType]+=1,this.commitStateChange({author:e.author,moveType:e.moveType,players:{[r.playerId]:{boosts:o,coord:e.moveDest}},tiles:{[e.moveDest]:this.dryRunShuffleLangCspAt(e.moveDest)}},t))}}T=new WeakMap,(j||(j={})).CHECK_VALID_CTOR_ARGS=function(e){const t=[],r=Object.freeze({coordSys:0,gridDimensions:0,langId:0,langWeightExaggeration:0,players:0}),s=[];for(const t in r){null==e[t]&&s.push(t)}s.length&&t.push("Missing the following arguments: "+s);const o=h.U.GetDesc(e.langId),i=l.r._Constructors[e.coordSys];return void 0===o?t.push(`No language with the ID \`${e.langId}\` exists.`):void 0===i?t.push(`No grid with the system ID \`${e.coordSys}\` exists.`):o.isolatedMinOpts<i.ambiguityThreshold&&t.push("The provided language does not have enough sequences\nto ensure that a shuffling operation will always succeed when\npaired with the provided grid system."),"number"!=typeof e.langWeightExaggeration?t.push(`Language Weight Exaggeration expected a number, but \`${e.langWeightExaggeration}\` is not a number.`):e.langWeightExaggeration=Math.max(0,parseFloat(e.langWeightExaggeration)),t},Object.freeze(j),Object.freeze(j.prototype),(0,s.Z)();class E extends j{constructor(e,t){super({impl:{gridClassLookup:o.T.getImplementation,OperatorPlayer:i.i,RobotPlayer:(e,t)=>f.of(e,t),onGameBecomeOver:e},desc:(a.J.CtorArgs.finalize(t),t),operatorIds:t.players.filter((e=>"HUMAN"===e.familyId)).map((e=>e.playerId))}),Object.seal(this)}setTimeout(e,t,...r){return setTimeout(e,t,r)}cancelTimeout(e){clearTimeout(e)}}Object.freeze(E),Object.freeze(E.prototype)}}]);
//# sourceMappingURL=offline.js.map