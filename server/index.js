var capswalk;(()=>{var e,t,s,r={929:(e,t,s)=>{"use strict";s.d(t,{R:()=>a});const r=Object.freeze({enumerable:!1}),o=Object.freeze({writable:!1});function i(e){e.repeat&&e.preventDefault()}var a;(e=>{function t(e){for(const s of Object.getOwnPropertyNames(e)){const r=e[s];null!==r&&"object"==typeof r&&t(r)}Object.freeze(e)}function s(e,t,...s){for(const r of s)Object.defineProperty(t,r,e)}let a;var n;e.deepFreeze=function(e){return t(e),e},e.hasProp=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.protoNoEnum=function(e,...t){Object.getOwnPropertyNames(e.prototype).freeze(),t.forEach((t=>{Object.defineProperty(e.prototype,t,r)}))},e.instNoEnum=s.bind(null,r),e.propNoWrite=s.bind(null,o),e.camelCaseTransforms=function(e){const t=e.replace(/[A-Z]/g,(e=>" "+e.toLowerCase()));return Object.freeze({spaceyLowercase:t,spaceyUppercase:t.toUpperCase(),spaceyCapitalized:t.split(" ").map((e=>e.charAt(0).toUpperCase()+e.substring(1))).join(" ")})},(n=a=e.Web||(e.Web={})).prependComment=function(e,t){e.parentNode.insertBefore(document.createComment(" "+t+" "),e)},n.adoptStyleSheet=function(t,s){t.appendChild(e.html("link",[],{rel:"stylesheet",href:s}))},n._makeSmartStorage=function(e,t,s){const r={};return Object.keys(s).forEach((e=>{const o=""+e,i=s[e];Object.defineProperty(r,e,{enumerable:!0,get:()=>{const e=t.getItem(o);return null===e?i:JSON.parse(e)},set:e=>{t.setItem(o,JSON.stringify(e))}})})),r},e.html=function(e,t,s){const r=document.createElement(e);try{Object.seal(r)}catch(e){}return(null==t?void 0:t.length)&&r.classList.add(...t),"button"===e?(r.type="button",r.addEventListener("keydown",i,{capture:!0})):"a"===e&&(r.draggable=!1,r.rel="noopener"),void 0!==s&&Object.assign(r,s),r},e.svg=function(e,t,s){const r=document.createElementNS("http://www.w3.org/2000/svg",e);return Object.seal(r),(null==t?void 0:t.length)&&r.classList.add(...t),void 0!==s&&Object.assign(r,s),r}})(a||(a={})),Object.freeze(a)},173:(e,t,s)=>{"use strict";s.d(t,{Uo:()=>i,J5:()=>o});const r=JSON.parse('["🎈","🎐","🏮","🗿","⚱","🛒","🎉","🧵","🧶","🎃","🎄","🎎","🎏","🧧","🎀","🎁","🎠","🎪","🎭","🎫","👑","👒","🎩","🎓","👓","🕶","🤿","💄","💎","👔","👖","🧤","🧦","👗","👘","👚","👜","🎒","🧰","💼","🥾","👠","👢","🩰","⚽","⚾","🏀","🏐","🏈","🎱","🎳","🥌","🏓","🎯","🪀","🏆","🎮","🎲","📢","🔔","🎵","🎧","📻","📯","🥁","🎷","🎺","🎸","🪕","🎻","🎥","📷","🎬","📺","📼","☎","📱","📟","💻","💾","🔬","🔭","⚙","🧲","🔍","💡","🩺","🩹","✒","✏","📜","📋","🔖","💸","💳","📨","📦","📬","📮","⏳","⏰","📅","📆","📈","📉","📌","📐","✂","🗑","♟","♠","♣","♥","🔓","🔑","⚔","🔫","💀","🙈","🙉","🙊","🐶","🐺","🐱","🦁","🐯","🦒","🦊","🦝","🐮","🐷","🐗","🐭","🐹","🐰","🐻","🐨","🐼","🐸","🦓","🐴","🦄","🐔","🐲","🐄","🐪","🐫","🦥","🦨","🐘","🐁","🐀","🦔","🐇","🐿","🦎","🐊","🐢","🐍","🦕","🦈","🐬","🐳","🐋","🐟","🐠","🦐","🦑","🐙","🦞","🦀","🐚","🦆","🐓","🦃","🦅","🕊","🦢","🦜","🦩","🦚","🦉","🐦","🐧","🐣","🦋","🐌","🐛","🐜","🐝","🐞","🕷","🕸","👁","🦷","👄","🧠","💃","🕺","🤸‍♀️","👃","🤏","✌","🤞","🖖","🤘","👍","👏","🙌","🙏","🍞","🧂","🥐","🥨","🧀","🥗","🥪","🌮","🥡","🍙","🍚","🍜","🍣","🍤","🍥","🍦","🍰","🍬","🍡","🍮","🧃","☕","🧊","🏺","🍑","🍓","🍎","🍊","🥭","🍍","🍋","🍈","🍐","🍏","🍒","🍅","🍌","🍉","🥝","🌽","🥑","🥬","🧄","🧅","🥕","🌶","🌰","🍄","🌸","🏵","🌺","🌻","🌼","🌷","🌱","🌲","🎍","🌵","☘","🍀","🍁","🍂","🚗","🚒","🛹","🚋","🚠","🚂","🚀","🛰","⚓","🚩","🗺","🧭","⛰","🌋","🗻","🗽","🛎","🪑","🚽","🧻","🛁","🧯","☁","⛈","🌤","🌦","🌧","🌩","☀","⭐","🌈","☂","⛱","⚡","❄","⛄","🔥","🌊"]');Object.freeze({behavior:"smooth",block:"center",inline:"center"});class o{}(e=>{let t,s;var o;let i;var a;e.Family=Object.freeze({Human:"Human",Chaser:"Chaser"}),e.Family,(t=e.Id||(e.Id={})).NULL=-1,(o=s=e.Username||(e.Username={})).REGEXP=/[ a-zA-Z0-9:-]+/,o.MAX_LENGTH=15,(a=i=e.Avatar||(e.Avatar={})).Values=r.map((e=>e+"️")).freeze(),a.GET_RANDOM=function(){return a.Values[Math.random()*a.Values.length|0]}})(o||(o={})),Object.freeze(o);class i{}(e=>{let t,s;(t=e.Seq||(e.Seq={})).REGEXP=new RegExp("^[a-zA-Z0-9!@#$%^&*()-_=+;:'\"\\|,.<>/?]+$"),(s=e.WeightExaggeration||(e.WeightExaggeration={})).MAX=4,e.CHAR_HIT_COUNT_SEED_CEILING=5})(i||(i={})),Object.freeze(i),Object.freeze(i.prototype)},523:(e,t,s)=>{"use strict";s.d(t,{U:()=>y});var r=s(929),o=s(173);const i=Object.freeze({IDENT:e=>e,LOWER:e=>e.toLowerCase()}),a={"engl-low":{id:void 0,module:"English",export:"Lowercase",isolatedMinOpts:25,avgWeight:3.8639230769230766,remapFunc:i.LOWER,fontZoom:1,displayName:"English Lowercase (qwerty)",blurb:""},"engl-mix":{id:void 0,module:"English",export:"MixedCase",isolatedMinOpts:51,avgWeight:3.8639230769230775,remapFunc:i.IDENT,fontZoom:1,displayName:"English Mixed-Case (Qwerty)",blurb:""},"japn-hir":{id:void 0,module:"Japanese",export:"Hiragana",isolatedMinOpts:70,avgWeight:275509.7083333333,remapFunc:i.LOWER,fontZoom:1,displayName:"Japanese Hiragana",blurb:""},"japn-kat":{id:void 0,module:"Japanese",export:"Katakana",isolatedMinOpts:68,avgWeight:45577.26666666667,remapFunc:i.LOWER,fontZoom:1,displayName:"Japanese Katakana",blurb:""},"kore-dub":{id:void 0,module:"Korean",export:"Dubeolsik",isolatedMinOpts:9085,avgWeight:.9974982117852247,remapFunc:i.IDENT,fontZoom:1,displayName:"Korean Dubeolsik (두벌식 키보드)",blurb:"The most common keyboard layout, and South Korea's only Hangul standard since 1969. Consonants are on the left, and vowels on the right."},"kore-sub":{id:void 0,module:"Korean",export:"Sebeolsik",isolatedMinOpts:10098,avgWeight:.9974982117852336,remapFunc:i.IDENT,fontZoom:1,displayName:"Korean Sebeolsik (세벌식 최종 키보드)",blurb:"Another Hangul keyboard layout used in South Korea, and the final Sebeolsik layout designed by Dr. Kong Byung Woo, hence the name. Syllable-initial consonants are on the right, final consonants on the left, and vowels in the middle. It is more ergonomic than the dubeolsik, but not widely used."},"kore-rom":{id:void 0,module:"Korean",export:"Romanization",isolatedMinOpts:4764,avgWeight:.9974982117852286,remapFunc:i.LOWER,fontZoom:1,displayName:"Korean Revised Romanization",blurb:"The Revised Romanization of Korean (국어의 로마자 표기법; 國語의 로마字 表記法) is the official South Korean language romanization system. It was developed by the National Academy of the Korean Language from 1995, and was released on 7 July 2000 by South Korea's Ministry of Culture and Tourism"},"engl-cell-enc":{id:void 0,module:"English",export:"OldCellphone.Encode",isolatedMinOpts:7,avgWeight:3.8639230769230766,remapFunc:i.IDENT,fontZoom:1,displayName:"Old Cellphone Keyboard",blurb:""},"mors-enc":{id:void 0,module:"English",export:"Morse.Encode",isolatedMinOpts:11,avgWeight:2.6089716238018403,remapFunc:e=>e,fontZoom:1,displayName:"Morse Encoder",blurb:""},"mors-dec":{id:void 0,module:"English",export:"Morse.Decode",isolatedMinOpts:40,avgWeight:2.6089716238018408,remapFunc:i.LOWER,fontZoom:.4,displayName:"Morse Decoder",blurb:""},ngram2:{id:void 0,module:"Ngrams",export:"Ngram2",isolatedMinOpts:199,avgWeight:5.000010000000002,remapFunc:i.LOWER,fontZoom:.9,displayName:"English Bigrams",blurb:""},ngram3:{id:void 0,module:"Ngrams",export:"Ngram3",isolatedMinOpts:399,avgWeight:2.5000100000000023,remapFunc:i.LOWER,fontZoom:.6,displayName:"English Trigrams",blurb:""},numpad:{id:void 0,module:"Numpad",export:"Numpad",isolatedMinOpts:99,avgWeight:1,remapFunc:i.LOWER,fontZoom:.95,displayName:"Number Pad",blurb:""}};Object.entries(a).freeze().forEach((([e,t])=>{t.id=e})),r.R.deepFreeze(a);var n,h,c,d,l=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},m=(e,t,s)=>(l(e,t,"read from private field"),s?s.call(e):t.get(e)),p=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},u=(e,t,s,r)=>(l(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const f=new Map,g=class extends o.Uo{constructor(e,t){super(),p(this,n,void 0),p(this,h,void 0),p(this,c,void 0),p(this,d,void 0),this.desc=g.GetDesc(e),this.csps=f.has(e)?f.get(e):(()=>{const t=Object.getPrototypeOf(this).constructor.BUILD(),s=g.CreateCspsArray(t);return f.set(e,s),s})(),u(this,n,this.csps.length),r.R.propNoWrite(this,"desc","csps");{const e=g.GetWeightScalingFn(t,this.desc.avgWeight);u(this,h,Float32Array.from(this.csps.map((t=>e(t.unscaledWt)))))}u(this,c,new Float64Array(m(this,n))),u(this,d,new Uint16Array(m(this,n)+1)),Object.seal(this)}reset(){for(let e=0;e<m(this,c).length;e++)m(this,c)[e]=Math.random()*g.RESET_NUM_HITS/this.desc.avgWeight;const e=[];m(this,c).forEach(((t,s)=>{e.push(Object.freeze({_hits:t,cspsIndex:s}))})),e.push({_hits:1/0,cspsIndex:m(this,n)}),e.seal().sort(((e,t)=>e._hits-t._hits)).freeze();{let t=m(this,d)[m(this,n)]=e[0].cspsIndex;for(let s=1;s<e.length;s++)t=m(this,d)[t]=e[s].cspsIndex}}getNonConflictingChar(e){e=e.filter((e=>e)).freeze();const t=m(this,d);for(let s=t[m(this,n)],r=m(this,n);s!==m(this,n);r=s,s=t[s]){const o=this.csps[s];if(!e.some((e=>g.EitherPrefixesOther(e,o.seq)))){m(this,c)[s]+=1/m(this,h)[s];let e=s;for(;t[e]!==m(this,n)&&m(this,c)[s]>m(this,c)[t[e]];)e=t[e];return e!==s&&(t[r]=t[s],t[s]=t[e],t[e]=s),o}}throw new Error("never")}_assertInvariants(){const e=[];for(let t=0;t<m(this,n);t++)e[t]=!1;e.seal();let t=m(this,d)[m(this,n)],s=0;for(let r=0;r<m(this,n);r++){if(m(this,c)[t]<s)throw new Error("lang hits should be ascending");s=m(this,c)[t],e[t]=!0,t=m(this,d)[t]}if(t!==m(this,n))throw new Error("lang next should end by looping back");if(e.some((e=>!1===e)))throw new Error("lang next should be an exhaustive loop")}_calcIsolatedMinOpts(){const e=[];this.csps.forEach((t=>{e[e.length-1]!==t.seq&&e.push(t.seq)})),e.freeze();const t=[];for(const s of[...e].seal().reverse().freeze())t.some((e=>e.startsWith(s)))||t.push(s);t.freeze();const s=[];for(const t of e)s.some((e=>e.startsWith(t)))||s.push(t);s.freeze();const r=new Map;return s.forEach((e=>r.set(e,0))),t.forEach((e=>{for(const t of s)if(e.startsWith(t)){r.set(t,r.get(t)+1);break}})),[...r.values()].sort(((e,t)=>e-t)).slice(0,-1).reduce(((e,t)=>e+t),0)}};let y=g;n=new WeakMap,h=new WeakMap,c=new WeakMap,d=new WeakMap,(e=>{function t(e){return a[e]}async function r(e){const t=a[e],r=await s(59)(`./${t.module}.ts`);return t.export.split(".").reduce(((e,t)=>e[t]),r[t.module])}function o(e,t){return 0===e?o.UNIFORM:1===e?o.IDENTITY:s=>Math.pow(s/t,e)}var i;function n(e){return Object.entries(e).freeze().map((([e,{seq:t,weight:s}])=>Object.freeze({char:e,seq:t,unscaledWt:s}))).seal().sort(((e,t)=>t.unscaledWt-e.unscaledWt)).freeze()}let h;e.GetDesc=t,Object.freeze(t),e.Import=r,Object.freeze(r),e.GetWeightScalingFn=o,(i=o=e.GetWeightScalingFn||(e.GetWeightScalingFn={})).UNIFORM=function(){return 1},i.IDENTITY=function(e){return e},Object.freeze(o),e.CreateCspsArray=n,Object.freeze(n),e.RESET_NUM_HITS=10,e.EitherPrefixesOther=function(e,t){return e.length>t.length?e.startsWith(t):t.startsWith(e)},(e=>{function t(e){return Object.entries(e).freeze().reduce(((e,[t,s])=>(e[t]={seq:t,weight:s},e)),{})}e.WORD_FOR_WORD=t,Object.freeze(t)})(h=e.BuildUtils||(e.BuildUtils={}))})(y||(y={})),Object.freeze(y),Object.freeze(y.prototype)},59:(e,t,s)=>{var r={"./Chinese.ts":[7,7,330],"./Emote.ts":[427,9,858],"./English.ts":[468,9,184],"./Japanese.ts":[855,9,410],"./Korean.ts":[55,9,227],"./Ngrams.ts":[805,9,273],"./Numpad.ts":[283,9,683],"./Shell.ts":[433,9,159],"./defs/Chinese.ts":[944,7,704],"./defs/English100.ts":[104,9,885]};function o(e){if(!s.o(r,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],o=t[0];return s.e(t[2]).then((()=>s.t(o,16|t[1])))}o.keys=()=>Object.keys(r),o.id=59,e.exports=o}},o={};function i(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return r[e](s,s.exports,i),s.exports}i.m=r,i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var o=Object.create(null);i.r(o);var a={};e=e||[null,t({}),t([]),t(t)];for(var n=2&r&&s;"object"==typeof n&&!~e.indexOf(n);n=t(n))Object.getOwnPropertyNames(n).forEach((e=>a[e]=()=>s[e]));return a.default=()=>s,i.d(o,a),o},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,s)=>(i.f[s](e,t),t)),[])),i.u=e=>"chunk/"+{159:"lang/Shell-ts",184:"lang/English-ts",227:"lang/Korean-ts",273:"lang/Ngrams-ts",330:"lang/Chinese-ts",410:"lang/Japanese-ts",683:"lang/Numpad-ts",704:"lang/defs-Chinese-ts",858:"lang/Emote-ts",885:"lang/defs-English100-ts"}[e]+".js",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s={826:1},i.f.require=(e,t)=>{s[e]||(e=>{var t=e.modules,r=e.ids,o=e.runtime;for(var a in t)i.o(t,a)&&(i.m[a]=t[a]);o&&o(i);for(var n=0;n<r.length;n++)s[r[n]]=1})(require("./"+i.u(e)))};var a={};(()=>{"use strict";i.r(a),i.d(a,{chooseIPAddress:()=>gt,wss:()=>ft});const e=require("fs");var t=i.n(e);const s=require("path");var r=i.n(s);Object.defineProperties(Array.prototype,{freeze:{value:function(){return Object.freeze(this)},enumerable:!0},seal:{value:function(){return Object.seal(this)},enumerable:!0}}),["Object","String","Number","RegExp","Date","Array","Map","Set","WeakMap","WeakSet"].forEach((e=>{if(Object.defineProperty(globalThis,e,{enumerable:!0,writable:!1,configurable:!1}),Object.freeze(globalThis[e]),"Object"===e){Object.seal(globalThis[e].prototype);for(const e of Object.getOwnPropertyNames(Object.prototype))Object.defineProperty(Object.prototype,e,{configurable:!1,enumerable:!1,writable:"toString"===e})}else Object.freeze(globalThis[e].prototype)})),process.on("uncaughtException",(function(e){const s=r().resolve(__dirname,"../..");console.error("\n\n"),void 0!==e.stack&&(e.stack=e.stack.replace(new RegExp(s.replace(/\\/g,"\\\\"),"g"),":").split("\n").map((e=>{const t=e.indexOf("(");return t<0?e:e.substring(0,t)+" ".repeat(Math.max(0,35-t))+e.substring(t)})).join("\n"),t().writeSync(process.stderr.fd,e.stack)),console.error("\n\n"),process.exit(1)}));const o=require("os");var n=i.n(o);const h=require("http");var c=i.n(h);const d=require("koa");var l=i.n(d);const m=require("koa-static");var p=i.n(m);const u=require("ws");var f=i.n(u);function g(e){if(y.has(e))return y.get(e);throw new Error("never")}const y=new WeakMap;class b{}var v,E;(e=>{let t;var s;let r;var o;(s=t=e.Name||(e.Name={})).REGEXP=/^(?:[a-zA-Z0-9:-]+)$/,s.MaxLength=30,(o=r=e.Passphrase||(e.Passphrase={})).REGEXP=/^(?:[a-zA-Z0-9:-]*)$/,o.MaxLength=30,e.GameServerReconnectionAttempts=2,e.DEFAULT_TTL=20})(b||(b={})),Object.freeze(b),Object.freeze(b.prototype),(e=>{let t,s,r;(t=e.Create||(e.Create={})).NAME="joiner/create",(e=>{let t;var s;e.NAME="joiner/exist",(s=t=e.Status||(e.Status={})).IN_LOBBY="in-lobby",s.IN_GAME="in-game",s.DELETE="delete"})(s=e.Exist||(e.Exist={})),(r=e.TryJoin||(e.TryJoin={})).NAME="joiner/try-join"})(v||(v={})),Object.freeze(v),(e=>{let t;(t=e.UserInfo||(e.UserInfo={})).NAME="group/user-info-change",e.CREATE_GAME="group/create-game"})(E||(E={})),Object.freeze(E);var O,w=(e=>(e.RESET="game/reset",e.UNPAUSE="game/unpause",e.PAUSE="game/pause",e.IN_GAME="game/ingame",e.RETURN_TO_LOBBY="game/return-to-lobby",e))(w||{}),N=i(929),S=i(523);(e=>{let t;var s;(s=t=e.Status||(e.Status={})).PLAYING="PLAYING",s.PAUSED="PAUSED",s.OVER="OVER",Object.freeze(t),e.K=Object.freeze({PORTION_OF_MOVES_THAT_ARE_BOOST:.4,MAX_PLAYER_CROWDEDNESS:.5,_REQUEST_BUFFER_LENGTH:5,_ROBOT_PRIORITY_MAX_REUSES:4})})(O||(O={})),Object.freeze(O);var j,T=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},z=(e,t,s,r)=>(T(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class A{constructor(){((e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,0)})(this,j),this.size=0}get lastRejectId(){return T(this,e=j,"read from private field"),e.get(this);var e}reset(e){z(this,j,0),this.size=0,this.predictedCoord=e}get isFull(){return this.size===O.K._REQUEST_BUFFER_LENGTH}signRequest(e){return this.size++,this.predictedCoord=e.moveDest,e}getNextRejectId(){return(this.lastRejectId+(99*Math.random()|0))%100}reject(e,t){z(this,j,e),this.size=0,this.predictedCoord=t}acceptOldest(){this.size--}}j=new WeakMap,Object.freeze(A),Object.freeze(A.prototype);var C=i(173);class k{constructor(e,t){if(this.id=e,this.members=t,this.elimOrder=k.ElimOrder.STANDING,N.R.propNoWrite(this,"id","members"),Object.seal(this),0===t.length)throw new Error("Teams must have at least one member.")}reset(){this.elimOrder=k.ElimOrder.STANDING}}(e=>{let t;(t=e.ElimOrder||(e.ElimOrder={})).STANDING=0})(k||(k={})),Object.freeze(k),Object.freeze(k.prototype);var I,M,R=Object.defineProperty,P=Object.defineProperties,_=Object.getOwnPropertyDescriptors,x=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,D=Object.prototype.propertyIsEnumerable,L=(e,t,s)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,G=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},B=(e,t,s)=>(G(e,t,"read from private field"),s?s.call(e):t.get(e)),U=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},F=(e,t,s,r)=>(G(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const q=class extends C.J5{constructor(e,t){super(),U(this,I,0),U(this,M,0),this.prevCoord=void 0,this.playerId=t.playerId,this.familyId=t.familyId,this.teamId=t.teamId,this.username=t.username,this.avatar=t.avatar,this.game=e,this.reqBuffer=new A,N.R.instNoEnum(this,"game"),N.R.propNoWrite(this,"game","playerId","familyId","teamId","username","avatar","reqBuffer"),new.target===q&&Object.seal(this)}get team(){return this.game.teams[this.teamId]}get coord(){return B(this,I)}get boosts(){return B(this,M)}get isDowned(){return this.boosts<0}isTeamedWith(e){return this.team.members.includes(e)}_onTeamsBootstrapped(){}reset(e){F(this,I,e),this.prevCoord=e,this.game.grid.moveEntity(this.playerId,e,e),F(this,M,0),this.reqBuffer.reset(e)}onGamePlaying(){}onGamePaused(){}onGameOver(){}makeMovementRequest(e,t){this.reqBuffer.isFull||this.game.requestStateChange(this.reqBuffer.signRequest({author:this.playerId,lastRejectId:this.reqBuffer.lastRejectId,moveType:t,moveDest:e}))}_setCoord(e){this.prevCoord=this.coord,F(this,I,e)}set boosts(e){const t=this.isDowned;if(F(this,M,e),t||!this.isDowned)return;const s=this.team,r=this.game.teams;if(s.elimOrder===k.ElimOrder.STANDING&&s.members.every((e=>e.isDowned))){const e=1+r.filter((e=>e.elimOrder!==k.ElimOrder.STANDING)).length;s.elimOrder=1+r.filter((e=>e.elimOrder!==k.ElimOrder.STANDING)).length,e===r.length&&this.game.statusBecomeOver()}}};let J=q;I=new WeakMap,M=new WeakMap,(e=>{let t;e.MoveType=Object.freeze({NORMAL:"NORMAL",BOOST:"BOOST"}),e.MoveType,(t=e.CtorArgs||(e.CtorArgs={})).finalize=function(t){const s=Array.from(new Set(t.players.map((e=>e.teamId)))).seal().sort(((e,t)=>e-t)).freeze().reduce(((e,t,s)=>(e[t]=s,e)),[]);t.players=t.players.slice().seal().sort(((e,t)=>s[e.teamId]-s[t.teamId])).freeze().map(((t,r)=>{var o,i,a;return i=((e,t)=>{for(var s in t||(t={}))W.call(t,s)&&L(e,s,t[s]);if(x)for(var s of x(t))D.call(t,s)&&L(e,s,t[s]);return e})({},t),a={playerId:r,teamId:s[t.teamId],avatar:null!=(o=t.avatar)?o:e.Avatar.GET_RANDOM()},P(i,_(a))})).freeze()},Object.freeze(t)})(J||(J={})),N.R.protoNoEnum(J,"onGamePlaying","onGamePaused","onGameOver","_onTeamsBootstrapped"),Object.freeze(J),Object.freeze(J.prototype);class H{constructor(e){const t=[];for(const s of e)t[s]=new H.Entry;this.entries=t,N.R.propNoWrite(this,"entries"),Object.seal(this)}reset(){for(const e of this.entries)e.reset()}}(e=>{class t{constructor(){this.moveCounts={}}reset(){Object.getOwnPropertyNames(J.MoveType).forEach((e=>{this.moveCounts[e]=0}))}}e.Entry=t,Object.freeze(t),Object.freeze(t.prototype)})(H||(H={})),Object.freeze(H),Object.freeze(H.prototype);class ${constructor(e){Object.freeze(e),this.static=e.Grid,this.dimensions=e.dimensions,this.area=e.Grid.getArea(e.dimensions),N.R.propNoWrite(this,"static","dimensions")}reset(){this.forEach((e=>{this.write(e.coord,{char:"",seq:""})}))}renderChangeOperatedPlayer(e,t,s){}getAllAltDestsThan(e){const t=new Map;return this.tileSourcesTo(e).flatMap((e=>this.tileDestsFrom(e.coord))).forEach((e=>{t.has(e.coord)||t.set(e.coord,e)})),Array.from(t.values()).freeze()}getRandomCoord(){return this.static.getRandomCoord(this.dimensions)}static getSpawnCoords(e,t){const s=new Set;return e.map((e=>{const r=[];for(;e>0;){let o;do{o=this.getRandomCoord(t)}while(s.has(o));r.push(o),s.add(o),e--}return r.freeze()})).freeze()}}Object.freeze($),Object.freeze($.prototype);var K,Y,Z=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},X=(e,t,s)=>(Z(e,t,"read from private field"),s?s.call(e):t.get(e));class V{constructor(e,t){this.x=e,this.y=t,Object.freeze(this)}static from(e,t){return new V(t%e.width,t/e.width|0)}toCoord(e){return this.y*e.width+this.x}static distX(e,t,s){const r=Math.abs(t.x-s.x);return r<e.width/2?r:e.width-r}static distY(e,t,s){const r=Math.abs(t.y-s.y);return r<e.height/2?r:e.height-r}static oneNorm(e,t,s){return V.distX(e,t,s)+V.distY(e,t,s)}static infNorm(e,t,s){const r=V.distX(e,t,s),o=V.distY(e,t,s);return Math.max(r,o)}static wrapInfo(e,t,s){return Object.freeze({x:Math.abs(s.x-t.x)<e.width/2?0:s.x<t.x?-1:1,y:Math.abs(s.y-t.y)<e.height/2?0:s.y<t.y?-1:1})}static axialAlignment(e,t,s){const r=V.from(e,t),o=V.from(e,s),i=V.distX(e,r,o),a=V.distY(e,r,o);return Math.abs(i-a)/(i+a)}add(e){return new V(this.x+e.x,this.y+e.y)}sub(e){return new V(this.x-e.x,this.y-e.y)}iSub(e){return this.add(this.sub(e))}mul(e){return new V(e*this.x,e*this.y)}mod(e){let{x:t,y:s}=this;for(;t<0;)t+=e.width;for(;s<0;)s+=e.height;return t%=e.width,s%=e.height,new V(t,s)}}Object.freeze(V),Object.freeze(V.prototype),(e=>{var t;const s=class extends ${constructor(e){var r,o,i;super(e),((e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,void 0)})(this,t),r=this,o=t,i=new Uint8Array(this.area),Z(r,o,"write to private field"),o.set(r,i);const a=[];for(let e=0;e<this.dimensions.height;e++)for(let t=0;t<this.dimensions.width;t++)a.push({coord:e*this.dimensions.width+t,seq:""});this._grid=a.seal();const n=[];for(let t=0;t<e.dimensions.height;t++)for(let s=0;s<e.dimensions.width;s++)n.push(new V(s,t));this.iacCache=n.freeze(),N.R.instNoEnum(this,"iacCache"),N.R.propNoWrite(this,"_grid","iacCache"),new.target===s&&Object.seal(this)}reset(){super.reset(),X(this,t).fill(0)}write(e,t){this._grid[e]=Object.freeze(Object.assign({},this._grid[e],t))}moveEntity(e,s,r){X(this,t)[s]=0,X(this,t)[r]=1}forEach(e){for(let t=0;t<this.area;t++)e(this._grid[t],t)}forEachShuffled(e){const t=new Uint16Array(this.area);for(let e=0;e<this.area;e++)t[e]=e;t.sort((()=>Math.random()-.5));for(const s of t)e(this._grid[s],s)}getUntToward(e,t){const s=this.tileDestsFrom(t).filter((e=>!this.isOccupied(e.coord))).map((t=>{const s=this.iacCache[t.coord],r=this.iacCache[e];return{tile:t,iac:s,infNorm:V.infNorm(this.dimensions,s,r),oneNorm:V.oneNorm(this.dimensions,s,r)}}));if(0===s.length)return t;s.sort(((e,t)=>e.infNorm-t.infNorm)),s.length=3,s.sort(((e,t)=>e.oneNorm-t.oneNorm));const r=s[0];for(let e=1;e<s.length;e++)if(s[e].infNorm>r.infNorm){s.splice(e);break}if(1===s.length)return r.tile.coord;if(r.infNorm===r.oneNorm){if(V.axialAlignment(this.dimensions,t,e)>.5)return r.tile.coord;s.shift()}return s[s.length*Math.random()|0].tile.coord}getUntAwayFrom(e,t){const s=this.iacCache[e];return this.iacCache[t].iSub(s).mod(this.dimensions).toCoord(this.dimensions)}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){const s=this.iacCache[e];return new V(s.x+(2*t*(Math.random()-.5)|0),s.y+(2*t*(Math.random()-.5)|0)).mod(this.dimensions).toCoord(this.dimensions)}dist(e,t){return V.infNorm(this.dimensions,this.iacCache[e],this.iacCache[t])}isOccupied(e){return 0!==X(this,t)[e]}tileAt(e){return this._grid[e]}tileDestsFrom(e,t=1){const s=this.iacCache[e];let r=!1,o=!1;const i=this.dimensions.width,a=this.dimensions.height;let n=s.y-t;n<0&&(n+=a,o=!0);let h=s.x-t;h<0&&(h+=i,r=!0);let c=s.y+t+1;c>a&&(c-=a,o=!0);let d=s.x+t+1;d>i&&(d-=i,r=!0);const l=[];if(r){const e=n*i;l.push(...this._grid.slice(e,e+d).freeze()),o&&l.push(...this._grid.slice(0,d).freeze())}const m=o?a:c,p=2*t+1;for(let e=n;e<m;e++){const t=e*i+h;l.push(...this._grid.slice(t,t+p).freeze())}if(r&&!o&&c!==a&&(l.length-=d),o){for(let e=0;e<c;e++){const t=e*i+h;l.push(...this._grid.slice(t,t+p).freeze())}r&&(l.length-=d)}return l.freeze()}tileSourcesTo(e,t=1){return this.tileDestsFrom(e,t)}static getArea(e){return e.height*e.width}static getLatticePatchDiameter(e){return Math.sqrt(e)}static getRandomCoord(e){const t=e.width*Math.random()|0;return(e.height*Math.random()|0)*e.width+t}_assertSomeInvariants(){const e=this._grid.map(((e,t)=>({i:t,arr:this.getAllAltDestsThan(e.coord).map((e=>e.coord)).sort().freeze()}))).filter((e=>25!==e.arr.length)).freeze();if(e.length)throw console.error(e),new Error("never")}};let r=s;t=new WeakMap,r.ambiguityThreshold=24,r.sizeLimits=N.R.deepFreeze({height:{min:5,max:51},width:{min:5,max:51},_render:void 0}),e.Grid=r,r.prototype.tileSourcesTo=r.prototype.tileDestsFrom,N.R.protoNoEnum(r,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(r),Object.freeze(r.prototype)})(K||(K={})),Object.freeze(K);class Q{constructor(e){this.dash=e.dash,this.bash=e.bash,Object.freeze(this)}toCoord(){}round(){const e=Math.floor(this.dash),t=Math.floor(this.bash),s=e-this.dash,r=t-this.bash;return s>2*r?new Q({dash:e+1,bash:t}):s<.5*r?new Q({dash:e,bash:t+1}):Math.min(s,r)>.5?new Q({dash:e+1,bash:t+1}):new Q({dash:e,bash:t})}add(e){return new Q({dash:this.dash+e.dash,bash:this.bash+e.bash})}sub(e){return new Q({dash:this.dash-e.dash,bash:this.bash-e.bash})}mul(e){return new Q({dash:e*this.dash,bash:e*this.bash})}}Object.freeze(Q),Object.freeze(Q.prototype),(e=>{const t=class extends ${constructor(e){super(e),this.grid=(void 0).freeze(),new.target===t&&Object.seal(this)}write(e,t){}moveEntity(e,t,s){}forEach(e){let t=0;for(const s of this.grid)for(const r of s)e(r,t++)}forEachShuffled(e){}getUntToward(e,t){}getUntAwayFrom(e,t){}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){}dist(e,t){}isOccupied(e){}tileAt(e){}tileDestsFrom(e,t=1){return[].freeze()}tileSourcesTo(e,t=1){return this.tileDestsFrom(e,t)}static getArea(e){const t=Math.min(e.fslash,e.bslash),s=Math.max(e.fslash,e.bslash),r=-1+e.dash+t;let o=2*t*(e.dash+r);return o+=(s-t-1)*r,o}static getLatticePatchDiameter(e){if(e<.25)throw new RangeError("determinant of a radical will be strictly negative.");return 1+(-3+Math.sqrt(9-12*(1-e)))/6*2}static getRandomCoord(e){return new Q(void 0).toCoord()}};let s=t;s.ambiguityThreshold=18,s.sizeLimits=N.R.deepFreeze({dash:{min:10,max:50},bslash:{min:10,max:50},fslash:{min:10,max:50}}),e.Grid=s,s.prototype.tileSourcesTo=s.prototype.tileDestsFrom,N.R.protoNoEnum(s,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(s),Object.freeze(s.prototype)})(Y||(Y={})),Object.freeze(Y);const ee=Object.freeze({Euclid2:K.Grid,Beehive:Y.Grid}),te=e=>ee[e];var se,re,oe,ie,ae,ne=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},he=(e,t,s)=>(ne(e,t,"read from private field"),s?s.call(e):t.get(e)),ce=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},de=(e,t,s,r)=>(ne(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class le{constructor(e){ce(this,ie),ce(this,se,void 0),ce(this,re,void 0),ce(this,oe,void 0);const{impl:t,desc:s,clientPlayerIds:r}=e;Object.freeze(s),Object.freeze(s.players),s.players.forEach((e=>Object.freeze(e))),Object.freeze(r);const o=S.U.GetDesc(e.desc.langId),i=t.gridClassLookup(s.coordSys);this.grid=new i({Grid:i,system:s.coordSys,dimensions:s.gridDimensions,langCharFontScaling:o.fontZoom,players:s.players}),de(this,se,t.onGameBecomeOver);const a=(this,n=ie,h=ae,ne(this,n,"access private method"),h).call(this,s,t,r,o);var n,h;this.players=a.players,this.clientPlayers=a.client;{const e=[];this.players.forEach((t=>{e[t.teamId]||(e[t.teamId]=[]),e[t.teamId].push(t)})),this.teams=e.map(((e,t)=>new k(t,e)))}N.R.propNoWrite(this,"grid","players","clientPlayers","teams"),this.players.forEach((e=>e._onTeamsBootstrapped())),this.setCurrentClientPlayer(0)}reset(){this.grid.reset(),de(this,oe,O.Status.PAUSED)}deserializeResetState(e){N.R.deepFreeze(e),this.grid.forEach(((t,s)=>{this.grid.write(t.coord,e.csps[s])})),e.playerCoords.forEach(((e,t)=>{this.players[t].reset(e)}))}get currentClientPlayer(){return he(this,re)}setCurrentClientPlayer(e){var t;const s=this.clientPlayers[e];if(void 0===s)throw new Error("never");this.currentClientPlayer!==s&&(this.grid.renderChangeOperatedPlayer(s.playerId,s.coord,null==(t=he(this,re))?void 0:t.coord),de(this,re,s))}get status(){return he(this,oe)}statusBecomePlaying(){if(this.status!==O.Status.PLAYING){if(this.status!==O.Status.PAUSED)throw new Error("Can only resume a game that is currently paused.");this.players.forEach((e=>{e.onGamePlaying()})),de(this,oe,O.Status.PLAYING)}else console.info("[statusBecomePlaying]: Game is already playing")}statusBecomePaused(){this.status!==O.Status.PAUSED?this.status!==O.Status.OVER&&(this.players.forEach((e=>{e.onGamePaused()})),de(this,oe,O.Status.PAUSED)):console.info("[statusBecomePaused]: Game is already paused")}statusBecomeOver(){this.status!==O.Status.OVER&&(this.players.forEach((e=>{e.onGameOver()})),de(this,oe,O.Status.OVER),he(this,se).call(this),console.info("game is over!"))}commitTileMods(e,t){if(void 0!==t.seq){const t=this.grid.tileSourcesTo(e);this.clientPlayers.forEach((e=>{t.some((t=>t.coord===e.coord))&&e.seqBufferAcceptKey(void 0)}))}this.grid.write(e,t)}commitStateChange(e,t){N.R.deepFreeze(e);const s=this.players[e.author];if(void 0===e.rejectId){s.reqBuffer.acceptOldest();for(const[t,s]of Object.entries(e.tiles).freeze())this.commitTileMods(parseInt(t),s);for(const[t,s]of Object.entries(e.players).freeze()){const e=this.players[parseInt(t)];if(e.boosts=s.boosts,void 0!==s.coord){const t=e.coord;this.grid.moveEntity(e.playerId,t,s.coord),e._setCoord(s.coord)}}}else s.reqBuffer.reject(e.rejectId,s.coord)}setTimeout(e,t,...s){return setTimeout(e,t,s)}cancelTimeout(e){clearTimeout(e)}}se=new WeakMap,re=new WeakMap,oe=new WeakMap,ie=new WeakSet,ae=function(e,t,s,r){const o=e.players.map((e=>e.familyId===J.Family.Human?s.includes(e.playerId)?new t.ClientPlayer(this,e,r):new J(this,e):t.RobotPlayer(this,e))).freeze();return Object.freeze({players:o,client:s.map((e=>o[e])).freeze()})},Object.freeze(le),Object.freeze(le.prototype);var me,pe=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};class ue extends le{constructor(e){var t,s,r;super(e),this.lang=void 0,((e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,void 0)})(this,me),this.scoreInfo=new H(this.players.map((e=>e.playerId))),N.R.propNoWrite(this,"scoreInfo"),t=this,s=me,r=S.U.Import(e.desc.langId).then((t=>(this.lang=new t(e.desc.langWeightExaggeration),N.R.propNoWrite(this,"lang"),this.lang))),pe(t,s,"write to private field"),s.set(t,r)}async reset(){super.reset();const e=Object.freeze({playerCoords:[],csps:[]});var t,s;await(t=this,s=me,pe(t,s,"read from private field"),s.get(t)),this.lang.reset(),this.grid.forEachShuffled(((t,s)=>{const r=this.dryRunShuffleLangCspAt(t.coord);this.grid.write(t.coord,r),e.csps[s]=r})),this.teams.forEach((e=>e.reset()));const r=this.grid.static.getSpawnCoords(this.teams.map((e=>e.members.length)),this.grid.dimensions);return this.teams.forEach(((t,s)=>{t.members.forEach(((t,o)=>{const i=r[s][o];t.reset(i),e.playerCoords[t.playerId]=i}))})),this.scoreInfo.reset(),e}dryRunShuffleLangCspAt(e){this.grid.write(e,{seq:""});const t=this.grid.getAllAltDestsThan(e).map((e=>e.seq)).freeze();return this.lang.getNonConflictingChar(t)}requestStateChange(e,t){const s=this.players[e.author];if(e.lastRejectId!==s.reqBuffer.lastRejectId)return;if(this.status!==O.Status.PLAYING||this.grid.isOccupied(e.moveDest))return void this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),author:e.author},t);const r=e.moveType===J.MoveType.BOOST,o=s.boosts+(r?-1:O.K.PORTION_OF_MOVES_THAT_ARE_BOOST);r&&o<0?this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),author:e.author},t):(this.scoreInfo.entries[s.playerId].moveCounts[e.moveType]+=1,this.commitStateChange({author:e.author,moveType:e.moveType,players:{[s.playerId]:{boosts:o,coord:e.moveDest}},tiles:{[e.moveDest]:this.dryRunShuffleLangCspAt(e.moveDest)}},t))}}me=new WeakMap,(ue||(ue={})).CHECK_VALID_CTOR_ARGS=function(e){const t=[],s=Object.freeze({coordSys:0,gridDimensions:0,langId:0,langWeightExaggeration:0,players:0}),r=[];for(const t in s){null==e[t]&&r.push(t)}r.length&&t.push("Missing the following arguments: "+r);const o=S.U.GetDesc(e.langId),i=te(e.coordSys);return void 0===o?t.push(`No language with the ID \`${e.langId}\` exists.`):void 0===i?t.push(`No grid with the system ID \`${e.coordSys}\` exists.`):o.isolatedMinOpts<i.ambiguityThreshold&&t.push("The provided language does not have enough sequences\nto ensure that a shuffling operation will always succeed when\npaired with the provided grid system."),"number"!=typeof e.langWeightExaggeration?t.push(`Language Weight Exaggeration expected a number, but \`${e.langWeightExaggeration}\` is not a number.`):e.langWeightExaggeration=Math.max(0,parseFloat(e.langWeightExaggeration)),Object.entries(i.sizeLimits).forEach((([s,r])=>{if(void 0===r)return;const o=e.gridDimensions[s];if("number"!=typeof o)return void t.push(`Expected a number for dimension "${s}" of grid dimensions.`);(o<r.min||o>r.max)&&t.push(`Expected a number within [${r.min}, ${r.max}] but got ${o}.`);const a=i.getArea(e.gridDimensions),n=e.players.length;n/a>O.K.MAX_PLAYER_CROWDEDNESS&&t.push(`To have ${n} players, the grid's area must be greater than ${n/O.K.MAX_PLAYER_CROWDEDNESS}, but got ${a}.`)})),t},Object.freeze(ue),Object.freeze(ue.prototype);var fe,ge,ye,be,ve,Ee,Oe=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},we=(e,t,s)=>(Oe(e,t,"read from private field"),s?s.call(e):t.get(e)),Ne=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},Se=(e,t,s,r)=>(Oe(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),je=(e,t,s)=>(Oe(e,t,"access private method"),s);class Te extends J{constructor(e,t){super(e,t),Ne(this,ye),Ne(this,ve),Ne(this,fe,void 0),Ne(this,ge,void 0)}onGamePlaying(){je(this,ve,Ee).call(this)}onGamePaused(){this.game.cancelTimeout(we(this,ge)),Se(this,ge,void 0)}onGameOver(){this.game.cancelTimeout(we(this,ge)),Se(this,ge,void 0)}}fe=new WeakMap,ge=new WeakMap,ye=new WeakSet,be=function(){const e=this.computeDesiredDest();Se(this,fe,this.game.grid.tileAt(e).seq.length),this.makeMovementRequest(this.game.grid.getUntToward(e,this.coord),this.getNextMoveType()),je(this,ve,Ee).call(this)},ve=new WeakSet,Ee=function(){Se(this,ge,this.game.setTimeout(je(this,ye,be).bind(this),this.computeNextMovementTimer()*we(this,fe)))},(e=>{var t;class s extends e{constructor(){super(...arguments),Ne(this,t,{which:0,reuses:0,target:void 0})}reset(e){super.reset(e),we(this,t).which=0,we(this,t).reuses=0,we(this,t).target=void 0}computeDesiredDest(){const e=we(this,t);if(void 0!==e.target&&e.reuses<=O.K._ROBOT_PRIORITY_MAX_REUSES){const t=this._behaviours[e.which].call(this,e.target);if(void 0!==t)return e.reuses++,t.dest}e.reuses=0;for(let t=0;t<this._behaviours.length;t++){const s=this._behaviours[t].call(this);if(void 0!==s)return e.which=t,e.target=s.target,s.dest}throw new Error("never")}}t=new WeakMap,e.Decisive=s,Object.freeze(s),Object.freeze(s.prototype)})(Te||(Te={})),Object.seal(Te),Object.freeze(Te.prototype);var ze=Object.defineProperty,Ae=Object.getOwnPropertySymbols,Ce=Object.prototype.hasOwnProperty,ke=Object.prototype.propertyIsEnumerable,Ie=(e,t,s)=>t in e?ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,Me=(e,t)=>{for(var s in t||(t={}))Ce.call(t,s)&&Ie(e,s,t[s]);if(Ae)for(var s of Ae(t))ke.call(t,s)&&Ie(e,s,t[s]);return e};class Re extends Te.Decisive{constructor(e,t){super(e,t),this.pred=[],this.prey=[],this.params=Object.freeze(Me(Me({},Re.Behaviour.DEFAULT),t.familyArgs)),this.grid=this.game.grid,Object.seal(this),N.R.propNoWrite(this,"params","grid")}_onTeamsBootstrapped(){super._onTeamsBootstrapped(),this.pred=this.game.teams.filter((e=>e.id!==this.teamId)).flatMap((e=>e.members)).seal(),this.prey=[...this.pred].seal(),N.R.propNoWrite(this,"pred","prey")}_bhvrEvadePred(e){if(void 0!==e)return{dest:this.grid.getUntAwayFrom(this.game.players[e].coord,this.coord)};this.pred.sort(((e,t)=>this.grid.dist(e.coord,this.coord)-this.grid.dist(t.coord,this.coord)));for(const e of this.pred){if(this.grid.dist(e.coord,this.coord)>this.params.fearDistance)break;if(!e.isDowned&&e.boosts>this.boosts)return{dest:this.grid.getUntAwayFrom(e.coord,this.coord),target:e.playerId}}}_bhvrChasePrey(e){if(void 0!==e)return{dest:this.game.players[e].coord};if(this.prey.sort(((e,t)=>this.grid.dist(this.coord,e.coord)-this.grid.dist(this.coord,t.coord))),this.isDowned)for(const e of this.prey){if(this.grid.dist(this.coord,e.coord)>this.params.bloodThirstDistance)break;if(e.boosts<this.boosts-this.params.healthReserve)return{dest:e.coord,target:e.playerId}}}_bhvrGotoHealthElseWander(e){if(Math.random()<this.params.wanderingAimlessness)return{dest:this.grid.getRandomCoordAround(this.coord,3)};{const e=this.grid.getUntAwayFrom.bind(this.grid,this.prevCoord);return{dest:this.grid.getRandomCoordAround(e(e(this.coord)),1)}}}getNextMoveType(){return J.MoveType.NORMAL}computeNextMovementTimer(){return 1e3/this.params.keyPressesPerSecond}}(e=>{let t;(t=e.Behaviour||(e.Behaviour={})).DEFAULT=Object.freeze({fearDistance:5,bloodThirstDistance:7,healthReserve:3,keyPressesPerSecond:1.8,wanderingAimlessness:.2})})(Re||(Re={})),Re.prototype._behaviours=Object.freeze([Re.prototype._bhvrEvadePred,Re.prototype._bhvrChasePrey,Re.prototype._bhvrGotoHealthElseWander]),N.R.protoNoEnum(Re,"_onTeamsBootstrapped"),Object.freeze(Re),Object.freeze(Re.prototype);const Pe={Chaser:Re};function _e(e,t){const s=t.familyId;return new Pe[s](e,t)}var xe,We,De,Le,Ge=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},Be=(e,t,s)=>(Ge(e,t,"read from private field"),s?s.call(e):t.get(e)),Ue=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},Fe=(e,t,s,r)=>(Ge(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);function qe(e){const[t,...s]=JSON.parse(e.data),r=e.target;switch(t){case w.IN_GAME:this.requestStateChange(s[0],r);break;case w.PAUSE:this.statusBecomePaused();break;case w.UNPAUSE:this.statusBecomePlaying();break;case w.RETURN_TO_LOBBY:if(r===this.groupHostSocket){this.statusBecomeOver();const e=JSON.stringify([w.RETURN_TO_LOBBY]);this.sockets.forEach((t=>{t!==r&&t.readyState===t.OPEN&&t.send(e)})),this._terminate()}else{const e=JSON.stringify([w.RETURN_TO_LOBBY,g(r)]);this.sockets.forEach((t=>{t!==r&&t.readyState===t.OPEN&&t.send(e)}))}}}class Je extends ue{constructor(e){var t,s;super({impl:{gridClassLookup:te,ClientPlayer:void 0,RobotPlayer:_e,onGameBecomeOver:()=>{}},desc:(J.CtorArgs.finalize(e.gameDesc),e.gameDesc),clientPlayerIds:[]}),Ue(this,De),Ue(this,xe,void 0),Ue(this,We,void 0),this.sockets=new Set(e.sockets),this.groupHostSocket=e.groupHostSocket,Fe(this,xe,e.deleteExternalRefs),N.R.instNoEnum(this,"clientPlayers"),N.R.propNoWrite(this,"sockets","groupHostSocket"),Fe(this,We,qe.bind(this)),Object.seal(this),this.sockets.forEach((e=>{e.addEventListener("message",Be(this,We)),e.addEventListener("close",(()=>{1===this.sockets.size&&this._terminate()}),{once:!0})})),(this,t=De,s=Le,Ge(this,t,"access private method"),s).call(this,e.gameDesc)}get currentClientPlayer(){throw new Error("never")}async reset(){Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===w.UNPAUSE&&t()}),{once:!0})})))).freeze()).then((()=>{this.statusBecomePlaying()}));const e=await super.reset(),t=JSON.stringify([w.RESET,e]);return this.sockets.forEach((e=>{e.readyState===e.OPEN&&e.send(t)})),e}setCurrentClientPlayer(e){}setTimeout(e,t,...s){return setTimeout(e,t,s).unref()}cancelTimeout(e){clearTimeout(e)}statusBecomePlaying(){super.statusBecomePlaying();const e=JSON.stringify([w.UNPAUSE]);this.sockets.forEach((t=>{t.readyState===t.OPEN&&t.send(e)}))}statusBecomePaused(){super.statusBecomePaused();const e=JSON.stringify([w.PAUSE]);this.sockets.forEach((t=>{t.readyState===t.OPEN&&t.send(e)}))}commitStateChange(e,t){if(super.commitStateChange(e,t),e.rejectId){const s=JSON.stringify([w.IN_GAME,e]);null==t||t.send(s)}else{const t=JSON.stringify([w.IN_GAME,e]);this.sockets.forEach((e=>{e.readyState===e.OPEN&&e.send(t)}))}}_terminate(){this.sockets.forEach((e=>{e.removeEventListener("message",Be(this,We))})),Be(this,xe).call(this)}}xe=new WeakMap,We=new WeakMap,De=new WeakSet,Le=function(e){const t=e.players.filter((e=>"Human"===e.familyId)).freeze();Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===w.RESET&&t()}),{once:!0})})))).freeze()).then((()=>this.reset())),this.sockets.forEach((s=>{const r=t.filter((e=>e.socket===s)).map((e=>e.playerId)).freeze(),o=JSON.stringify([E.CREATE_GAME,e,r]);s.readyState===s.OPEN&&s.send(o)}))},N.R.protoNoEnum(Je,"setCurrentClientPlayer","_terminate"),Object.freeze(Je),Object.freeze(Je.prototype);var He,$e,Ke,Ye,Ze,Xe,Ve,Qe,et,tt=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},st=(e,t,s)=>(tt(e,t,"read from private field"),s?s.call(e):t.get(e)),rt=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},ot=(e,t,s,r)=>(tt(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),it=(e,t,s)=>(tt(e,t,"access private method"),s);const at=class extends b{constructor(e){super(),rt(this,Xe),rt(this,Qe),rt(this,He,void 0),this.sockets=new Map,rt(this,$e,void 0),rt(this,Ke,void 0),rt(this,Ye,void 0),rt(this,Ze,void 0),Object.defineProperty(this,"wssBroadcast",{value:e.wssBroadcast}),this.name=e.name,this.passphrase=e.passphrase,N.R.propNoWrite(this,"name","passphrase"),ot(this,He,void 0),ot(this,Ke,e.deleteExternalRefs),ot(this,$e,setTimeout((()=>{0===this.sockets.size&&this.terminate()}),1e3*at.DEFAULT_TTL).unref()),ot(this,Ye,(e=>{const[t,...s]=JSON.parse(e.data);switch(t){case E.UserInfo.NAME:it(this,Xe,Ve).call(this,e.target,s[0]);break;case E.CREATE_GAME:e.target===this.groupHostSocket&&it(this,Qe,et).call(this,s[0])}})),ot(this,Ze,(e=>{if(e.target===this.groupHostSocket||1===this.sockets.size)return void this.terminate();this.sockets.delete(e.target);const t=JSON.stringify([E.UserInfo.NAME,{[g(e.target)]:null}]);this.sockets.forEach(((e,s)=>{s.readyState===s.OPEN&&s.send(t)}))}))}get isCurrentlyPlayingAGame(){return void 0!==st(this,He)}admitSocket(e,t){if(!this.sockets.has(e)){console.info(`socket connect (group):  ${g(e)}`),st(this,He);{const s=E.UserInfo.NAME;{const r=JSON.stringify([s,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>{t.readyState===t.OPEN&&t.send(r)}))}const r={};this.sockets.forEach(((e,t)=>{r[g(t)]=e})),e.send(JSON.stringify([s,r]))}0===this.sockets.size&&(clearTimeout(st(this,$e)),ot(this,$e,void 0),this.groupHostSocket=e,this.wssBroadcast(v.Exist.NAME,{[this.name]:v.Exist.Status.IN_LOBBY})),e.addEventListener("close",st(this,Ze)),e.addEventListener("message",st(this,Ye)),this.sockets.set(e,t)}}kickSocket(e){return!!this.sockets.delete(e)&&(e.removeEventListener("close",st(this,Ze)),e.removeEventListener("message",st(this,Ye)),!0)}_createGameInstance(e){const t=[];return this.isCurrentlyPlayingAGame?(t.push("a game is already in session for this group"),t):(t.push(...ue.CHECK_VALID_CTOR_ARGS(e)),t.length?t:(e.players=[...e.players,...Array.from(this.sockets.keys(),(e=>{const t=this.sockets.get(e);return Object.freeze({socket:e,familyId:"Human",username:t.username,teamId:t.teamId,avatar:t.avatar})}))].freeze(),ot(this,He,new Je({sockets:this.sockets.keys(),groupHostSocket:this.groupHostSocket,deleteExternalRefs:()=>{ot(this,He,void 0)},gameDesc:e})),[]))}terminate(){for(const e of this.sockets.keys())e.removeEventListener("close",st(this,Ze)),e.removeEventListener("message",st(this,Ye));void 0!==st(this,He)&&ot(this,He,void 0),st(this,Ke).call(this),this.wssBroadcast(v.Exist.NAME,{[this.name]:v.Exist.Status.DELETE}),console.info(`terminated group: \`${this.name}\``)}};let nt=at;He=new WeakMap,$e=new WeakMap,Ke=new WeakMap,Ye=new WeakMap,Ze=new WeakMap,Xe=new WeakSet,Ve=function(e,t){if("string"!=typeof t.username||"number"!=typeof t.teamId||"string"!=typeof t.avatar)return void console.info(`bad format: username: \`${t.username}\`, teamId: \`${t.teamId}\`, avatar: \`${t.avatar}\`.`);this.sockets.set(e,t);const s=JSON.stringify([E.UserInfo.NAME,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>{t.readyState===t.OPEN&&t.send(s)}))},Qe=new WeakSet,et=function(e){const t=this._createGameInstance(e);t.length?console.info(t):(this.wssBroadcast(v.Exist.NAME,{[this.name]:v.Exist.Status.IN_GAME}),console.info(`group ${this.name} new game`))},Object.freeze(nt),Object.freeze(nt.prototype);const ht=new Map;function ct(e){ht.delete(e)}function dt(e,t){const s=JSON.stringify([e,t]);ft.clients.forEach((e=>{e.readyState===e.OPEN&&e.send(s)}))}function lt(e){const[t,...s]=JSON.parse(e.data);switch(t){case v.Create.NAME:{let t=function(t){e.target.send(JSON.stringify([v.Create.NAME,t]))};const r=s[0];if(!function(e){return void 0!==e.groupName&&e.groupName.length<=nt.Name.MaxLength&&nt.Name.REGEXP.test(e.groupName)&&e.passphrase.length<=nt.Passphrase.MaxLength&&nt.Passphrase.REGEXP.test(e.passphrase)}(r)||ht.has(r.groupName))return void t(!1);ht.set(r.groupName,new nt(Object.freeze({wssBroadcast:dt,name:r.groupName,passphrase:r.passphrase,deleteExternalRefs:ct.bind(null,r.groupName)}))),t(!0);break}case v.TryJoin.NAME:{let t=function(t){e.target.send(JSON.stringify([v.TryJoin.NAME,t]))};const r=s[0],o=ht.get(r.groupName);if(void 0===o||r.passphrase!==o.passphrase)return void t(!1);const i=r.userInfo;if(void 0===i||0!==i.teamId)throw new Error(`a socket attempted to connect to group \`${o.name}\` without providing userInfo.`);for(const t of ht.values())if(t.kickSocket(e.target))break;o.admitSocket(e.target,i),t(!0);break}}}const mt=r().resolve(__dirname,"../client"),pt=(new(l())).use(p()(mt,{brotli:!0,format:!1,setHeaders:(e,t,s)=>{e.removeHeader("x-powered-by"),e.setHeader("X-Content-Type-Options","nosniff")},maxAge:0,immutable:!1})),ut=c().createServer({},pt.callback()),ft=new(f().Server)({server:ut});ft.on("connection",(function(e,t){const s=JSON.stringify([v.Exist.NAME,(()=>{const e={};for(const[t,s]of ht)e[t]=s.isCurrentlyPlayingAGame?v.Exist.Status.IN_GAME:v.Exist.Status.IN_LOBBY;return e})()]);var r,o;r=e,o=`${Date.now().toString()}_${100*Math.random()%100}`,y.set(r,o),console.info(`socket connect (server): ${g(e)}`),e.send(s),e.addEventListener("message",lt)})),ut.listen({port:443,host:"0.0.0.0"},(function(){const e=ut.address();console.info(`\n\nServer mounted to: \`${e.address}:${e.port}\` using ${e.family}.\nThis host can be reached at any of the following addresses:\n`),gt().sort().forEach((t=>{console.info(`${t}:${e.port}`)})),console.info("")}));const gt=()=>Object.values(n().networkInterfaces()).flat().filter((e=>!e.internal)).map((e=>"IPv6"===e.family?`[${e.address}]`:e.address))})(),capswalk=a})();
//# sourceMappingURL=index.js.map