var capswalk;(()=>{var e,t,s,r={164:(e,t,s)=>{"use strict";s.d(t,{R:()=>i});const r=Object.freeze({enumerable:!1}),o=Object.freeze({writable:!1});var i;!function(e){function t(e){for(const s of Object.getOwnPropertyNames(e)){const r=e[s];null!==r&&"object"==typeof r&&t(r)}Object.freeze(e)}function s(e,t,...s){for(const r of s)Object.defineProperty(t,r,e)}let i;var a;e.deepFreeze=function(e){return t(e),e},e.hasProp=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.protoNoEnum=function(e,...t){Object.getOwnPropertyNames(e.prototype).freeze(),t.forEach((t=>{Object.defineProperty(e.prototype,t,r)}))},e.instNoEnum=s.bind(null,r),e.propNoWrite=s.bind(null,o),e.camelCaseTransforms=function(e){const t=e.replace(/[A-Z]/g,(e=>" "+e.toLowerCase()));return Object.freeze({spaceyLowercase:t,spaceyUppercase:t.toUpperCase(),spaceyCapitalized:t.split(" ").map((e=>e.charAt(0).toUpperCase()+e.substring(1))).join(" ")})},(a=i=e.Web||(e.Web={})).prependComment=function(e,t){e.parentNode.insertBefore(document.createComment(" "+t+" "),e)},a.adoptStyleSheet=function(t,s){t.appendChild(e.html("link",[],{rel:"stylesheet",href:s}))},a._makeSmartStorage=function(e,t,s){const r={};return Object.keys(s).forEach((e=>{const s=""+e;Object.defineProperty(r,e,{enumerable:!0,get:()=>{const e=t.getItem(s);return null===e?void 0:JSON.parse(e)},set:e=>{t.setItem(s,JSON.stringify(e))}})})),r},e.html=function(e,t,s){const r=document.createElement(e);try{Object.seal(r)}catch(e){}return(null==t?void 0:t.length)&&r.classList.add(...t),"button"===e?r.type="button":"a"===e&&(r.rel="noopener"),void 0!==s&&Object.assign(r,s),r},e.svg=function(e,t,s){const r=document.createElementNS("http://www.w3.org/2000/svg",e);return Object.seal(r),(null==t?void 0:t.length)&&r.classList.add(...t),void 0!==s&&Object.assign(r,s),r}}(i||(i={})),Object.freeze(i)},387:()=>{Object.defineProperties(Array.prototype,{freeze:{value:function(){return Object.freeze(this)},enumerable:!0},seal:{value:function(){return Object.seal(this)},enumerable:!0}}),["Object","String","Number","RegExp","Date","Array","Map","Set","WeakMap","WeakSet"].forEach((e=>{Object.defineProperty(globalThis,e,{enumerable:!0,writable:!1,configurable:!1}),Object.freeze(globalThis[e]),Object.freeze(globalThis[e].prototype)}))},139:(e,t,s)=>{"use strict";s.d(t,{Uo:()=>h,J5:()=>n});var r=s(164);const o=Object.freeze({IDENT:e=>e,LOWER:e=>e.toLowerCase()}),i={"engl-low":{module:"English",export:"Lowercase",isolatedMinOpts:25,remapFunc:o.LOWER,displayName:"English Lowercase (qwerty)",blurb:""},"engl-mix":{module:"English",export:"MixedCase",isolatedMinOpts:51,remapFunc:o.IDENT,displayName:"English Mixed-Case (Querty)",blurb:""},"japn-hir":{module:"Japanese",export:"Hiragana",isolatedMinOpts:70,remapFunc:o.LOWER,displayName:"Japanese Hiragana",blurb:""},"japn-kat":{module:"Japanese",export:"Katakana",isolatedMinOpts:68,remapFunc:o.LOWER,displayName:"Japanese Katakana",blurb:""},"kore-dub":{module:"Korean",export:"Dubeolsik",isolatedMinOpts:8690,remapFunc:o.IDENT,displayName:"Korean Dubeolsik (두벌식 키보드)",blurb:"The most common keyboard layout, and South Korea's only Hangul standard since 1969. Consonants are on the left, and vowels on the right."},"kore-sub":{module:"Korean",export:"Sebeolsik",isolatedMinOpts:10179,remapFunc:o.IDENT,displayName:"Korean Sebeolsik (세벌식 최종 키보드)",blurb:"Another Hangul keyboard layout used in South Korea, and the final Sebeolsik layout designed by Dr. Kong Byung Woo, hence the name. Syllable-initial consonants are on the right, final consonants on the left, and vowels in the middle. It is more ergonomic than the dubeolsik, but not widely used."},"kore-rom":{module:"Korean",export:"Romanization",isolatedMinOpts:3960,remapFunc:o.LOWER,displayName:"Korean Revised Romanization",blurb:"The Revised Romanization of Korean (국어의 로마자 표기법; 國語의 로마字 表記法) is the official South Korean language romanization system. It was developed by the National Academy of the Korean Language from 1995, and was released on 7 July 2000 by South Korea's Ministry of Culture and Tourism"},"engl-cell-enc":{module:"English",export:"OldCellphone.Encode",isolatedMinOpts:7,remapFunc:o.IDENT,displayName:"Old Cellphone Keyboard",blurb:""},"mors-enc":{module:"English",export:"Morse.Encode",isolatedMinOpts:10,remapFunc:e=>e,displayName:"Morse Encoder",blurb:""},"mors-dec":{module:"English",export:"Morse.Decode",isolatedMinOpts:40,remapFunc:o.LOWER,displayName:"Morse Decoder",blurb:""},ngram2:{module:"Ngrams",export:"Ngram2",isolatedMinOpts:199,remapFunc:o.LOWER,displayName:"English Bigrams",blurb:""},ngram3:{module:"Ngrams",export:"Ngram3",isolatedMinOpts:400,remapFunc:o.LOWER,displayName:"English Trigrams",blurb:""},numpad:{module:"Numpad",export:"Numpad",isolatedMinOpts:100,remapFunc:o.LOWER,displayName:"Number Pad",blurb:""}};Object.entries(i).forEach((([e,t])=>{t.id=e})),r.R.deepFreeze(i);const a=i;Object.freeze({behavior:"smooth",block:"center",inline:"center"});class n{}!function(e){let t,s;var r;let o;e.Family=Object.freeze({HUMAN:"HUMAN",CHASER:"CHASER"}),e.Family,(t=e.Id||(e.Id={})).NULL=-1,(r=s=e.Username||(e.Username={})).REGEXP=/[ a-zA-Z0-9:-]+/,r.MAX_LENGTH=15,(o=e.Avatar||(e.Avatar={})).LOREM_IPSUM="lorem-ipsum",function(e){const t=Object.values(e).filter((e=>"string"==typeof e));e.GET_RANDOM=function(){return t[Math.floor(Math.random()*t.length)]}}(o=e.Avatar||(e.Avatar={}))}(n||(n={})),Object.freeze(n);class h{}!function(e){let t,s,r;(t=e.Seq||(e.Seq={})).REGEXP=new RegExp("^[a-zA-Z0-9!@#$%^&*()-_=+;:'\"\\|,.<>/?]+$"),(s=e.CharSeqPair||(e.CharSeqPair={})).NULL=Object.freeze({char:"",seq:""}),(r=e.WeightExaggeration||(e.WeightExaggeration={})).MAX=4,e.CHAR_HIT_COUNT_SEED_CEILING=5,e.FrontendDescs=a,e.GET_FRONTEND_DESC_BY_ID=function(t){return e.FrontendDescs[t]}}(h||(h={})),Object.freeze(h),Object.freeze(h.prototype)},208:(e,t,s)=>{"use strict";s.d(t,{U:()=>c});var r,o=s(164),i=s(139),a=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},n=(e,t,s)=>(a(e,t,"read from private field"),s?s.call(e):t.get(e));!function(e){var t;const s=class{constructor(e,s="",r){var o,i,n;t.set(this,[]),this.carryHits=0,Object.defineProperty(this,"parent",{enumerable:!0,value:e}),Object.defineProperty(this,"seq",{enumerable:!0,value:s}),Object.defineProperty(this,"children",{enumerable:!0,value:[]}),o=this,i=t,n=Object.freeze(r),a(o,i,"write to private field"),i.set(o,n),Object.seal(this)}get ownHits(){var e,t;return this.carryHits-(null!=(t=null==(e=this.parent)?void 0:e.carryHits)?t:0)}reset(){this.carryHits=0;for(const e of this.children)e.reset();for(const e of n(this,t))e.reset(),this.incrHits(e,Math.random()*i.Uo.CHAR_HIT_COUNT_SEED_CEILING)}getLeaves(){const e=[];return this._rGetLeaves(e),e.freeze()}_rGetLeaves(e){if(this.children.length)for(const t of this.children)t._rGetLeaves(e);else e.push(this)}chooseOnePair(){let e=n(this,t)[0];for(const s of n(this,t))s.hits<e.hits&&(e=s);const s={char:e.char,seq:this.seq};return this.incrHits(e),s}incrHits(e,t=1){e._incrementNumHits(),this._rIncrHits(e.weightInv*t)}_rIncrHits(e){this.carryHits+=e;for(const t of this.children)t._rIncrHits(e)}static CREATE_TREE_MAP(t,r){const o=e.GET_SCALE_WEIGHT_FUNC(r,t),i=new Map;Object.entries(t).freeze().forEach((([e,{seq:t,weight:s}])=>{const r=new h(e,o(s)),a=i.get(t);void 0!==a?a.push(r):i.set(t,[r])}));const a=[];let n;for(const[e,t]of Array.from(i).seal().sort((([e],[t])=>e<t?-1:1)).freeze()){for(;void 0!==n&&!e.startsWith(n.seq);)n=n.parent;const r=new s(n,e,t);void 0!==n?n.children.push(r):a.push(r),n=r}return a.freeze()}};let r=s;function c(e,t){if(0===e)return()=>1;if(1===e)return e=>e;const s=Object.values(t),r=s.reduce(((e,t)=>e+t.weight),0)/s.length;return t=>Math.pow(t/r,e)}t=new WeakMap,r.LEAF_CMP=(e,t)=>e.carryHits-t.carryHits,e.Node=r,o.R.protoNoEnum(r,"_rGetLeaves","_rIncrHits"),Object.freeze(r),Object.freeze(r.prototype),e.GET_SCALE_WEIGHT_FUNC=c,Object.freeze(c)}(r||(r={})),Object.freeze(r);class h{constructor(e,t){this.char=e,this.hits=0,this.char=e,Object.defineProperty(this,"weightInv",{enumerable:!0,value:1/t}),Object.seal(this)}reset(){this.hits=0}_incrementNumHits(){this.hits+=this.weightInv}}Object.freeze(h),Object.freeze(h.prototype);class c extends i.Uo{constructor(e,t){super(),this.frontendDesc=c.GET_FRONTEND_DESC_BY_ID(e),this.treeRoots=r.Node.CREATE_TREE_MAP(Object.getPrototypeOf(this).constructor.BUILD(),t);const s=this.treeRoots.map((e=>e.getLeaves()));this.leafNodes=s.flat(),this.isolatedMinOpts=s.map((e=>e.length)).sort().slice(0,-1).reduce(((e,t)=>e+t),0),o.R.propNoWrite(this,"frontendDesc","treeRoots","leafNodes","isolatedMinOpts"),Object.seal(this)}reset(){for(const e of this.treeRoots)e.reset()}getNonConflictingChar(e){this.leafNodes.sort(r.Node.LEAF_CMP);e:for(const t of this.leafNodes){let s=t;for(let r=t;void 0!==r;r=r.parent){const t=e.find((e=>e.startsWith(r.seq)));if(t){if(t.length>r.seq.length)break;continue e}r.ownHits<s.ownHits&&(s=r)}return s.chooseOnePair()}throw new Error("never")}}!function(e){let t;(t=e.BuildUtils||(e.BuildUtils={})).WORD_FOR_WORD=function(e){return Object.entries(e).freeze().reduce(((e,[t,s])=>(e[t]={seq:t,weight:s},e)),{})}}(c||(c={})),Object.freeze(c),Object.freeze(c.prototype)},59:(e,t,s)=>{var r={"./Chinese.ts":[83,7,330],"./Emote.ts":[985,9,858],"./English.ts":[825,9,184],"./Japanese.ts":[885,9,410],"./Korean.ts":[969,9,227],"./Ngrams.ts":[755,9,273],"./Numpad.ts":[444,9,683],"./Shell.ts":[25,9,159],"./defs/Chinese.ts":[711,7,704],"./defs/English100.ts":[589,9,885]};function o(e){if(!s.o(r,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],o=t[0];return s.e(t[2]).then((()=>s.t(o,16|t[1])))}o.keys=()=>Object.keys(r),o.id=59,e.exports=o}},o={};function i(e){if(o[e])return o[e].exports;var t=o[e]={exports:{}};return r[e](t,t.exports,i),t.exports}i.m=r,i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var o=Object.create(null);i.r(o);var a={};e=e||[null,t({}),t([]),t(t)];for(var n=2&r&&s;"object"==typeof n&&!~e.indexOf(n);n=t(n))Object.getOwnPropertyNames(n).forEach((e=>a[e]=()=>s[e]));return a.default=()=>s,i.d(o,a),o},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,s)=>(i.f[s](e,t),t)),[])),i.u=e=>"chunk/"+{159:"lang/Shell-ts",184:"lang/English-ts",227:"lang/Korean-ts",273:"lang/Ngrams-ts",330:"lang/Chinese-ts",410:"lang/Japanese-ts",683:"lang/Numpad-ts",704:"lang/defs-Chinese-ts",858:"lang/Emote-ts",885:"lang/defs-English100-ts"}[e]+".js",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s={826:1},i.f.require=function(e,t){s[e]||(e=>{var t=e.modules,r=e.ids,o=e.runtime;for(var a in t)i.o(t,a)&&(i.m[a]=t[a]);o&&o(i);for(var n=0;n<r.length;n++)s[r[n]]=1})(require("./"+i.u(e)))};var a={};(()=>{"use strict";i.r(a),i.d(a,{chooseIPAddress:()=>Le,wss:()=>ke}),i(387);const e=require("os");var t=i.n(e);const s=require("fs");var r=i.n(s);const o=require("path");var n=i.n(o);const h=require("http");var c=i.n(h);const d=require("express");var l=i.n(d);const u=require("express-static-gzip");var m=i.n(u);const p=require("ws");var f=i.n(p);function g(e){if(E.has(e))return E.get(e);throw new Error("never")}const E=new WeakMap;class O{}var y,b,v,N;!function(e){let t;var s;let r;var o;(s=t=e.Name||(e.Name={})).REGEXP=/^(?:[a-zA-Z0-9:-]+)$/,s.MaxLength=30,(o=r=e.Passphrase||(e.Passphrase={})).REGEXP=/^(?:[a-zA-Z0-9:-]*)$/,o.MaxLength=30,e.GameServerReconnectionAttempts=2,e.DEFAULT_TTL=20}(O||(O={})),Object.freeze(O),Object.freeze(O.prototype),function(e){let t,s,r;(t=e.Create||(e.Create={})).NAME="joiner/create",function(e){let t;var s;e.NAME="joiner/exist",(s=t=e.Status||(e.Status={})).IN_LOBBY="in-lobby",s.IN_GAME="in-game",s.DELETE="delete"}(s=e.Exist||(e.Exist={})),(r=e.TryJoin||(e.TryJoin={})).NAME="joiner/try-join"}(y||(y={})),Object.freeze(y),function(e){let t;(t=e.UserInfo||(e.UserInfo={})).NAME="group/user-info-change",e.CREATE_GAME="group/create-game"}(b||(b={})),Object.freeze(b),(N=v||(v={})).RESET="game/reset",N.UNPAUSE="game/unpause",N.PAUSE="game/pause",N.IN_GAME="game/ingame",N.RETURN_TO_LOBBY="game/return-to-lobby";var w,_=i(164),S=i(208);!function(e){let t;var s;(s=t=e.Status||(e.Status={})).PLAYING="PLAYING",s.PAUSED="PAUSED",s.OVER="OVER",Object.freeze(t),e.K=Object.freeze({_HEALTH_UPDATE_CHANCE:.1,AVERAGE_HEALTH_TO_SPAWN_ON_TILE:1,PORTION_OF_MOVES_THAT_ARE_BOOST:.4,_HEALTH_COST_OF_BOOST(e,t){const s=t(this.AVERAGE_HEALTH_TO_SPAWN_ON_TILE/e);return this.AVERAGE_HEALTH_TO_SPAWN_ON_TILE/s/this.PORTION_OF_MOVES_THAT_ARE_BOOST},HEALTH_EFFECT_FOR_DOWNED_PLAYER:.6,_REQUEST_BUFFER_LENGTH:5,_ROBOT_PRIORITY_MAX_REUSES:4})}(w||(w={})),Object.freeze(w);var T,A=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},I=(e,t,s,r)=>(A(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class j{constructor(){T.set(this,0),this.length=0}get lastRejectId(){return A(this,e=T,"read from private field"),e.get(this);var e}reset(e){I(this,T,0),this.length=0,this.predictedCoord=e}get isFull(){return this.length===w.K._REQUEST_BUFFER_LENGTH}signRequest(e){return this.length++,this.predictedCoord=e.moveDest,e}getNextRejectId(){return(this.lastRejectId+Math.floor(99*Math.random()))%100}reject(e,t){I(this,T,e),this.length=0,this.predictedCoord=t}acceptOldest(){this.length--}}T=new WeakMap,Object.freeze(j),Object.freeze(j.prototype);var M=i(139);class C{constructor(e,t){if(this.id=e,this.members=t,this.elimOrder=C.ElimOrder.STANDING,_.R.propNoWrite(this,"id","members"),Object.seal(this),0===t.length)throw new Error("Teams must have at least one member.")}reset(){this.elimOrder=C.ElimOrder.STANDING}}!function(e){let t;(t=e.ElimOrder||(e.ElimOrder={})).STANDING=0}(C||(C={})),Object.freeze(C),Object.freeze(C.prototype);var R,z,k=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},P=(e,t,s)=>(k(e,t,"read from private field"),s?s.call(e):t.get(e)),L=(e,t,s,r)=>(k(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const D=class extends M.J5{constructor(e,t){super(),R.set(this,void 0),z.set(this,0),this.prevCoord=void 0,this.playerId=t.playerId,this.familyId=t.familyId,this.teamId=t.teamId,this.username=t.username,this.avatar=t.avatar,this.game=e,this.reqBuffer=new j,_.R.instNoEnum(this,"game"),_.R.propNoWrite(this,"game","playerId","familyId","teamId","username","avatar","reqBuffer"),new.target===D&&Object.seal(this)}get team(){return this.game.teams[this.teamId]}get coord(){return P(this,R)}get health(){return P(this,z)}get isDowned(){return this.health<0}isTeamedWith(e){return this.team.members.includes(e)}onTeamsBootstrapped(){}reset(e){L(this,R,e),this.prevCoord=e,this.game.grid.write(e,{occId:this.playerId}),L(this,z,0),this.reqBuffer.reset(e)}onGamePlaying(){}onGamePaused(){}onGameOver(){}makeMovementRequest(e,t){this.reqBuffer.isFull||this.game.processMoveRequest(this.reqBuffer.signRequest({initiator:this.playerId,lastRejectId:this.reqBuffer.lastRejectId,moveType:t,moveDest:e}))}setCoord(e){this.prevCoord=this.coord,L(this,R,e)}set health(e){const t=this.isDowned;if(L(this,z,e),t||!this.isDowned)return;const s=this.team,r=this.game.teams;if(s.elimOrder===C.ElimOrder.STANDING&&s.members.every((e=>e.isDowned))){const e=1+r.filter((e=>e.elimOrder!==C.ElimOrder.STANDING)).length;s.elimOrder=1+r.filter((e=>e.elimOrder!==C.ElimOrder.STANDING)).length,e===r.length&&this.game.statusBecomeOver()}}};let x=D;R=new WeakMap,z=new WeakMap,function(e){let t;e.MoveType=Object.freeze({NORMAL:"NORMAL",BOOST:"BOOST"}),e.MoveType,(t=e.CtorArgs||(e.CtorArgs={})).finalize=function(t){const s=t.players,r=Array.from(new Set(s.map((e=>e.teamId)))).sort(((e,t)=>e-t)).reduce(((e,t,s)=>(e[t]=s,e)),[]);t.players=s.slice().sort(((e,t)=>r[e.teamId]-r[t.teamId])).freeze().map(((t,s)=>{var o;return Object.assign({},t,{playerId:s,teamId:r[t.teamId],avatar:null!=(o=t.avatar)?o:e.Avatar.GET_RANDOM()})})).freeze()},Object.freeze(t)}(x||(x={})),_.R.protoNoEnum(x,"onGamePlaying","onGamePaused","onGameOver","onTeamsBootstrapped"),Object.freeze(x),Object.freeze(x.prototype);var H,U,G=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},B=(e,t,s)=>(G(e,t,"read from private field"),s?s.call(e):t.get(e)),F=(e,t,s,r)=>(G(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class W{constructor(e,t){H.set(this,0),this.tiles=new Map;const s=w.K._HEALTH_COST_OF_BOOST(e.averageHealthPerTile,t.getLatticePatchDiameter);this.K=Object.freeze({avg:e.averageHealthPerTile*t.getArea(e.gridDimensions),avgPerTile:e.averageHealthPerTile,costOfBoost:e=>s/e.seq.length}),_.R.propNoWrite(this,"K"),Object.seal(this)}get currentAmount(){return B(this,H)}reset(){F(this,H,0),this.tiles.clear()}add(e){F(this,H,B(this,H)+e)}}H=new WeakMap,Object.freeze(W),Object.freeze(W.prototype);class q{constructor(e){const t=[];for(const s of e)t[s]=new q.Entry;this.entries=t,_.R.propNoWrite(this,"entries"),Object.seal(this)}reset(){for(const e of this.entries)e.reset()}}!function(e){class t{constructor(){this.moveCounts={}}reset(){this.totalHealthPickedUp=0,Object.getOwnPropertyNames(x.MoveType).forEach((e=>{this.moveCounts[e]=0}))}}e.Entry=t,Object.freeze(t),Object.freeze(t.prototype)}(q||(q={})),Object.freeze(q),Object.freeze(q.prototype);class J{constructor(e){Object.freeze(e),this.static=e.Grid,this.dimensions=e.dimensions,this.area=e.Grid.getArea(e.dimensions),_.R.propNoWrite(this,"static","dimensions")}reset(){this.forEach((e=>{this.write(e.coord,{occId:M.J5.Id.NULL,char:"",seq:"",health:0})}))}getAllAltDestsThan(e){return Array.from(new Set(this.tileSourcesTo(e).flatMap((e=>this.tileDestsFrom(e.coord)))))}getRandomCoord(){return this.static.getRandomCoord(this.dimensions)}static getSpawnCoords(e,t){const s=new Set;return e.map((e=>{const r=[];for(;e>0;){let o;do{o=this.getRandomCoord(t)}while(s.has(o));r.push(o),s.add(o),e--}return r.freeze()})).freeze()}}(U=J||(J={}))._Constructors={W_EUCLID2:void 0,BEEHIVE:void 0},U.getImplementation=e=>U._Constructors[e],Object.freeze(J),Object.freeze(J.prototype);var K,Y,$,X,V,Z=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},Q=(e,t,s)=>(Z(e,t,"read from private field"),s?s.call(e):t.get(e)),ee=(e,t,s,r)=>(Z(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class te{constructor(e){K.set(this,void 0),Y.set(this,void 0),$.set(this,void 0);const{impl:t,desc:s,operatorIds:r}=e;Object.freeze(s),Object.freeze(s.players),s.players.forEach((e=>Object.freeze(e))),Object.freeze(r);const o=t.gridClassLookup(s.coordSys);this.grid=new o({Grid:o,system:s.coordSys,dimensions:s.gridDimensions,players:s.players}),ee(this,K,t.onGameBecomeOver),this.langFrontend=M.Uo.GET_FRONTEND_DESC_BY_ID(s.langId);const i=this._createPlayers(s,t,r);this.players=i.players,this.operators=i.operators;{const e=[];this.players.forEach((t=>{e[t.teamId]||(e[t.teamId]=[]),e[t.teamId].push(t)})),this.teams=e.map(((e,t)=>new C(t,e)))}_.R.propNoWrite(this,"grid","langFrontend","players","operators","teams"),this.players.forEach((e=>e.onTeamsBootstrapped())),this.setCurrentOperator(0)}reset(){this.grid.reset(),ee(this,$,w.Status.PAUSED)}_createPlayers(e,t,s){const r=e.players.map((e=>e.familyId===x.Family.HUMAN?s.includes(e.playerId)?new t.OperatorPlayer(this,e):new x(this,e):t.RobotPlayer(this,e))).freeze();return Object.freeze({players:r,operators:s.map((e=>r[e])).freeze()})}deserializeResetState(e){_.R.deepFreeze(e),this.grid.forEach(((t,s)=>{this.grid.write(t.coord,e.csps[s])})),e.playerCoords.forEach(((e,t)=>{this.players[t].reset(e)}))}get currentOperator(){return Q(this,Y)}setCurrentOperator(e){const t=this.operators[e];if(void 0===t)throw new Error("never");this.currentOperator!==t&&ee(this,Y,t)}get status(){return Q(this,$)}statusBecomePlaying(){if(this.status!==w.Status.PLAYING){if(this.status!==w.Status.PAUSED)throw new Error("Can only resume a game that is currently paused.");this.players.forEach((e=>{e.onGamePlaying()})),ee(this,$,w.Status.PLAYING)}else console.info("[statusBecomePlaying]: Game is already playing")}statusBecomePaused(){this.status!==w.Status.PAUSED?this.status!==w.Status.OVER&&(this.players.forEach((e=>{e.onGamePaused()})),ee(this,$,w.Status.PAUSED)):console.info("[statusBecomePaused]: Game is already paused")}statusBecomeOver(){this.status!==w.Status.OVER&&(this.players.forEach((e=>{e.onGameOver()})),ee(this,$,w.Status.OVER),Q(this,K).call(this),console.info("game is over!"))}commitTileMods(e,t,s=!0){const r=this.grid.tileAt(e);void 0!==t.seq&&s&&this.operators.forEach((e=>{this.grid.tileDestsFrom(e.coord).includes(r)&&e.seqBufferAcceptKey(void 0)})),this.grid.write(e,t)}commitStateChange(e,t){_.R.deepFreeze(e);const s=this.players[e.initiator];void 0===e.rejectId?(Object.entries(e.tiles).freeze().forEach((([e,t])=>{this.commitTileMods(parseInt(e),t)})),Object.entries(e.players).freeze().forEach((([e,t])=>{const s=this.players[parseInt(e)];s.reqBuffer.acceptOldest(),s.health=t.health,void 0!==t.coord&&(this.grid.write(s.coord,{occId:x.Id.NULL}),this.grid.write(t.coord,{occId:s.playerId}),s.setCoord(t.coord))}))):s.reqBuffer.reject(e.rejectId,s.coord)}}K=new WeakMap,Y=new WeakMap,$=new WeakMap,_.R.protoNoEnum(te,"_createPlayers"),Object.freeze(te),Object.freeze(te.prototype);class se{constructor(e,t){this.x=e,this.y=t,Object.freeze(this)}static from(e,t){return new se(t%e.width,Math.floor(t/e.width))}toCoord(e){return this.y*e.width+this.x}static distX(e,t,s){let r=Math.abs(t.x-s.x);return r<e.width/2?{dist:r,wrap:!1}:{dist:e.width-r,wrap:!0}}static distY(e,t,s){let r=Math.abs(t.y-s.y);return r<e.height/2?{dist:r,wrap:!1}:{dist:e.height-r,wrap:!0}}static oneNorm(e,t,s){const r=se.distX(e,t,s),o=se.distY(e,t,s);return{norm:r.dist+o.dist,wrapX:r.wrap,wrapY:o.wrap}}static infNorm(e,t,s){const r=se.distX(e,t,s),o=se.distY(e,t,s);return{norm:Math.max(r.dist,o.dist),wrapX:r.wrap,wrapY:o.wrap}}static axialAlignment(e,t,s){const r=se.from(e,t),o=se.from(e,s),i=se.distX(e,r,o),a=se.distY(e,r,o);return Math.abs(i.dist-a.dist)/(i.dist+a.dist)}add(e){return new se(this.x+e.x,this.y+e.y)}sub(e){return new se(this.x-e.x,this.y-e.y)}iSub(e){return this.add(this.sub(e))}mul(e){return new se(e*this.x,e*this.y)}mod(e){let{x:t,y:s}=this;for(;t<0;)t+=e.width;for(;s<0;)s+=e.height;return t%=e.width,s%=e.height,new se(t,s)}}Object.freeze(se),Object.freeze(se.prototype),function(e){const t=class extends J{constructor(e){super(e);const s=[];for(let e=0;e<this.dimensions.height;e++)for(let t=0;t<this.dimensions.width;t++){const r={coord:e*this.dimensions.width+t,occId:M.J5.Id.NULL,health:0,seq:""};s.push(r)}this._grid=s.seal();const r=[];for(let t=0;t<e.dimensions.height;t++)for(let s=0;s<e.dimensions.width;s++)r.push(new se(s,t));this.iacCache=r.freeze(),_.R.instNoEnum(this,"iacCache"),_.R.propNoWrite(this,"_grid","iacCache"),new.target===t&&Object.seal(this)}write(e,t){this._grid[e]=Object.freeze(Object.assign(Object.create(null),this._grid[e],t))}forEach(e){this._grid.forEach(e)}forEachShuffled(e){const t=new Array(this.area);for(let e=0;e<this.area;e++)t[e]=e;t.sort(((e,t)=>Math.random()-.5)).freeze();for(const s of t)e(this._grid[s],s)}getUntToward(e,t){const s=this.tileDestsFrom(t).filter((e=>e.occId===M.J5.Id.NULL)).map((t=>{const s=this.iacCache[t.coord],r=this.iacCache[e];return{tile:t,iac:s,infNorm:se.infNorm(this.dimensions,s,r).norm,oneNorm:se.oneNorm(this.dimensions,s,r).norm}}));if(0===s.length)return this.tileAt(t);s.sort(((e,t)=>e.infNorm-t.infNorm)),s.length=3,s.sort(((e,t)=>e.oneNorm-t.oneNorm));const r=s[0];for(let e=1;e<s.length;e++)if(s[e].infNorm>r.infNorm){s.splice(e);break}if(1===s.length)return r.tile;if(r.infNorm===r.oneNorm){if(se.axialAlignment(this.dimensions,t,e)>.5)return r.tile;s.shift()}return s[Math.floor(s.length*Math.random())].tile}getUntAwayFrom(e,t){const s=this.iacCache[e],r=this.iacCache[t].iSub(s).mod(this.dimensions);return this._grid[r.toCoord(this.dimensions)]}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){const s=this.iacCache[e];return new se(s.x+Math.trunc(2*t*(Math.random()-.5)),s.y+Math.trunc(2*t*(Math.random()-.5))).mod(this.dimensions).toCoord(this.dimensions)}dist(e,t){return se.infNorm(this.dimensions,this.iacCache[e],this.iacCache[t]).norm}tileAt(e){return this._grid[e]}tileDestsFrom(e,t=1){const s=this.iacCache[e];let r=!1,o=!1;const i=this.dimensions.width,a=this.dimensions.height;let n=s.y-t;n<0&&(n+=a,o=!0);let h=s.x-t;h<0&&(h+=i,r=!0);let c=s.y+t+1;c>a&&(c-=a,o=!0);let d=s.x+t+1;d>i&&(d-=i,r=!0);const l=[];if(r){const e=n*i;l.push(...this._grid.slice(e,e+d)),o&&l.push(...this._grid.slice(0,d))}const u=o?a:c,m=2*t+1;for(let e=n;e<u;e++){const t=e*i+h;l.push(...this._grid.slice(t,t+m))}if(r&&!o&&(l.length-=d),o){for(let e=0;e<c;e++){const t=e*i+h;l.push(...this._grid.slice(t,t+m))}r&&(l.length-=d)}return l.freeze()}tileSourcesTo(e,t=1){return this.tileDestsFrom(e,t)}static getArea(e){return e.height*e.width}static getLatticePatchDiameter(e){return Math.sqrt(e)}static getRandomCoord(e){const t=Math.floor(e.width*Math.random());return Math.floor(e.height*Math.random())*e.width+t}};let s=t;s.ambiguityThreshold=24,s.SIZE_LIMITS=_.R.deepFreeze({height:{min:10,max:51},width:{min:10,max:51}}),s.sizeLimits=t.SIZE_LIMITS,e.Grid=s,s.prototype.tileSourcesTo=s.prototype.tileDestsFrom,_.R.protoNoEnum(s,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(s),Object.freeze(s.prototype)}(X||(X={})),Object.freeze(X);class re{constructor(e){this.dash=e.dash,this.bash=e.bash,Object.freeze(this)}toCoord(){}round(){const e=Math.floor(this.dash),t=Math.floor(this.bash),s=e-this.dash,r=t-this.bash;return s>2*r?new re({dash:e+1,bash:t}):s<.5*r?new re({dash:e,bash:t+1}):Math.min(s,r)>.5?new re({dash:e+1,bash:t+1}):new re({dash:e,bash:t})}add(e){return new re({dash:this.dash+e.dash,bash:this.bash+e.bash})}sub(e){return new re({dash:this.dash-e.dash,bash:this.bash-e.bash})}mul(e){return new re({dash:e*this.dash,bash:e*this.bash})}}Object.freeze(re),Object.freeze(re.prototype),function(e){const t=class extends J{constructor(e){super(e),this.grid=(void 0).freeze(),new.target===t&&Object.seal(this)}write(e,t){}forEach(e){let t=0;for(const s of this.grid)for(const r of s)e(r,t++)}forEachShuffled(e){}getUntToward(e,t){}getUntAwayFrom(e,t){}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){}dist(e,t){}tileAt(e){}tileDestsFrom(e,t=1){return[].freeze()}tileSourcesTo(e,t=1){}static getArea(e){const t=Math.min(e.fslash,e.bslash),s=Math.max(e.fslash,e.bslash),r=-1+e.dash+t;let o=2*t*(e.dash+r);return o+=(s-t-1)*r,o}static getLatticePatchDiameter(e){if(e<.25)throw new RangeError("determinant of a radical will be strictly negative.");return 1+(-3+Math.sqrt(9-12*(1-e)))/6*2}static getRandomCoord(e){return new re(void 0).toCoord()}};let s=t;s.ambiguityThreshold=18,s.SIZE_LIMITS=_.R.deepFreeze({dash:{min:10,max:50},bslash:{min:10,max:50},fslash:{min:10,max:50}}),s.sizeLimits=t.SIZE_LIMITS,e.Grid=s,_.R.protoNoEnum(s,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(s),Object.freeze(s.prototype)}(V||(V={})),Object.freeze(V);var oe=(e,t,s)=>(((e,t,s)=>{if(!t.has(e))throw TypeError("Cannot read from private field")})(e,t),s?s.call(e):t.get(e));class ie extends x{constructor(e,t){super(e,t),this._nextMovementTimerMultiplier=void 0,this._scheduledMovementCallbackId=void 0}onGamePlaying(){super.onGamePlaying(),this._delayedMovementContinue()}onGamePaused(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}onGameOver(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}_movementContinue(){const e=this.computeDesiredDest();this._nextMovementTimerMultiplier=this.game.grid.tileAt(e).seq.length,this.makeMovementRequest(this.game.grid.getUntToward(e,this.coord).coord,this.getNextMoveType()),this._delayedMovementContinue()}_delayedMovementContinue(){this._scheduledMovementCallbackId=this.game.setTimeout(this._movementContinue.bind(this),this.computeNextMovementTimer()*this._nextMovementTimerMultiplier)}}!function(e){var t;e._Constructors={CHASER:void 0},e.of=(t,s)=>{const r=s.familyId;return new e._Constructors[r](t,s)};class s extends e{constructor(){super(...arguments),t.set(this,{which:0,reuses:0,target:void 0})}reset(e){super.reset(e),oe(this,t).which=0,oe(this,t).reuses=0,oe(this,t).target=void 0}computeDesiredDest(){const e=oe(this,t);if(void 0!==e.target&&e.reuses<=w.K._ROBOT_PRIORITY_MAX_REUSES){const t=this._behaviours[e.which].call(this,e.target);if(void 0!==t)return e.reuses++,t.dest}e.reuses=0;for(let t=0;t<this._behaviours.length;t++){const s=this._behaviours[t].call(this);if(void 0!==s)return e.which=t,e.target=s.target,s.dest}throw new Error("never")}}t=new WeakMap,e.Decisive=s,Object.freeze(s),Object.freeze(s.prototype)}(ie||(ie={})),_.R.protoNoEnum(ie,"_movementContinue"),Object.seal(ie),Object.freeze(ie.prototype);class ae extends ie.Decisive{constructor(e,t){super(e,t),this.pred=[],this.prey=[],this.params=Object.freeze(Object.assign({},ae.Behaviour.DEFAULT,t.familyArgs)),this.grid=this.game.grid,Object.seal(this),_.R.propNoWrite(this,"params","grid"),this.prey[Symbol.iterator],this.pred.keys}onTeamsBootstrapped(){super.onTeamsBootstrapped(),this.pred=this.game.teams.filter((e=>e.id!==this.teamId)).flatMap((e=>e.members)).seal(),this.prey=[...this.pred].seal(),_.R.propNoWrite(this,"pred","prey")}_bhvrEvadePred(e){if(void 0!==e)return{dest:this.grid.getUntAwayFrom(this.game.players[e].coord,this.coord).coord};this.pred.sort(((e,t)=>this.grid.dist(e.coord,this.coord)-this.grid.dist(t.coord,this.coord)));for(const e of this.pred){if(this.grid.dist(e.coord,this.coord)>this.params.fearDistance)break;if(!e.isDowned&&e.health>this.health)return{dest:this.grid.getUntAwayFrom(e.coord,this.coord).coord,target:e.playerId}}}_bhvrChasePrey(e){if(void 0!==e)return{dest:this.game.players[e].coord};if(this.prey.sort(((e,t)=>this.grid.dist(this.coord,e.coord)-this.grid.dist(this.coord,t.coord))),this.isDowned)for(const e of this.prey){if(this.grid.dist(this.coord,e.coord)>this.params.bloodThirstDistance)break;if(e.health<this.health-this.params.healthReserve)return{dest:e.coord,target:e.playerId}}}_bhvrGotoHealthElseWander(e){if(void 0!==e&&this.game.health.tiles.has(e))return{dest:e};if(0===this.game.health.tiles.size){if(Math.random()<this.params.wanderingAimlessness)return{dest:this.grid.getRandomCoordAround(this.coord,3)};{const e=this.grid.getUntAwayFrom.bind(this.grid,this.prevCoord);return{dest:this.grid.getRandomCoordAround(e(e(this.coord).coord).coord,1)}}}let t,s=1/0;for(const e of this.game.health.tiles.values()){const r=this.grid.dist(this.coord,e.coord);r<s&&(t=e,s=r)}return{dest:t.coord,target:t.coord}}getNextMoveType(){return x.MoveType.NORMAL}computeNextMovementTimer(){return 1e3/this.params.keyPressesPerSecond}}!function(e){let t;(t=e.Behaviour||(e.Behaviour={})).DEFAULT=Object.freeze({fearDistance:5,bloodThirstDistance:7,healthReserve:3,keyPressesPerSecond:2,wanderingAimlessness:.2})}(ae||(ae={})),ae.prototype._behaviours=Object.freeze([ae.prototype._bhvrEvadePred,ae.prototype._bhvrChasePrey,ae.prototype._bhvrGotoHealthElseWander]),_.R.protoNoEnum(ae,"onTeamsBootstrapped"),Object.freeze(ae),Object.freeze(ae.prototype);var ne,he=Object.assign,ce=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};(()=>{Object.freeze(Object.assign(J._Constructors,{W_EUCLID2:X.Grid,BEEHIVE:V.Grid})),Object.freeze(J);{const e=ie;Object.freeze(Object.assign(e._Constructors,{CHASER:ae})),Object.freeze(e)}})();class de extends te{constructor(e){var t,s,r;super(e),this.lang=void 0,ne.set(this,void 0),this.health=new W(e.desc,this.grid.static),this.scoreInfo=new q(this.players.map((e=>e.playerId))),_.R.propNoWrite(this,"health","scoreInfo"),t=this,s=ne,r=i(59)(`./${this.langFrontend.module}.ts`).then((t=>{const s=this.langFrontend.export.split(".").reduce(((e,t)=>e[t]),t[this.langFrontend.module]);return this.lang=new s(e.desc.langWeightExaggeration),_.R.propNoWrite(this,"lang"),this.lang})),ce(t,s,"write to private field"),s.set(t,r)}async reset(){super.reset();const e=Object.freeze({playerCoords:[],csps:[]});var t,s;this.health.reset(),await(t=this,s=ne,ce(t,s,"read from private field"),s.get(t)),this.lang.reset(),this.grid.forEachShuffled(((t,s)=>{const r=this.dryRunShuffleLangCspAt(t.coord,!0);this.grid.write(t.coord,r),e.csps[s]=r})),this.teams.forEach((e=>e.reset()));const r=this.grid.static.getSpawnCoords(this.teams.map((e=>e.members.length)),this.grid.dimensions);return this.teams.forEach(((t,s)=>{t.members.forEach(((t,o)=>{const i=r[s][o];t.reset(i),e.playerCoords[t.playerId]=i}))})),this.scoreInfo.reset(),e}dryRunShuffleLangCspAt(e,t=!1){this.grid.write(e,S.U.CharSeqPair.NULL);let s=this.grid.getAllAltDestsThan(e).map((e=>e.seq)).freeze();if(t){const e=S.U.CharSeqPair.NULL.seq;s=s.filter((t=>t!==e)).freeze()}return this.lang.getNonConflictingChar(s)}dryRunSpawnHealth(e){var t;let s=this.health.K.avg-this.health.currentAmount;if(s<=0)return e;for(;s>0;){let r;do{r=this.grid.tileAt(this.grid.getRandomCoord())}while(r.occId!==x.Id.NULL);const o=w.K.AVERAGE_HEALTH_TO_SPAWN_ON_TILE;if(Math.random()<w.K._HEALTH_UPDATE_CHANCE){let s=e[r.coord];void 0!==s?s.health=(null!=(t=s.health)?t:0)+o:e[r.coord]={health:r.health+o}}s-=o}return e}processMoveRequest(e,t){const s=this.players[e.initiator];if(e.lastRejectId!==s.reqBuffer.lastRejectId)return;const r=this.grid.tileAt(e.moveDest);if(this.status!==w.Status.PLAYING||r.occId!==x.Id.NULL)return void this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),initiator:e.initiator},t);const o=e.moveType===x.MoveType.BOOST,i=s.health+r.health*(s.isDowned?w.K.HEALTH_EFFECT_FOR_DOWNED_PLAYER:1)-(o?this.health.K.costOfBoost(r):0);if(o&&i<0)return void this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),initiator:e.initiator},t);const a=this.scoreInfo.entries[s.playerId];a.totalHealthPickedUp+=r.health,a.moveCounts[e.moveType]+=1,this.commitStateChange({initiator:e.initiator,moveType:e.moveType,players:{[s.playerId]:{health:i,coord:r.coord}},tiles:this.dryRunSpawnHealth({[e.moveDest]:he({health:0},this.dryRunShuffleLangCspAt(r.coord))})},t)}commitTileMods(e,t,s=!0){const r=this.grid.tileAt(e);void 0!==t.health&&(this.health.add(t.health-r.health),t.health<=0?this.health.tiles.delete(e):this.health.tiles.set(e,r)),super.commitTileMods(e,t,s)}}ne=new WeakMap,(de||(de={})).CHECK_VALID_CTOR_ARGS=function(e){const t=[],s=Object.freeze({coordSys:0,gridDimensions:0,averageHealthPerTile:0,langId:0,langWeightExaggeration:0,players:0}),r=[];for(const t in s){null==e[t]&&r.push(t)}r.length&&t.push("Missing the following arguments: "+r);const o=S.U.GET_FRONTEND_DESC_BY_ID(e.langId),i=J._Constructors[e.coordSys];return void 0===o?t.push(`No language with the ID \`${e.langId}\` exists.`):void 0===i?t.push(`No grid with the system ID \`${e.coordSys}\` exists.`):o.isolatedMinOpts<i.ambiguityThreshold&&t.push("The provided language does not have enough sequences\nto ensure that a shuffling operation will always succeed when\npaired with the provided grid system."),NaN===parseInt(e.langWeightExaggeration)?t.push(`Language Weight Exaggeration expected a number, but\`${e.langWeightExaggeration}\` is not a number.`):e.langWeightExaggeration=Math.max(0,parseFloat(e.langWeightExaggeration)),t},Object.freeze(de),Object.freeze(de.prototype);var le,ue,me=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},pe=(e,t,s)=>(me(e,t,"read from private field"),s?s.call(e):t.get(e)),fe=(e,t,s,r)=>(me(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);function ge(e){const[t,...s]=JSON.parse(e.data),r=e.target;switch(t){case v.IN_GAME:this.processMoveRequest(s[0],r);break;case v.PAUSE:this.statusBecomePaused();break;case v.UNPAUSE:this.statusBecomePlaying();break;case v.RETURN_TO_LOBBY:if(r===this.groupHostSocket){this.statusBecomeOver();const e=JSON.stringify([v.RETURN_TO_LOBBY]);this.sockets.forEach((t=>{t!==r&&t.send(e)})),this._terminate()}else{const e=JSON.stringify([v.RETURN_TO_LOBBY,g(r)]);this.sockets.forEach((t=>{t!==r&&t.send(e)}))}}}class Ee extends de{constructor(e){super({impl:{gridClassLookup:J.getImplementation,OperatorPlayer:void 0,RobotPlayer:(e,t)=>ie.of(e,t),onGameBecomeOver:()=>{}},desc:(x.CtorArgs.finalize(e.gameDesc),e.gameDesc),operatorIds:[]}),le.set(this,void 0),ue.set(this,void 0),this.sockets=new Set(e.sockets),this.groupHostSocket=e.groupHostSocket,fe(this,le,e.deleteExternalRefs),_.R.instNoEnum(this,"operators"),_.R.propNoWrite(this,"groupHostSocket","sockets"),fe(this,ue,ge.bind(this)),Object.seal(this),this.sockets.forEach((e=>{e.addEventListener("message",pe(this,ue)),e.addEventListener("close",(()=>{1===this.sockets.size&&this._terminate()}),{once:!0})})),this._greetGameSockets(e.gameDesc)}get currentOperator(){throw new Error("never")}_greetGameSockets(e){const t=e.players.filter((e=>"HUMAN"===e.familyId)).freeze();Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===v.RESET&&t()}),{once:!0})}))))).then((()=>this.reset())),this.sockets.forEach((s=>{const r=t.filter((e=>e.socket===s)).map((e=>e.playerId)).freeze(),o=JSON.stringify([b.CREATE_GAME,e,r]);s.send(o)}))}async reset(){Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===v.UNPAUSE&&t()}),{once:!0})}))))).then((()=>{this.statusBecomePlaying()}));const e=await super.reset(),t=JSON.stringify([v.RESET,e]);return this.sockets.forEach((e=>e.send(t))),e}setCurrentOperator(e){}setTimeout(e,t,...s){return setTimeout(e,t,s).unref()}cancelTimeout(e){clearTimeout(e)}statusBecomePlaying(){super.statusBecomePlaying();const e=JSON.stringify([v.UNPAUSE]);this.sockets.forEach((t=>t.send(e)))}statusBecomePaused(){super.statusBecomePaused();const e=JSON.stringify([v.PAUSE]);this.sockets.forEach((t=>t.send(e)))}commitStateChange(e,t){if(super.commitStateChange(e),e.rejectId){const s=JSON.stringify([v.IN_GAME,e]);null==t||t.send(s)}else{const t=JSON.stringify([v.IN_GAME,e]);this.sockets.forEach((e=>e.send(t)))}}_terminate(){this.sockets.forEach((e=>{e.removeEventListener("message",pe(this,ue))})),pe(this,le).call(this)}}le=new WeakMap,ue=new WeakMap,_.R.protoNoEnum(Ee,"_greetGameSockets","setCurrentOperator","_terminate"),Object.freeze(Ee),Object.freeze(Ee.prototype);var Oe,ye,be,ve,Ne,we=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},_e=(e,t,s)=>(we(e,t,"read from private field"),s?s.call(e):t.get(e)),Se=(e,t,s,r)=>(we(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const Te=class extends O{constructor(e){super(),Oe.set(this,void 0),this.sockets=new Map,ye.set(this,void 0),be.set(this,void 0),ve.set(this,void 0),Ne.set(this,void 0),Object.defineProperty(this,"wssBroadcast",{value:e.wssBroadcast}),this.name=e.name,this.passphrase=e.passphrase,_.R.propNoWrite(this,"name","passphrase"),Se(this,Oe,void 0),Se(this,be,e.deleteExternalRefs),Se(this,ye,setTimeout((()=>{0===this.sockets.size&&this.terminate()}),1e3*Te.DEFAULT_TTL).unref()),Se(this,ve,(e=>{const[t,...s]=JSON.parse(e.data);switch(t){case b.UserInfo.NAME:this._wsOnUserInfoChange(e.target,s[0]);break;case b.CREATE_GAME:e.target===this.groupHostSocket&&this._wsOnHostCreateGame(s[0])}})),Se(this,Ne,(e=>{if(e.target===this.groupHostSocket||1===this.sockets.size)return void this.terminate();this.sockets.delete(e.target);const t=JSON.stringify([b.UserInfo.NAME,{[g(e.target)]:null}]);this.sockets.forEach(((e,s)=>s.send(t)))}))}get isCurrentlyPlayingAGame(){return void 0!==_e(this,Oe)}admitSocket(e,t){if(!this.sockets.has(e)){console.info(`socket connect (group):  ${g(e)}`),_e(this,Oe);{const s=b.UserInfo.NAME;{const r=JSON.stringify([s,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>t.send(r)))}const r={};this.sockets.forEach(((e,t)=>{r[g(t)]=e})),e.send(JSON.stringify([s,r]))}0===this.sockets.size&&(clearTimeout(_e(this,ye)),Se(this,ye,void 0),this.groupHostSocket=e,this.wssBroadcast(y.Exist.NAME,{[this.name]:y.Exist.Status.IN_LOBBY})),e.addEventListener("close",_e(this,Ne)),e.addEventListener("message",_e(this,ve)),this.sockets.set(e,t)}}kickSocket(e){return!!this.sockets.delete(e)&&(e.removeEventListener("close",_e(this,Ne)),e.removeEventListener("message",_e(this,ve)),!0)}_wsOnUserInfoChange(e,t){if("string"!=typeof t.username||"number"!=typeof t.teamId||"string"!=typeof t.avatar)return void console.log(`bad format: username: \`${t.username}\`, teamId: \`${t.teamId}\`, avatar: \`${t.avatar}\`.`);this.sockets.set(e,t);const s=JSON.stringify([b.UserInfo.NAME,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>t.send(s)))}_wsOnHostCreateGame(e){const t=this._createGameInstance(e);t.length?console.info(t):(this.wssBroadcast(y.Exist.NAME,{[this.name]:y.Exist.Status.IN_GAME}),console.info(`group ${this.name} new game`))}_createGameInstance(e){const t=[];return this.isCurrentlyPlayingAGame?(t.push("a game is already in session for this group"),t):(t.push(...de.CHECK_VALID_CTOR_ARGS(e)),t.length?t:(e.players=[...e.players,...Array.from(this.sockets.keys(),(e=>{const t=this.sockets.get(e);return Object.freeze({socket:e,familyId:"HUMAN",username:t.username,teamId:t.teamId,avatar:t.avatar,familyArgs:{}})}))].freeze(),Se(this,Oe,new Ee({sockets:this.sockets.keys(),groupHostSocket:this.groupHostSocket,deleteExternalRefs:()=>{Se(this,Oe,void 0)},gameDesc:e})),[]))}terminate(){for(const e of this.sockets.keys())e.removeEventListener("close",_e(this,Ne)),e.removeEventListener("message",_e(this,ve));void 0!==_e(this,Oe)&&Se(this,Oe,void 0),_e(this,be).call(this),this.wssBroadcast(y.Exist.NAME,{[this.name]:y.Exist.Status.DELETE}),console.info(`terminated group: \`${this.name}\``)}};let Ae=Te;Oe=new WeakMap,ye=new WeakMap,be=new WeakMap,ve=new WeakMap,Ne=new WeakMap,_.R.protoNoEnum(Ae,"_wsOnUserInfoChange","_wsOnHostCreateGame"),Object.freeze(Ae),Object.freeze(Ae.prototype);const Ie=new Map;function je(e){Ie.delete(e)}function Me(e,t){const s=JSON.stringify([e,t]);ke.clients.forEach((e=>e.send(s)))}function Ce(e){const[t,...s]=JSON.parse(e.data);switch(t){case y.Create.NAME:{let t=function(t){e.target.send(JSON.stringify([y.Create.NAME,t]))};const r=s[0];if(!function(e){return void 0!==e.groupName&&e.groupName.length<=Ae.Name.MaxLength&&Ae.Name.REGEXP.test(e.groupName)&&e.passphrase.length<=Ae.Passphrase.MaxLength&&Ae.Passphrase.REGEXP.test(e.passphrase)}(r)||Ie.has(r.groupName))return void t(!1);Ie.set(r.groupName,new Ae(Object.freeze({wssBroadcast:Me,name:r.groupName,passphrase:r.passphrase,deleteExternalRefs:je.bind(null,r.groupName)}))),t(!0);break}case y.TryJoin.NAME:{let t=function(t){e.target.send(JSON.stringify([y.TryJoin.NAME,t]))};const r=s[0],o=Ie.get(r.groupName);if(void 0===o||r.passphrase!==o.passphrase)return void t(!1);const i=r.userInfo;if(void 0===i||0!==i.teamId)throw new Error(`a socket attempted to connect to group \`${o.name}\` without providing userInfo.`);for(const t of Ie.values())if(t.kickSocket(e.target))break;o.admitSocket(e.target,i),t(!0);break}}}process.on("uncaughtException",(function(e){const t=n().resolve(__dirname,"../..");console.error("\n\n"),void 0!==e.stack&&(e.stack=e.stack.replace(new RegExp(t.replace(/\\/g,"\\\\"),"g"),":").split("\n").map((e=>{const t=e.indexOf("(");return t<0?e:e.substring(0,t)+" ".repeat(Math.max(0,35-t))+e.substring(t)})).join("\n"),r().writeSync(process.stderr.fd,e.stack)),console.error("\n\n"),process.exit(1)}));const Re=l()(),ze=c().createServer({},Re),ke=new(f().Server)({server:ze}),Pe=n().resolve(__dirname,"../client");Re.disable("x-powered-by").use("/",m()(Pe,{enableBrotli:!0,serveStatic:{setHeaders:(e,t,s)=>{e.setHeader("X-Content-Type-Options","nosniff"),"text/html"===l().static.mime.lookup(t)&&e.setHeader("Cache-Control","public, max-age=0")}}})),ke.on("connection",(function(e){const t=JSON.stringify([y.Exist.NAME,(()=>{const e={};for(const[t,s]of Ie)e[t]=s.isCurrentlyPlayingAGame?y.Exist.Status.IN_GAME:y.Exist.Status.IN_LOBBY;return e})()]);var s,r;s=e,r=`${Date.now().toString()}_${100*Math.random()%100}`,E.set(s,r),console.info(`socket connect (server): ${g(e)}`),e.send(t),e.addEventListener("message",Ce)})),ze.listen({port:443,host:"0.0.0.0"},(function(){const e=ze.address();console.info(`\n\nServer mounted to: \`${e.address}:${e.port}\` using ${e.family}.\nThis host can be reached at any of the following addresses:\n`),Le().sort().forEach((t=>{console.info(`${t}:${e.port}`)})),console.info("")}));const Le=()=>Object.values(t().networkInterfaces()).flat().filter((e=>!e.internal)).map((e=>"IPv6"===e.family?`[${e.address}]`:e.address))})(),capswalk=a})();
//# sourceMappingURL=index.js.map