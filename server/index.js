var capswalk;(()=>{var e,t,s,r={990:(e,t,s)=>{"use strict";s.d(t,{R:()=>a});const r=Object.freeze({enumerable:!1}),o=Object.freeze({writable:!1});function i(e){e.repeat&&e.preventDefault()}var a;!function(e){function t(e){for(const s of Object.getOwnPropertyNames(e)){const r=e[s];null!==r&&"object"==typeof r&&t(r)}Object.freeze(e)}function s(e,t,...s){for(const r of s)Object.defineProperty(t,r,e)}let a;var n;e.deepFreeze=function(e){return t(e),e},e.hasProp=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},e.protoNoEnum=function(e,...t){Object.getOwnPropertyNames(e.prototype).freeze(),t.forEach((t=>{Object.defineProperty(e.prototype,t,r)}))},e.instNoEnum=s.bind(null,r),e.propNoWrite=s.bind(null,o),e.camelCaseTransforms=function(e){const t=e.replace(/[A-Z]/g,(e=>" "+e.toLowerCase()));return Object.freeze({spaceyLowercase:t,spaceyUppercase:t.toUpperCase(),spaceyCapitalized:t.split(" ").map((e=>e.charAt(0).toUpperCase()+e.substring(1))).join(" ")})},(n=a=e.Web||(e.Web={})).prependComment=function(e,t){e.parentNode.insertBefore(document.createComment(" "+t+" "),e)},n.adoptStyleSheet=function(t,s){t.appendChild(e.html("link",[],{rel:"stylesheet",href:s}))},n._makeSmartStorage=function(e,t,s){const r={};return Object.keys(s).forEach((e=>{const o=""+e,i=s[e];Object.defineProperty(r,e,{enumerable:!0,get:()=>{const e=t.getItem(o);return null===e?i:JSON.parse(e)},set:e=>{t.setItem(o,JSON.stringify(e))}})})),r},e.html=function(e,t,s){const r=document.createElement(e);try{Object.seal(r)}catch(e){}return(null==t?void 0:t.length)&&r.classList.add(...t),"button"===e?(r.type="button",r.addEventListener("keydown",i,{capture:!0})):"a"===e&&(r.draggable=!1,r.rel="noopener"),void 0!==s&&Object.assign(r,s),r},e.svg=function(e,t,s){const r=document.createElementNS("http://www.w3.org/2000/svg",e);return Object.seal(r),(null==t?void 0:t.length)&&r.classList.add(...t),void 0!==s&&Object.assign(r,s),r}}(a||(a={})),Object.freeze(a)},635:(e,t,s)=>{"use strict";s.d(t,{Uo:()=>i,J5:()=>o});const r=JSON.parse('["üéà","üéê","üèÆ","üóø","‚ö±","üõí","üéâ","üßµ","üß∂","üéÉ","üéÑ","üéé","üéè","üßß","üéÄ","üéÅ","üé†","üé™","üé≠","üé´","üëë","üëí","üé©","üéì","üëì","üï∂","ü§ø","üíÑ","üíé","üëî","üëñ","üß§","üß¶","üëó","üëò","üëö","üëú","üéí","üß∞","üíº","ü•æ","üë†","üë¢","ü©∞","‚öΩ","‚öæ","üèÄ","üèê","üèà","üé±","üé≥","ü•å","üèì","üéØ","ü™Ä","üèÜ","üéÆ","üé≤","üì¢","üîî","üéµ","üéß","üìª","üìØ","ü•Å","üé∑","üé∫","üé∏","ü™ï","üéª","üé•","üì∑","üé¨","üì∫","üìº","‚òé","üì±","üìü","üíª","üíæ","üî¨","üî≠","‚öô","üß≤","üîç","üí°","ü©∫","ü©π","‚úí","‚úè","üìú","üìã","üîñ","üí∏","üí≥","üì®","üì¶","üì¨","üìÆ","‚è≥","‚è∞","üìÖ","üìÜ","üìà","üìâ","üìå","üìê","‚úÇ","üóë","‚ôü","‚ô†","‚ô£","‚ô•","üîì","üîë","‚öî","üî´","üíÄ","üôà","üôâ","üôä","üê∂","üê∫","üê±","ü¶Å","üêØ","ü¶í","ü¶ä","ü¶ù","üêÆ","üê∑","üêó","üê≠","üêπ","üê∞","üêª","üê®","üêº","üê∏","ü¶ì","üê¥","ü¶Ñ","üêî","üê≤","üêÑ","üê™","üê´","ü¶•","ü¶®","üêò","üêÅ","üêÄ","ü¶î","üêá","üêø","ü¶é","üêä","üê¢","üêç","ü¶ï","ü¶à","üê¨","üê≥","üêã","üêü","üê†","ü¶ê","ü¶ë","üêô","ü¶û","ü¶Ä","üêö","ü¶Ü","üêì","ü¶É","ü¶Ö","üïä","ü¶¢","ü¶ú","ü¶©","ü¶ö","ü¶â","üê¶","üêß","üê£","ü¶ã","üêå","üêõ","üêú","üêù","üêû","üï∑","üï∏","üëÅ","ü¶∑","üëÑ","üß†","üíÉ","üï∫","ü§∏‚Äç‚ôÄÔ∏è","üëÉ","ü§è","‚úå","ü§û","üññ","ü§ò","üëç","üëè","üôå","üôè","üçû","üßÇ","ü•ê","ü•®","üßÄ","ü•ó","ü•™","üåÆ","ü•°","üçô","üçö","üçú","üç£","üç§","üç•","üç¶","üç∞","üç¨","üç°","üçÆ","üßÉ","‚òï","üßä","üè∫","üçë","üçì","üçé","üçä","ü•≠","üçç","üçã","üçà","üçê","üçè","üçí","üçÖ","üçå","üçâ","ü•ù","üåΩ","ü•ë","ü•¨","üßÑ","üßÖ","ü•ï","üå∂","üå∞","üçÑ","üå∏","üèµ","üå∫","üåª","üåº","üå∑","üå±","üå≤","üéç","üåµ","‚òò","üçÄ","üçÅ","üçÇ","üöó","üöí","üõπ","üöã","üö†","üöÇ","üöÄ","üõ∞","‚öì","üö©","üó∫","üß≠","‚õ∞","üåã","üóª","üóΩ","üõé","ü™ë","üöΩ","üßª","üõÅ","üßØ","‚òÅ","‚õà","üå§","üå¶","üåß","üå©","‚òÄ","‚≠ê","üåà","‚òÇ","‚õ±","‚ö°","‚ùÑ","‚õÑ","üî•","üåä"]');Object.freeze({behavior:"smooth",block:"center",inline:"center"});class o{}!function(e){let t,s;var o;let i;var a;e.Family=Object.freeze({HUMAN:"HUMAN",CHASER:"CHASER"}),e.Family,(t=e.Id||(e.Id={})).NULL=-1,(o=s=e.Username||(e.Username={})).REGEXP=/[ a-zA-Z0-9:-]+/,o.MAX_LENGTH=15,(a=i=e.Avatar||(e.Avatar={})).Values=r.map((e=>e+"Ô∏è")).freeze(),a.GET_RANDOM=function(){return a.Values[Math.floor(Math.random()*a.Values.length)]}}(o||(o={})),Object.freeze(o);class i{}!function(e){let t,s;(t=e.Seq||(e.Seq={})).REGEXP=new RegExp("^[a-zA-Z0-9!@#$%^&*()-_=+;:'\"\\|,.<>/?]+$"),(s=e.WeightExaggeration||(e.WeightExaggeration={})).MAX=4,e.CHAR_HIT_COUNT_SEED_CEILING=5}(i||(i={})),Object.freeze(i),Object.freeze(i.prototype)},700:(e,t,s)=>{"use strict";s.d(t,{U:()=>g});var r=s(990),o=s(635);const i=Object.freeze({IDENT:e=>e,LOWER:e=>e.toLowerCase()}),a={"engl-low":{id:void 0,module:"English",export:"Lowercase",isolatedMinOpts:25,avgWeight:3.8639230769230766,remapFunc:i.LOWER,fontScaling:1,displayName:"English Lowercase (qwerty)",blurb:""},"engl-mix":{id:void 0,module:"English",export:"MixedCase",isolatedMinOpts:51,avgWeight:3.8639230769230775,remapFunc:i.IDENT,fontScaling:1,displayName:"English Mixed-Case (Qwerty)",blurb:""},"japn-hir":{id:void 0,module:"Japanese",export:"Hiragana",isolatedMinOpts:70,avgWeight:275509.7083333333,remapFunc:i.LOWER,fontScaling:1,displayName:"Japanese Hiragana",blurb:""},"japn-kat":{id:void 0,module:"Japanese",export:"Katakana",isolatedMinOpts:68,avgWeight:45577.26666666667,remapFunc:i.LOWER,fontScaling:1,displayName:"Japanese Katakana",blurb:""},"kore-dub":{id:void 0,module:"Korean",export:"Dubeolsik",isolatedMinOpts:9085,avgWeight:.9974982117852247,remapFunc:i.IDENT,fontScaling:1,displayName:"Korean Dubeolsik (ÎëêÎ≤åÏãù ÌÇ§Î≥¥Îìú)",blurb:"The most common keyboard layout, and South Korea's only Hangul standard since 1969. Consonants are on the left, and vowels on the right."},"kore-sub":{id:void 0,module:"Korean",export:"Sebeolsik",isolatedMinOpts:10098,avgWeight:.9974982117852336,remapFunc:i.IDENT,fontScaling:1,displayName:"Korean Sebeolsik (ÏÑ∏Î≤åÏãù ÏµúÏ¢Ö ÌÇ§Î≥¥Îìú)",blurb:"Another Hangul keyboard layout used in South Korea, and the final Sebeolsik layout designed by Dr. Kong Byung Woo, hence the name. Syllable-initial consonants are on the right, final consonants on the left, and vowels in the middle. It is more ergonomic than the dubeolsik, but not widely used."},"kore-rom":{id:void 0,module:"Korean",export:"Romanization",isolatedMinOpts:4764,avgWeight:.9974982117852286,remapFunc:i.LOWER,fontScaling:1,displayName:"Korean Revised Romanization",blurb:"The Revised Romanization of Korean (Íµ≠Ïñ¥Ïùò Î°úÎßàÏûê ÌëúÍ∏∞Î≤ï; ÂúãË™ûÏùò Î°úÎßàÂ≠ó Ë°®Ë®òÊ≥ï) is the official South Korean language romanization system. It was developed by the National Academy of the Korean Language from 1995, and was released on 7 July 2000 by South Korea's Ministry of Culture and Tourism"},"engl-cell-enc":{id:void 0,module:"English",export:"OldCellphone.Encode",isolatedMinOpts:7,avgWeight:3.8639230769230766,remapFunc:i.IDENT,fontScaling:1,displayName:"Old Cellphone Keyboard",blurb:""},"mors-enc":{id:void 0,module:"English",export:"Morse.Encode",isolatedMinOpts:11,avgWeight:2.6089716238018403,remapFunc:e=>e,fontScaling:1,displayName:"Morse Encoder",blurb:""},"mors-dec":{id:void 0,module:"English",export:"Morse.Decode",isolatedMinOpts:40,avgWeight:2.6089716238018408,remapFunc:i.LOWER,fontScaling:.4,displayName:"Morse Decoder",blurb:""},ngram2:{id:void 0,module:"Ngrams",export:"Ngram2",isolatedMinOpts:199,avgWeight:5.000010000000002,remapFunc:i.LOWER,fontScaling:.9,displayName:"English Bigrams",blurb:""},ngram3:{id:void 0,module:"Ngrams",export:"Ngram3",isolatedMinOpts:399,avgWeight:2.5000100000000023,remapFunc:i.LOWER,fontScaling:.6,displayName:"English Trigrams",blurb:""},numpad:{id:void 0,module:"Numpad",export:"Numpad",isolatedMinOpts:99,avgWeight:1,remapFunc:i.LOWER,fontScaling:.95,displayName:"Number Pad",blurb:""}};Object.entries(a).freeze().forEach((([e,t])=>{t.id=e})),r.R.deepFreeze(a);var n,c,h,d,l=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},u=(e,t,s)=>(l(e,t,"read from private field"),s?s.call(e):t.get(e)),p=(e,t,s,r)=>(l(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const f=new Map,m=class extends o.Uo{constructor(e,t){super(),n.set(this,void 0),c.set(this,void 0),h.set(this,void 0),d.set(this,void 0),this.desc=m.GetDesc(e),this.csps=f.has(e)?f.get(e):(()=>{const t=Object.getPrototypeOf(this).constructor.BUILD(),s=m.CreateCspsArray(t);return f.set(e,s),s})(),p(this,n,this.csps.length),r.R.propNoWrite(this,"desc","csps");{const e=m.GetWeightScalingFn(t,this.desc.avgWeight);p(this,c,Float32Array.from(this.csps.map((t=>e(t.unscaledWt)))))}p(this,h,new Float64Array(u(this,n))),p(this,d,new Uint16Array(u(this,n)+1)),Object.seal(this)}reset(){for(let e=0;e<u(this,h).length;e++)u(this,h)[e]=Math.random()*m.RESET_NUM_HITS/this.desc.avgWeight;const e=[];u(this,h).forEach(((t,s)=>{e.push(Object.freeze({_hits:t,cspsIndex:s}))})),e.push({_hits:1/0,cspsIndex:u(this,n)}),e.seal().sort(((e,t)=>e._hits-t._hits)).freeze();{let t=u(this,d)[u(this,n)]=e[0].cspsIndex;for(let s=1;s<e.length;s++)t=u(this,d)[t]=e[s].cspsIndex}}getNonConflictingChar(e){e=e.filter((e=>e)).freeze();const t=u(this,d);for(let s=t[u(this,n)],r=u(this,n);s!==u(this,n);r=s,s=t[s]){const o=this.csps[s];if(!e.some((e=>m.EitherPrefixesOther(e,o.seq)))){u(this,h)[s]+=1/u(this,c)[s];let e=s;for(;t[e]!==u(this,n)&&u(this,h)[s]>u(this,h)[t[e]];)e=t[e];return e!==s&&(t[r]=t[s],t[s]=t[e],t[e]=s),o}}throw new Error("never")}_assertInvariants(){const e=[];for(let t=0;t<u(this,n);t++)e[t]=!1;e.seal();let t=u(this,d)[u(this,n)],s=0;for(let r=0;r<u(this,n);r++){if(u(this,h)[t]<s)throw new Error("lang hits should be ascending");s=u(this,h)[t],e[t]=!0,t=u(this,d)[t]}if(t!==u(this,n))throw new Error("lang next should end by looping back");if(e.some((e=>!1===e)))throw new Error("lang next should be an exhaustive loop")}_calcIsolatedMinOpts(){const e=[];this.csps.forEach((t=>{e[e.length-1]!==t.seq&&e.push(t.seq)})),e.freeze();const t=[];for(const s of[...e].seal().reverse().freeze())t.some((e=>e.startsWith(s)))||t.push(s);t.freeze();const s=[];for(const t of e)s.some((e=>e.startsWith(t)))||s.push(t);s.freeze();const r=new Map;return s.forEach((e=>r.set(e,0))),t.forEach((e=>{for(const t of s)if(e.startsWith(t)){r.set(t,r.get(t)+1);break}})),[...r.values()].sort(((e,t)=>e-t)).slice(0,-1).reduce(((e,t)=>e+t),0)}};let g=m;n=new WeakMap,c=new WeakMap,h=new WeakMap,d=new WeakMap,function(e){function t(e){return a[e]}async function r(e){const t=a[e],r=await s(59)(`./${t.module}.ts`);return t.export.split(".").reduce(((e,t)=>e[t]),r[t.module])}function o(e,t){return 0===e?o.UNIFORM:1===e?o.IDENTITY:s=>Math.pow(s/t,e)}var i;function n(e){return Object.entries(e).freeze().map((([e,{seq:t,weight:s}])=>Object.freeze({char:e,seq:t,unscaledWt:s}))).seal().sort(((e,t)=>t.unscaledWt-e.unscaledWt)).freeze()}let c;e.GetDesc=t,Object.freeze(t),e.Import=r,Object.freeze(r),e.GetWeightScalingFn=o,(i=o=e.GetWeightScalingFn||(e.GetWeightScalingFn={})).UNIFORM=function(){return 1},i.IDENTITY=function(e){return e},Object.freeze(o),e.CreateCspsArray=n,Object.freeze(n),e.RESET_NUM_HITS=10,e.EitherPrefixesOther=function(e,t){return e.length>t.length?e.startsWith(t):t.startsWith(e)},function(e){function t(e){return Object.entries(e).freeze().reduce(((e,[t,s])=>(e[t]={seq:t,weight:s},e)),{})}e.WORD_FOR_WORD=t,Object.freeze(t)}(c=e.BuildUtils||(e.BuildUtils={}))}(g||(g={})),Object.freeze(g),Object.freeze(g.prototype)},59:(e,t,s)=>{var r={"./Chinese.ts":[603,7,330],"./Emote.ts":[896,9,858],"./English.ts":[536,9,184],"./Japanese.ts":[544,9,410],"./Korean.ts":[242,9,227],"./Ngrams.ts":[414,9,273],"./Numpad.ts":[373,9,683],"./Shell.ts":[716,9,159],"./defs/Chinese.ts":[720,7,704],"./defs/English100.ts":[45,9,885]};function o(e){if(!s.o(r,e))return Promise.resolve().then((()=>{var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=r[e],o=t[0];return s.e(t[2]).then((()=>s.t(o,16|t[1])))}o.keys=()=>Object.keys(r),o.id=59,e.exports=o}},o={};function i(e){var t=o[e];if(void 0!==t)return t.exports;var s=o[e]={exports:{}};return r[e](s,s.exports,i),s.exports}i.m=r,i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},t=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,i.t=function(s,r){if(1&r&&(s=this(s)),8&r)return s;if("object"==typeof s&&s){if(4&r&&s.__esModule)return s;if(16&r&&"function"==typeof s.then)return s}var o=Object.create(null);i.r(o);var a={};e=e||[null,t({}),t([]),t(t)];for(var n=2&r&&s;"object"==typeof n&&!~e.indexOf(n);n=t(n))Object.getOwnPropertyNames(n).forEach((e=>a[e]=()=>s[e]));return a.default=()=>s,i.d(o,a),o},i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.f={},i.e=e=>Promise.all(Object.keys(i.f).reduce(((t,s)=>(i.f[s](e,t),t)),[])),i.u=e=>"chunk/"+{159:"lang/Shell-ts",184:"lang/English-ts",227:"lang/Korean-ts",273:"lang/Ngrams-ts",330:"lang/Chinese-ts",410:"lang/Japanese-ts",683:"lang/Numpad-ts",704:"lang/defs-Chinese-ts",858:"lang/Emote-ts",885:"lang/defs-English100-ts"}[e]+".js",i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s={826:1},i.f.require=(e,t)=>{s[e]||(e=>{var t=e.modules,r=e.ids,o=e.runtime;for(var a in t)i.o(t,a)&&(i.m[a]=t[a]);o&&o(i);for(var n=0;n<r.length;n++)s[r[n]]=1})(require("./"+i.u(e)))};var a={};(()=>{"use strict";i.r(a),i.d(a,{chooseIPAddress:()=>qe,wss:()=>Fe});const e=require("fs");var t=i.n(e);const s=require("path");var r=i.n(s);Object.defineProperties(Array.prototype,{freeze:{value:function(){return Object.freeze(this)},enumerable:!0},seal:{value:function(){return Object.seal(this)},enumerable:!0}}),["Object","String","Number","RegExp","Date","Array","Map","Set","WeakMap","WeakSet"].forEach((e=>{if(Object.defineProperty(globalThis,e,{enumerable:!0,writable:!1,configurable:!1}),Object.freeze(globalThis[e]),"Object"===e){Object.seal(globalThis[e].prototype);for(const e of Object.getOwnPropertyNames(Object.prototype))Object.defineProperty(Object.prototype,e,{configurable:!1,enumerable:!1,writable:"toString"===e})}else Object.freeze(globalThis[e].prototype)})),process.on("uncaughtException",(function(e){const s=r().resolve(__dirname,"../..");console.error("\n\n"),void 0!==e.stack&&(e.stack=e.stack.replace(new RegExp(s.replace(/\\/g,"\\\\"),"g"),":").split("\n").map((e=>{const t=e.indexOf("(");return t<0?e:e.substring(0,t)+" ".repeat(Math.max(0,35-t))+e.substring(t)})).join("\n"),t().writeSync(process.stderr.fd,e.stack)),console.error("\n\n"),process.exit(1)}));const o=require("os");var n=i.n(o);const c=require("http");var h=i.n(c);const d=require("koa");var l=i.n(d);const u=require("koa-static");var p=i.n(u);const f=require("ws");var m=i.n(f);function g(e){if(y.has(e))return y.get(e);throw new Error("never")}const y=new WeakMap;class b{}var O,v,E,w;!function(e){let t;var s;let r;var o;(s=t=e.Name||(e.Name={})).REGEXP=/^(?:[a-zA-Z0-9:-]+)$/,s.MaxLength=30,(o=r=e.Passphrase||(e.Passphrase={})).REGEXP=/^(?:[a-zA-Z0-9:-]*)$/,o.MaxLength=30,e.GameServerReconnectionAttempts=2,e.DEFAULT_TTL=20}(b||(b={})),Object.freeze(b),Object.freeze(b.prototype),function(e){let t,s,r;(t=e.Create||(e.Create={})).NAME="joiner/create",function(e){let t;var s;e.NAME="joiner/exist",(s=t=e.Status||(e.Status={})).IN_LOBBY="in-lobby",s.IN_GAME="in-game",s.DELETE="delete"}(s=e.Exist||(e.Exist={})),(r=e.TryJoin||(e.TryJoin={})).NAME="joiner/try-join"}(O||(O={})),Object.freeze(O),function(e){let t;(t=e.UserInfo||(e.UserInfo={})).NAME="group/user-info-change",e.CREATE_GAME="group/create-game"}(v||(v={})),Object.freeze(v),(w=E||(E={})).RESET="game/reset",w.UNPAUSE="game/unpause",w.PAUSE="game/pause",w.IN_GAME="game/ingame",w.RETURN_TO_LOBBY="game/return-to-lobby";var N,S=i(990),j=i(700);!function(e){let t;var s;(s=t=e.Status||(e.Status={})).PLAYING="PLAYING",s.PAUSED="PAUSED",s.OVER="OVER",Object.freeze(t),e.K=Object.freeze({PORTION_OF_MOVES_THAT_ARE_BOOST:.4,_REQUEST_BUFFER_LENGTH:5,_ROBOT_PRIORITY_MAX_REUSES:4})}(N||(N={})),Object.freeze(N);var M,_=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},I=(e,t,s,r)=>(_(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class z{constructor(){M.set(this,0),this.size=0}get lastRejectId(){return _(this,e=M,"read from private field"),e.get(this);var e}reset(e){I(this,M,0),this.size=0,this.predictedCoord=e}get isFull(){return this.size===N.K._REQUEST_BUFFER_LENGTH}signRequest(e){return this.size++,this.predictedCoord=e.moveDest,e}getNextRejectId(){return(this.lastRejectId+Math.floor(99*Math.random()))%100}reject(e,t){I(this,M,e),this.size=0,this.predictedCoord=t}acceptOldest(){this.size--}}M=new WeakMap,Object.freeze(z),Object.freeze(z.prototype);var C=i(635);class A{constructor(e,t){if(this.id=e,this.members=t,this.elimOrder=A.ElimOrder.STANDING,S.R.propNoWrite(this,"id","members"),Object.seal(this),0===t.length)throw new Error("Teams must have at least one member.")}reset(){this.elimOrder=A.ElimOrder.STANDING}}!function(e){let t;(t=e.ElimOrder||(e.ElimOrder={})).STANDING=0}(A||(A={})),Object.freeze(A),Object.freeze(A.prototype);var T,R,k=Object.defineProperty,x=Object.prototype.hasOwnProperty,P=Object.getOwnPropertySymbols,D=Object.prototype.propertyIsEnumerable,W=(e,t,s)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,G=(e,t)=>{for(var s in t||(t={}))x.call(t,s)&&W(e,s,t[s]);if(P)for(var s of P(t))D.call(t,s)&&W(e,s,t[s]);return e},U=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},L=(e,t,s)=>(U(e,t,"read from private field"),s?s.call(e):t.get(e)),B=(e,t,s,r)=>(U(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const F=class extends C.J5{constructor(e,t){super(),T.set(this,void 0),R.set(this,0),this.prevCoord=void 0,this.playerId=t.playerId,this.familyId=t.familyId,this.teamId=t.teamId,this.username=t.username,this.avatar=t.avatar,this.game=e,this.reqBuffer=new z,S.R.instNoEnum(this,"game"),S.R.propNoWrite(this,"game","playerId","familyId","teamId","username","avatar","reqBuffer"),new.target===F&&Object.seal(this)}get team(){return this.game.teams[this.teamId]}get coord(){return L(this,T)}get boosts(){return L(this,R)}get isDowned(){return this.boosts<0}isTeamedWith(e){return this.team.members.includes(e)}_onTeamsBootstrapped(){}reset(e){B(this,T,e),this.prevCoord=e,this.game.grid.moveEntity(this.playerId,e,e),B(this,R,0),this.reqBuffer.reset(e)}onGamePlaying(){}onGamePaused(){}onGameOver(){}makeMovementRequest(e,t){this.reqBuffer.isFull||this.game.requestStateChange(this.reqBuffer.signRequest({author:this.playerId,lastRejectId:this.reqBuffer.lastRejectId,moveType:t,moveDest:e}))}_setCoord(e){this.prevCoord=this.coord,B(this,T,e)}set boosts(e){const t=this.isDowned;if(B(this,R,e),t||!this.isDowned)return;const s=this.team,r=this.game.teams;if(s.elimOrder===A.ElimOrder.STANDING&&s.members.every((e=>e.isDowned))){const e=1+r.filter((e=>e.elimOrder!==A.ElimOrder.STANDING)).length;s.elimOrder=1+r.filter((e=>e.elimOrder!==A.ElimOrder.STANDING)).length,e===r.length&&this.game.statusBecomeOver()}}};let q=F;T=new WeakMap,R=new WeakMap,function(e){let t;e.MoveType=Object.freeze({NORMAL:"NORMAL",BOOST:"BOOST"}),e.MoveType,(t=e.CtorArgs||(e.CtorArgs={})).finalize=function(t){const s=Array.from(new Set(t.players.map((e=>e.teamId)))).seal().sort(((e,t)=>e-t)).freeze().reduce(((e,t,s)=>(e[t]=s,e)),[]);t.players=t.players.slice().seal().sort(((e,t)=>s[e.teamId]-s[t.teamId])).freeze().map(((t,r)=>{var o;return G(G({},t),{playerId:r,teamId:s[t.teamId],avatar:null!=(o=t.avatar)?o:e.Avatar.GET_RANDOM()})})).freeze()},Object.freeze(t)}(q||(q={})),S.R.protoNoEnum(q,"onGamePlaying","onGamePaused","onGameOver","_onTeamsBootstrapped"),Object.freeze(q),Object.freeze(q.prototype);class H{constructor(e){const t=[];for(const s of e)t[s]=new H.Entry;this.entries=t,S.R.propNoWrite(this,"entries"),Object.seal(this)}reset(){for(const e of this.entries)e.reset()}}!function(e){class t{constructor(){this.moveCounts={}}reset(){Object.getOwnPropertyNames(q.MoveType).forEach((e=>{this.moveCounts[e]=0}))}}e.Entry=t,Object.freeze(t),Object.freeze(t.prototype)}(H||(H={})),Object.freeze(H),Object.freeze(H.prototype);class J{constructor(e){Object.freeze(e),this.static=e.Grid,this.dimensions=e.dimensions,this.area=e.Grid.getArea(e.dimensions),S.R.propNoWrite(this,"static","dimensions")}reset(){this.forEach((e=>{this.write(e.coord,{char:"",seq:""})}))}getAllAltDestsThan(e){const t=new Map;return this.tileSourcesTo(e).flatMap((e=>this.tileDestsFrom(e.coord))).forEach((e=>{t.has(e.coord)||t.set(e.coord,e)})),Array.from(t.values()).freeze()}getRandomCoord(){return this.static.getRandomCoord(this.dimensions)}static getSpawnCoords(e,t){const s=new Set;return e.map((e=>{const r=[];for(;e>0;){let o;do{o=this.getRandomCoord(t)}while(s.has(o));r.push(o),s.add(o),e--}return r.freeze()})).freeze()}}var K;(K=J||(J={}))._Constructors={W_EUCLID2:void 0,BEEHIVE:void 0},K.getImplementation=e=>K._Constructors[e],Object.freeze(J),Object.freeze(J.prototype);var $,Y,X,V=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},Z=(e,t,s)=>(V(e,t,"read from private field"),s?s.call(e):t.get(e)),Q=(e,t,s,r)=>(V(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);class ee{constructor(e){$.set(this,void 0),Y.set(this,void 0),X.set(this,void 0);const{impl:t,desc:s,operatorIds:r}=e;Object.freeze(s),Object.freeze(s.players),s.players.forEach((e=>Object.freeze(e))),Object.freeze(r);const o=j.U.GetDesc(e.desc.langId),i=t.gridClassLookup(s.coordSys);this.grid=new i({Grid:i,system:s.coordSys,dimensions:s.gridDimensions,langCharFontScaling:o.fontScaling,players:s.players}),Q(this,$,t.onGameBecomeOver);const a=this._createPlayers(s,t,r,o);this.players=a.players,this.operators=a.operators;{const e=[];this.players.forEach((t=>{e[t.teamId]||(e[t.teamId]=[]),e[t.teamId].push(t)})),this.teams=e.map(((e,t)=>new A(t,e)))}S.R.propNoWrite(this,"grid","players","operators","teams"),this.players.forEach((e=>e._onTeamsBootstrapped())),this.setCurrentOperator(0)}reset(){this.grid.reset(),Q(this,X,N.Status.PAUSED)}_createPlayers(e,t,s,r){const o=e.players.map((e=>e.familyId===q.Family.HUMAN?s.includes(e.playerId)?new t.OperatorPlayer(this,e,r):new q(this,e):t.RobotPlayer(this,e))).freeze();return Object.freeze({players:o,operators:s.map((e=>o[e])).freeze()})}deserializeResetState(e){S.R.deepFreeze(e),this.grid.forEach(((t,s)=>{this.grid.write(t.coord,e.csps[s])})),e.playerCoords.forEach(((e,t)=>{this.players[t].reset(e)}))}get currentOperator(){return Z(this,Y)}setCurrentOperator(e){const t=this.operators[e];if(void 0===t)throw new Error("never");this.currentOperator!==t&&Q(this,Y,t)}get status(){return Z(this,X)}statusBecomePlaying(){if(this.status!==N.Status.PLAYING){if(this.status!==N.Status.PAUSED)throw new Error("Can only resume a game that is currently paused.");this.players.forEach((e=>{e.onGamePlaying()})),Q(this,X,N.Status.PLAYING)}else console.info("[statusBecomePlaying]: Game is already playing")}statusBecomePaused(){this.status!==N.Status.PAUSED?this.status!==N.Status.OVER&&(this.players.forEach((e=>{e.onGamePaused()})),Q(this,X,N.Status.PAUSED)):console.info("[statusBecomePaused]: Game is already paused")}statusBecomeOver(){this.status!==N.Status.OVER&&(this.players.forEach((e=>{e.onGameOver()})),Q(this,X,N.Status.OVER),Z(this,$).call(this),console.info("game is over!"))}commitTileMods(e,t){if(void 0!==t.seq){const t=this.grid.tileSourcesTo(e);this.operators.forEach((e=>{t.some((t=>t.coord===e.coord))&&e.seqBufferAcceptKey(void 0)}))}this.grid.write(e,t)}commitStateChange(e,t){S.R.deepFreeze(e);const s=this.players[e.author];if(void 0===e.rejectId){s.reqBuffer.acceptOldest();for(const[t,s]of Object.entries(e.tiles).freeze())this.commitTileMods(parseInt(t),s);for(const[t,s]of Object.entries(e.players).freeze()){const e=this.players[parseInt(t)];if(e.boosts=s.boosts,void 0!==s.coord){const t=e.coord;this.grid.moveEntity(e.playerId,t,s.coord),e._setCoord(s.coord)}}}else s.reqBuffer.reject(e.rejectId,s.coord)}}$=new WeakMap,Y=new WeakMap,X=new WeakMap,S.R.protoNoEnum(ee,"_createPlayers"),Object.freeze(ee),Object.freeze(ee.prototype);var te,se,re=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},oe=(e,t,s)=>(re(e,t,"read from private field"),s?s.call(e):t.get(e));class ie{constructor(e,t){this.x=e,this.y=t,Object.freeze(this)}static from(e,t){return new ie(t%e.width,Math.floor(t/e.width))}toCoord(e){return this.y*e.width+this.x}static distX(e,t,s){const r=Math.abs(t.x-s.x);return r<e.width/2?r:e.width-r}static distY(e,t,s){const r=Math.abs(t.y-s.y);return r<e.height/2?r:e.height-r}static oneNorm(e,t,s){return ie.distX(e,t,s)+ie.distY(e,t,s)}static infNorm(e,t,s){const r=ie.distX(e,t,s),o=ie.distY(e,t,s);return Math.max(r,o)}static wrapInfo(e,t,s){return Object.freeze({x:Math.abs(s.x-t.x)<e.width/2?0:s.x<t.x?-1:1,y:Math.abs(s.y-t.y)<e.height/2?0:s.y<t.y?-1:1})}static axialAlignment(e,t,s){const r=ie.from(e,t),o=ie.from(e,s),i=ie.distX(e,r,o),a=ie.distY(e,r,o);return Math.abs(i-a)/(i+a)}add(e){return new ie(this.x+e.x,this.y+e.y)}sub(e){return new ie(this.x-e.x,this.y-e.y)}iSub(e){return this.add(this.sub(e))}mul(e){return new ie(e*this.x,e*this.y)}mod(e){let{x:t,y:s}=this;for(;t<0;)t+=e.width;for(;s<0;)s+=e.height;return t%=e.width,s%=e.height,new ie(t,s)}}Object.freeze(ie),Object.freeze(ie.prototype),function(e){var t;const s=class extends J{constructor(e){var r,o,i;super(e),t.set(this,void 0),r=this,o=t,i=new Uint8Array(this.area),re(r,o,"write to private field"),o.set(r,i);const a=[];for(let e=0;e<this.dimensions.height;e++)for(let t=0;t<this.dimensions.width;t++)a.push({coord:e*this.dimensions.width+t,seq:""});this._grid=a.seal();const n=[];for(let t=0;t<e.dimensions.height;t++)for(let s=0;s<e.dimensions.width;s++)n.push(new ie(s,t));this.iacCache=n.freeze(),S.R.instNoEnum(this,"iacCache"),S.R.propNoWrite(this,"_grid","iacCache"),new.target===s&&Object.seal(this)}reset(){super.reset(),oe(this,t).fill(0)}write(e,t){this._grid[e]=Object.freeze(Object.assign({},this._grid[e],t))}moveEntity(e,s,r){oe(this,t)[s]=0,oe(this,t)[r]=1}forEach(e){for(let t=0;t<this.area;t++)e(this._grid[t],t)}forEachShuffled(e){const t=new Uint16Array(this.area);for(let e=0;e<this.area;e++)t[e]=e;t.sort((()=>Math.random()-.5));for(const s of t)e(this._grid[s],s)}getUntToward(e,t){const s=this.tileDestsFrom(t).filter((e=>!this.isOccupied(e.coord))).map((t=>{const s=this.iacCache[t.coord],r=this.iacCache[e];return{tile:t,iac:s,infNorm:ie.infNorm(this.dimensions,s,r),oneNorm:ie.oneNorm(this.dimensions,s,r)}}));if(0===s.length)return t;s.sort(((e,t)=>e.infNorm-t.infNorm)),s.length=3,s.sort(((e,t)=>e.oneNorm-t.oneNorm));const r=s[0];for(let e=1;e<s.length;e++)if(s[e].infNorm>r.infNorm){s.splice(e);break}if(1===s.length)return r.tile.coord;if(r.infNorm===r.oneNorm){if(ie.axialAlignment(this.dimensions,t,e)>.5)return r.tile.coord;s.shift()}return s[Math.floor(s.length*Math.random())].tile.coord}getUntAwayFrom(e,t){const s=this.iacCache[e];return this.iacCache[t].iSub(s).mod(this.dimensions).toCoord(this.dimensions)}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){const s=this.iacCache[e];return new ie(s.x+Math.trunc(2*t*(Math.random()-.5)),s.y+Math.trunc(2*t*(Math.random()-.5))).mod(this.dimensions).toCoord(this.dimensions)}dist(e,t){return ie.infNorm(this.dimensions,this.iacCache[e],this.iacCache[t])}isOccupied(e){return 0!==oe(this,t)[e]}tileAt(e){return this._grid[e]}tileDestsFrom(e,t=1){const s=this.iacCache[e];let r=!1,o=!1;const i=this.dimensions.width,a=this.dimensions.height;let n=s.y-t;n<0&&(n+=a,o=!0);let c=s.x-t;c<0&&(c+=i,r=!0);let h=s.y+t+1;h>a&&(h-=a,o=!0);let d=s.x+t+1;d>i&&(d-=i,r=!0);const l=[];if(r){const e=n*i;l.push(...this._grid.slice(e,e+d).freeze()),o&&l.push(...this._grid.slice(0,d).freeze())}const u=o?a:h,p=2*t+1;for(let e=n;e<u;e++){const t=e*i+c;l.push(...this._grid.slice(t,t+p).freeze())}if(r&&!o&&h!==a&&(l.length-=d),o){for(let e=0;e<h;e++){const t=e*i+c;l.push(...this._grid.slice(t,t+p).freeze())}r&&(l.length-=d)}return l.freeze()}tileSourcesTo(e,t=1){return this.tileDestsFrom(e,t)}static getArea(e){return e.height*e.width}static getLatticePatchDiameter(e){return Math.sqrt(e)}static getRandomCoord(e){const t=Math.floor(e.width*Math.random());return Math.floor(e.height*Math.random())*e.width+t}_assertSomeInvariants(){const e=this._grid.map(((e,t)=>({i:t,arr:this.getAllAltDestsThan(e.coord).map((e=>e.coord)).sort().freeze()}))).filter((e=>25!==e.arr.length)).freeze();if(e.length)throw console.error(e),new Error("never")}};let r=s;t=new WeakMap,r.ambiguityThreshold=24,r.sizeLimits=S.R.deepFreeze({height:{min:5,max:51},width:{min:5,max:51}}),e.Grid=r,r.prototype.tileSourcesTo=r.prototype.tileDestsFrom,S.R.protoNoEnum(r,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(r),Object.freeze(r.prototype)}(te||(te={})),Object.freeze(te);class ae{constructor(e){this.dash=e.dash,this.bash=e.bash,Object.freeze(this)}toCoord(){}round(){const e=Math.floor(this.dash),t=Math.floor(this.bash),s=e-this.dash,r=t-this.bash;return s>2*r?new ae({dash:e+1,bash:t}):s<.5*r?new ae({dash:e,bash:t+1}):Math.min(s,r)>.5?new ae({dash:e+1,bash:t+1}):new ae({dash:e,bash:t})}add(e){return new ae({dash:this.dash+e.dash,bash:this.bash+e.bash})}sub(e){return new ae({dash:this.dash-e.dash,bash:this.bash-e.bash})}mul(e){return new ae({dash:e*this.dash,bash:e*this.bash})}}Object.freeze(ae),Object.freeze(ae.prototype),function(e){const t=class extends J{constructor(e){super(e),this.grid=(void 0).freeze(),new.target===t&&Object.seal(this)}write(e,t){}moveEntity(e,t,s){}forEach(e){let t=0;for(const s of this.grid)for(const r of s)e(r,t++)}forEachShuffled(e){}getUntToward(e,t){}getUntAwayFrom(e,t){}getAllAltDestsThan(e){return this.tileDestsFrom(e,2)}getRandomCoordAround(e,t){}dist(e,t){}isOccupied(e){}tileAt(e){}tileDestsFrom(e,t=1){return[].freeze()}tileSourcesTo(e,t=1){}static getArea(e){const t=Math.min(e.fslash,e.bslash),s=Math.max(e.fslash,e.bslash),r=-1+e.dash+t;let o=2*t*(e.dash+r);return o+=(s-t-1)*r,o}static getLatticePatchDiameter(e){if(e<.25)throw new RangeError("determinant of a radical will be strictly negative.");return 1+(-3+Math.sqrt(9-12*(1-e)))/6*2}static getRandomCoord(e){return new ae(void 0).toCoord()}};let s=t;s.ambiguityThreshold=18,s.sizeLimits=S.R.deepFreeze({dash:{min:10,max:50},bslash:{min:10,max:50},fslash:{min:10,max:50}}),e.Grid=s,S.R.protoNoEnum(s,"tileAt","tileDestsFrom","tileSourcesTo"),Object.freeze(s),Object.freeze(s.prototype)}(se||(se={})),Object.freeze(se);var ne=(e,t,s)=>(((e,t,s)=>{if(!t.has(e))throw TypeError("Cannot read from private field")})(e,t),s?s.call(e):t.get(e));class ce extends q{constructor(e,t){super(e,t),this._nextMovementTimerMultiplier=void 0,this._scheduledMovementCallbackId=void 0}onGamePlaying(){this._delayedMovementContinue()}onGamePaused(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}onGameOver(){this.game.cancelTimeout(this._scheduledMovementCallbackId),this._scheduledMovementCallbackId=void 0}_movementContinue(){const e=this.computeDesiredDest();this._nextMovementTimerMultiplier=this.game.grid.tileAt(e).seq.length,this.makeMovementRequest(this.game.grid.getUntToward(e,this.coord),this.getNextMoveType()),this._delayedMovementContinue()}_delayedMovementContinue(){this._scheduledMovementCallbackId=this.game.setTimeout(this._movementContinue.bind(this),this.computeNextMovementTimer()*this._nextMovementTimerMultiplier)}}!function(e){var t;e._Constructors={CHASER:void 0},e.of=(t,s)=>{const r=s.familyId;return new e._Constructors[r](t,s)};class s extends e{constructor(){super(...arguments),t.set(this,{which:0,reuses:0,target:void 0})}reset(e){super.reset(e),ne(this,t).which=0,ne(this,t).reuses=0,ne(this,t).target=void 0}computeDesiredDest(){const e=ne(this,t);if(void 0!==e.target&&e.reuses<=N.K._ROBOT_PRIORITY_MAX_REUSES){const t=this._behaviours[e.which].call(this,e.target);if(void 0!==t)return e.reuses++,t.dest}e.reuses=0;for(let t=0;t<this._behaviours.length;t++){const s=this._behaviours[t].call(this);if(void 0!==s)return e.which=t,e.target=s.target,s.dest}throw new Error("never")}}t=new WeakMap,e.Decisive=s,Object.freeze(s),Object.freeze(s.prototype)}(ce||(ce={})),S.R.protoNoEnum(ce,"_movementContinue"),Object.seal(ce),Object.freeze(ce.prototype);var he=Object.defineProperty,de=Object.prototype.hasOwnProperty,le=Object.getOwnPropertySymbols,ue=Object.prototype.propertyIsEnumerable,pe=(e,t,s)=>t in e?he(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,fe=(e,t)=>{for(var s in t||(t={}))de.call(t,s)&&pe(e,s,t[s]);if(le)for(var s of le(t))ue.call(t,s)&&pe(e,s,t[s]);return e};class me extends ce.Decisive{constructor(e,t){super(e,t),this.pred=[],this.prey=[],this.params=Object.freeze(fe(fe({},me.Behaviour.DEFAULT),t.familyArgs)),this.grid=this.game.grid,Object.seal(this),S.R.propNoWrite(this,"params","grid")}_onTeamsBootstrapped(){super._onTeamsBootstrapped(),this.pred=this.game.teams.filter((e=>e.id!==this.teamId)).flatMap((e=>e.members)).seal(),this.prey=[...this.pred].seal(),S.R.propNoWrite(this,"pred","prey")}_bhvrEvadePred(e){if(void 0!==e)return{dest:this.grid.getUntAwayFrom(this.game.players[e].coord,this.coord)};this.pred.sort(((e,t)=>this.grid.dist(e.coord,this.coord)-this.grid.dist(t.coord,this.coord)));for(const e of this.pred){if(this.grid.dist(e.coord,this.coord)>this.params.fearDistance)break;if(!e.isDowned&&e.boosts>this.boosts)return{dest:this.grid.getUntAwayFrom(e.coord,this.coord),target:e.playerId}}}_bhvrChasePrey(e){if(void 0!==e)return{dest:this.game.players[e].coord};if(this.prey.sort(((e,t)=>this.grid.dist(this.coord,e.coord)-this.grid.dist(this.coord,t.coord))),this.isDowned)for(const e of this.prey){if(this.grid.dist(this.coord,e.coord)>this.params.bloodThirstDistance)break;if(e.boosts<this.boosts-this.params.healthReserve)return{dest:e.coord,target:e.playerId}}}_bhvrGotoHealthElseWander(e){if(Math.random()<this.params.wanderingAimlessness)return{dest:this.grid.getRandomCoordAround(this.coord,3)};{const e=this.grid.getUntAwayFrom.bind(this.grid,this.prevCoord);return{dest:this.grid.getRandomCoordAround(e(e(this.coord)),1)}}}getNextMoveType(){return q.MoveType.NORMAL}computeNextMovementTimer(){return 1e3/this.params.keyPressesPerSecond}}!function(e){let t;(t=e.Behaviour||(e.Behaviour={})).DEFAULT=Object.freeze({fearDistance:5,bloodThirstDistance:7,healthReserve:3,keyPressesPerSecond:2,wanderingAimlessness:.2})}(me||(me={})),me.prototype._behaviours=Object.freeze([me.prototype._bhvrEvadePred,me.prototype._bhvrChasePrey,me.prototype._bhvrGotoHealthElseWander]),S.R.protoNoEnum(me,"_onTeamsBootstrapped"),Object.freeze(me),Object.freeze(me.prototype);var ge,ye=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)};(()=>{Object.freeze(Object.assign(J._Constructors,{W_EUCLID2:te.Grid,BEEHIVE:se.Grid})),Object.freeze(J);{const e=ce;Object.freeze(Object.assign(e._Constructors,{CHASER:me})),Object.freeze(e)}})();class be extends ee{constructor(e){var t,s,r;super(e),this.lang=void 0,ge.set(this,void 0),this.scoreInfo=new H(this.players.map((e=>e.playerId))),S.R.propNoWrite(this,"scoreInfo"),t=this,s=ge,r=j.U.Import(e.desc.langId).then((t=>(this.lang=new t(e.desc.langWeightExaggeration),S.R.propNoWrite(this,"lang"),this.lang))),ye(t,s,"write to private field"),s.set(t,r)}async reset(){super.reset();const e=Object.freeze({playerCoords:[],csps:[]});var t,s;await(t=this,s=ge,ye(t,s,"read from private field"),s.get(t)),this.lang.reset(),this.grid.forEachShuffled(((t,s)=>{const r=this.dryRunShuffleLangCspAt(t.coord);this.grid.write(t.coord,r),e.csps[s]=r})),this.teams.forEach((e=>e.reset()));const r=this.grid.static.getSpawnCoords(this.teams.map((e=>e.members.length)),this.grid.dimensions);return this.teams.forEach(((t,s)=>{t.members.forEach(((t,o)=>{const i=r[s][o];t.reset(i),e.playerCoords[t.playerId]=i}))})),this.scoreInfo.reset(),e}dryRunShuffleLangCspAt(e){this.grid.write(e,{seq:""});const t=this.grid.getAllAltDestsThan(e).map((e=>e.seq)).freeze();return this.lang.getNonConflictingChar(t)}requestStateChange(e,t){const s=this.players[e.author];if(e.lastRejectId!==s.reqBuffer.lastRejectId)return;if(this.status!==N.Status.PLAYING||this.grid.isOccupied(e.moveDest))return void this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),author:e.author},t);const r=e.moveType===q.MoveType.BOOST,o=s.boosts+(r?-1:N.K.PORTION_OF_MOVES_THAT_ARE_BOOST);r&&o<0?this.commitStateChange({rejectId:s.reqBuffer.getNextRejectId(),author:e.author},t):(this.scoreInfo.entries[s.playerId].moveCounts[e.moveType]+=1,this.commitStateChange({author:e.author,moveType:e.moveType,players:{[s.playerId]:{boosts:o,coord:e.moveDest}},tiles:{[e.moveDest]:this.dryRunShuffleLangCspAt(e.moveDest)}},t))}}ge=new WeakMap,(be||(be={})).CHECK_VALID_CTOR_ARGS=function(e){const t=[],s=Object.freeze({coordSys:0,gridDimensions:0,langId:0,langWeightExaggeration:0,players:0}),r=[];for(const t in s){null==e[t]&&r.push(t)}r.length&&t.push("Missing the following arguments: "+r);const o=j.U.GetDesc(e.langId),i=J._Constructors[e.coordSys];return void 0===o?t.push(`No language with the ID \`${e.langId}\` exists.`):void 0===i?t.push(`No grid with the system ID \`${e.coordSys}\` exists.`):o.isolatedMinOpts<i.ambiguityThreshold&&t.push("The provided language does not have enough sequences\nto ensure that a shuffling operation will always succeed when\npaired with the provided grid system."),"number"!=typeof e.langWeightExaggeration?t.push(`Language Weight Exaggeration expected a number, but \`${e.langWeightExaggeration}\` is not a number.`):e.langWeightExaggeration=Math.max(0,parseFloat(e.langWeightExaggeration)),t},Object.freeze(be),Object.freeze(be.prototype);var Oe,ve,Ee=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},we=(e,t,s)=>(Ee(e,t,"read from private field"),s?s.call(e):t.get(e)),Ne=(e,t,s,r)=>(Ee(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);function Se(e){const[t,...s]=JSON.parse(e.data),r=e.target;switch(t){case E.IN_GAME:this.requestStateChange(s[0],r);break;case E.PAUSE:this.statusBecomePaused();break;case E.UNPAUSE:this.statusBecomePlaying();break;case E.RETURN_TO_LOBBY:if(r===this.groupHostSocket){this.statusBecomeOver();const e=JSON.stringify([E.RETURN_TO_LOBBY]);this.sockets.forEach((t=>{t!==r&&t.readyState===t.OPEN&&t.send(e)})),this._terminate()}else{const e=JSON.stringify([E.RETURN_TO_LOBBY,g(r)]);this.sockets.forEach((t=>{t!==r&&t.readyState===t.OPEN&&t.send(e)}))}}}class je extends be{constructor(e){super({impl:{gridClassLookup:J.getImplementation,OperatorPlayer:void 0,RobotPlayer:(e,t)=>ce.of(e,t),onGameBecomeOver:()=>{}},desc:(q.CtorArgs.finalize(e.gameDesc),e.gameDesc),operatorIds:[]}),Oe.set(this,void 0),ve.set(this,void 0),this.sockets=new Set(e.sockets),this.groupHostSocket=e.groupHostSocket,Ne(this,Oe,e.deleteExternalRefs),S.R.instNoEnum(this,"operators"),S.R.propNoWrite(this,"sockets","groupHostSocket"),Ne(this,ve,Se.bind(this)),Object.seal(this),this.sockets.forEach((e=>{e.addEventListener("message",we(this,ve)),e.addEventListener("close",(()=>{1===this.sockets.size&&this._terminate()}),{once:!0})})),this._greetGameSockets(e.gameDesc)}get currentOperator(){throw new Error("never")}_greetGameSockets(e){const t=e.players.filter((e=>"HUMAN"===e.familyId)).freeze();Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===E.RESET&&t()}),{once:!0})})))).freeze()).then((()=>this.reset())),this.sockets.forEach((s=>{const r=t.filter((e=>e.socket===s)).map((e=>e.playerId)).freeze(),o=JSON.stringify([v.CREATE_GAME,e,r]);s.readyState===s.OPEN&&s.send(o)}))}async reset(){Promise.all(Array.from(this.sockets,(e=>new Promise((t=>{e.addEventListener("message",(e=>{JSON.parse(e.data)[0]===E.UNPAUSE&&t()}),{once:!0})})))).freeze()).then((()=>{this.statusBecomePlaying()}));const e=await super.reset(),t=JSON.stringify([E.RESET,e]);return this.sockets.forEach((e=>{e.readyState===e.OPEN&&e.send(t)})),e}setCurrentOperator(e){}setTimeout(e,t,...s){return setTimeout(e,t,s).unref()}cancelTimeout(e){clearTimeout(e)}statusBecomePlaying(){super.statusBecomePlaying();const e=JSON.stringify([E.UNPAUSE]);this.sockets.forEach((t=>{t.readyState===t.OPEN&&t.send(e)}))}statusBecomePaused(){super.statusBecomePaused();const e=JSON.stringify([E.PAUSE]);this.sockets.forEach((t=>{t.readyState===t.OPEN&&t.send(e)}))}commitStateChange(e,t){if(super.commitStateChange(e,t),e.rejectId){const s=JSON.stringify([E.IN_GAME,e]);null==t||t.send(s)}else{const t=JSON.stringify([E.IN_GAME,e]);this.sockets.forEach((e=>{e.readyState===e.OPEN&&e.send(t)}))}}_terminate(){this.sockets.forEach((e=>{e.removeEventListener("message",we(this,ve))})),we(this,Oe).call(this)}}Oe=new WeakMap,ve=new WeakMap,S.R.protoNoEnum(je,"_greetGameSockets","setCurrentOperator","_terminate"),Object.freeze(je),Object.freeze(je.prototype);var Me,_e,Ie,ze,Ce,Ae=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},Te=(e,t,s)=>(Ae(e,t,"read from private field"),s?s.call(e):t.get(e)),Re=(e,t,s,r)=>(Ae(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s);const ke=class extends b{constructor(e){super(),Me.set(this,void 0),this.sockets=new Map,_e.set(this,void 0),Ie.set(this,void 0),ze.set(this,void 0),Ce.set(this,void 0),Object.defineProperty(this,"wssBroadcast",{value:e.wssBroadcast}),this.name=e.name,this.passphrase=e.passphrase,S.R.propNoWrite(this,"name","passphrase"),Re(this,Me,void 0),Re(this,Ie,e.deleteExternalRefs),Re(this,_e,setTimeout((()=>{0===this.sockets.size&&this.terminate()}),1e3*ke.DEFAULT_TTL).unref()),Re(this,ze,(e=>{const[t,...s]=JSON.parse(e.data);switch(t){case v.UserInfo.NAME:this._wsOnUserInfoChange(e.target,s[0]);break;case v.CREATE_GAME:e.target===this.groupHostSocket&&this._wsOnHostCreateGame(s[0])}})),Re(this,Ce,(e=>{if(e.target===this.groupHostSocket||1===this.sockets.size)return void this.terminate();this.sockets.delete(e.target);const t=JSON.stringify([v.UserInfo.NAME,{[g(e.target)]:null}]);this.sockets.forEach(((e,s)=>{s.readyState===s.OPEN&&s.send(t)}))}))}get isCurrentlyPlayingAGame(){return void 0!==Te(this,Me)}admitSocket(e,t){if(!this.sockets.has(e)){console.info(`socket connect (group):  ${g(e)}`),Te(this,Me);{const s=v.UserInfo.NAME;{const r=JSON.stringify([s,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>{t.readyState===t.OPEN&&t.send(r)}))}const r={};this.sockets.forEach(((e,t)=>{r[g(t)]=e})),e.send(JSON.stringify([s,r]))}0===this.sockets.size&&(clearTimeout(Te(this,_e)),Re(this,_e,void 0),this.groupHostSocket=e,this.wssBroadcast(O.Exist.NAME,{[this.name]:O.Exist.Status.IN_LOBBY})),e.addEventListener("close",Te(this,Ce)),e.addEventListener("message",Te(this,ze)),this.sockets.set(e,t)}}kickSocket(e){return!!this.sockets.delete(e)&&(e.removeEventListener("close",Te(this,Ce)),e.removeEventListener("message",Te(this,ze)),!0)}_wsOnUserInfoChange(e,t){if("string"!=typeof t.username||"number"!=typeof t.teamId||"string"!=typeof t.avatar)return void console.info(`bad format: username: \`${t.username}\`, teamId: \`${t.teamId}\`, avatar: \`${t.avatar}\`.`);this.sockets.set(e,t);const s=JSON.stringify([v.UserInfo.NAME,{[g(e)]:t}]);this.sockets.forEach(((e,t)=>{t.readyState===t.OPEN&&t.send(s)}))}_wsOnHostCreateGame(e){const t=this._createGameInstance(e);t.length?console.info(t):(this.wssBroadcast(O.Exist.NAME,{[this.name]:O.Exist.Status.IN_GAME}),console.info(`group ${this.name} new game`))}_createGameInstance(e){const t=[];return this.isCurrentlyPlayingAGame?(t.push("a game is already in session for this group"),t):(t.push(...be.CHECK_VALID_CTOR_ARGS(e)),t.length?t:(e.players=[...e.players,...Array.from(this.sockets.keys(),(e=>{const t=this.sockets.get(e);return Object.freeze({socket:e,familyId:"HUMAN",username:t.username,teamId:t.teamId,avatar:t.avatar})}))].freeze(),Re(this,Me,new je({sockets:this.sockets.keys(),groupHostSocket:this.groupHostSocket,deleteExternalRefs:()=>{Re(this,Me,void 0)},gameDesc:e})),[]))}terminate(){for(const e of this.sockets.keys())e.removeEventListener("close",Te(this,Ce)),e.removeEventListener("message",Te(this,ze));void 0!==Te(this,Me)&&Re(this,Me,void 0),Te(this,Ie).call(this),this.wssBroadcast(O.Exist.NAME,{[this.name]:O.Exist.Status.DELETE}),console.info(`terminated group: \`${this.name}\``)}};let xe=ke;Me=new WeakMap,_e=new WeakMap,Ie=new WeakMap,ze=new WeakMap,Ce=new WeakMap,S.R.protoNoEnum(xe,"_wsOnUserInfoChange","_wsOnHostCreateGame"),Object.freeze(xe),Object.freeze(xe.prototype);const Pe=new Map;function De(e){Pe.delete(e)}function We(e,t){const s=JSON.stringify([e,t]);Fe.clients.forEach((e=>{e.readyState===e.OPEN&&e.send(s)}))}function Ge(e){const[t,...s]=JSON.parse(e.data);switch(t){case O.Create.NAME:{let t=function(t){e.target.send(JSON.stringify([O.Create.NAME,t]))};const r=s[0];if(!function(e){return void 0!==e.groupName&&e.groupName.length<=xe.Name.MaxLength&&xe.Name.REGEXP.test(e.groupName)&&e.passphrase.length<=xe.Passphrase.MaxLength&&xe.Passphrase.REGEXP.test(e.passphrase)}(r)||Pe.has(r.groupName))return void t(!1);Pe.set(r.groupName,new xe(Object.freeze({wssBroadcast:We,name:r.groupName,passphrase:r.passphrase,deleteExternalRefs:De.bind(null,r.groupName)}))),t(!0);break}case O.TryJoin.NAME:{let t=function(t){e.target.send(JSON.stringify([O.TryJoin.NAME,t]))};const r=s[0],o=Pe.get(r.groupName);if(void 0===o||r.passphrase!==o.passphrase)return void t(!1);const i=r.userInfo;if(void 0===i||0!==i.teamId)throw new Error(`a socket attempted to connect to group \`${o.name}\` without providing userInfo.`);for(const t of Pe.values())if(t.kickSocket(e.target))break;o.admitSocket(e.target,i),t(!0);break}}}const Ue=r().resolve(__dirname,"../client"),Le=(new(l())).use(p()(Ue,{brotli:!0,format:!1,setHeaders:(e,t,s)=>{e.removeHeader("x-powered-by"),e.setHeader("X-Content-Type-Options","nosniff")},maxAge:0,immutable:!1})),Be=h().createServer({},Le.callback()),Fe=new(m().Server)({server:Be});Fe.on("connection",(function(e,t){const s=JSON.stringify([O.Exist.NAME,(()=>{const e={};for(const[t,s]of Pe)e[t]=s.isCurrentlyPlayingAGame?O.Exist.Status.IN_GAME:O.Exist.Status.IN_LOBBY;return e})()]);var r,o;r=e,o=`${Date.now().toString()}_${100*Math.random()%100}`,y.set(r,o),console.info(`socket connect (server): ${g(e)}`),e.send(s),e.addEventListener("message",Ge)})),Be.listen({port:8080,host:"0.0.0.0"},(function(){const e=Be.address();console.info(`\n\nServer mounted to: \`${e.address}:${e.port}\` using ${e.family}.\nThis host can be reached at any of the following addresses:\n`),qe().sort().forEach((t=>{console.info(`${t}:${e.port}`)})),console.info("")}));const qe=()=>Object.values(n().networkInterfaces()).flat().filter((e=>!e.internal)).map((e=>"IPv6"===e.family?`[${e.address}]`:e.address))})(),capswalk=a})();
//# sourceMappingURL=index.js.map